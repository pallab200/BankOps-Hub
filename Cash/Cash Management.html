<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Management</title>
    <!-- Offline mode: removed external CDN and Google Fonts links. -->
    <!-- If you want full Tailwind utility classes offline, place a copy of Tailwind CSS at: css/tailwind.min.css -->
    <link rel="stylesheet" href="css/tailwind.min.css">
    <link rel="stylesheet" href="../css/fontawesome.min.css">
    <link rel="stylesheet" href="../css/fontawesome-fix.css">
    <!-- Using system font stack to avoid external Google Fonts; optionally add local Inter font files and @font-face rules if desired -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
                const menuIcon = document.querySelector('#menuIcon');
                const sidebar = document.querySelector('#sidebar');
                const overlay = document.querySelector('.sidebar-overlay');
                const mainContent = document.querySelector('#main-content');
            
            // Function to handle sidebar toggle with smooth animations
            function toggleSidebar(shouldOpen) {
                if (shouldOpen) {
                    // Show sidebar and slide content
                        sidebar.style.display = 'block';
                    requestAnimationFrame(() => {
                        sidebar.classList.remove('hidden');
                        requestAnimationFrame(() => {
                            sidebar.classList.remove('closed');
                            overlay.classList.add('active');
                            menuIcon.classList.add('menu-icon-active');
                            // Add class that triggers content-area transform
                            mainContent.classList.add('sidebar-open');
                        });
                    });
                } else {
                    // Close sidebar and restore content
                    sidebar.classList.add('closed');
                    overlay.classList.remove('active');
                    menuIcon.classList.remove('menu-icon-active');
                    // Remove the class immediately so content returns
                    mainContent.classList.remove('sidebar-open');
                    
                    sidebar.addEventListener('transitionend', function handler() {
                        sidebar.classList.add('hidden');
                        sidebar.style.display = 'none';
                        sidebar.removeEventListener('transitionend', handler);
                    }, { once: true });
                }
            }
                    // Close sidebar when a menu item is selected on small screens
                    const sidebarButtons = document.querySelectorAll('.sidebar-button');
                    sidebarButtons.forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            const sidebar = document.getElementById('sidebar');
                            if (!sidebar) return;
                            // If running on narrow screens and the sidebar is visible, close it
                            if (window.innerWidth < 768 && !sidebar.classList.contains('hidden')) {
                                toggleSidebar();
                            }
                        });
                    });

            // Initialize sidebar state
            if (sidebar.classList.contains('closed')) {
                sidebar.style.display = 'none';
            }
            
            // Event listener for menu icon
            menuIcon.addEventListener('click', () => {
                const isOpen = !sidebar.classList.contains('closed');
                toggleSidebar(!isOpen);
            });
            
            // Event listener for overlay
            overlay.addEventListener('click', () => toggleSidebar(false));
        });
    </script>
    <style>
        /* Modern Unified Design System */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --accent: #ec4899;
            --bg-primary: #f0f4f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
        }

        body {
            font-family: 'Poppins', 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #f8fafc 100%);
            color: var(--text-primary);
        }
        
        #main-content {
            margin-left: 0;
            padding-left: 60px;
        }

        input[type="text"], input[type="number"], input[type="email"], input[type="tel"],
        textarea, select {
            background: transparent !important;
            background-color: transparent !important;
            box-shadow: none !important;
        }

        input[type="text"]:focus, input[type="number"]:focus, textarea:focus, select:focus {
            background: transparent !important;
            background-color: transparent !important;
            outline: none !important;
            box-shadow: none !important;
        }

        /* Specific rule for inputs inside report table cells */
        .report-table-cell input, .report-table-cell textarea {
            background: transparent !important;
            background-color: transparent !important;
            box-shadow: none !important;
            padding: 0.25rem !important;
        }

        /* Center all text inside the main itemized bill table */
        #mainBillList table th, #mainBillList table td {
            text-align: center !important;
            vertical-align: middle !important;
        }
        /* Ensure inputs inside the bill table display centered text */
        #mainBillList table .report-table-cell input {
            text-align: center !important;
        }

        /* Remove padding from table cells and inputs in the bill list for compact layout */
        /* Visual style to match the example: bordered compact cells with centered numbers */
        #mainBillList table { border-collapse: collapse !important; font-size: 14px; }
        #mainBillList table th, #mainBillList table td {
            padding: 4px 8px !important;
            border: 1px solid #000 !important;
            box-sizing: border-box !important;
            vertical-align: middle !important;
        }
        /* Inputs fill the cell and appear like plain centered text */
        #mainBillList .report-table-cell input, #mainBillList .report-table-cell textarea {
            width: 100% !important;
            height: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            text-align: center !important;
            font-size: inherit !important;
            font-weight: 600 !important;
        }
        /* Bill number should use a monospaced look for alignment */
        #mainBillList .font-mono, #mainBillList td.font-mono { font-family: 'Courier New', Courier, monospace !important; font-weight: 600 !important; }

        /* Stronger rule: remove all backgrounds and background images from inputs inside the bill area
           (covers utility classes like bg-white and focus states in Tailwind) */
        #mainBillList input, #mainBillList textarea, #mainBillList select,
        #mainBillList .report-table-cell input, #mainBillList .report-table-cell textarea {
            background: transparent !important;
            background-color: transparent !important;
            background-image: none !important;
            box-shadow: none !important;
            -webkit-appearance: none !important;
            appearance: none !important;
        }
        /* Also override any bg-* utility class inside the bill area */
        #mainBillList .bg-white, #mainBillList .bg-gray-50, #mainBillList .bg-yellow-50 {
            background: transparent !important;
            background-color: transparent !important;
        }
        /* Ensure focus doesn't restore a background */
        #mainBillList input:focus, #mainBillList textarea:focus, #mainBillList select:focus {
            background: transparent !important;
            background-color: transparent !important;
            box-shadow: none !important;
            outline: none !important;
        }

        /* Helper: elements shown only in print */
        .print-only { display: none !important; }

        /* The actual page content area that will slide */
        #content-area {
            transition: transform 0.28s ease;
        }

        /* Remove any decorative box-shadows in the report area */
        #mainBillList, #mainBillList .border, #mainBillList .shadow-md, #mainTotalsGrid, .report-grid, .report-wrap {
            box-shadow: none !important;
        }
        /* Also ensure inputs don't render shadows on screen */
        #mainBillList input, #mainBillList textarea {
            box-shadow: none !important;
        }

        /* (Print uses same table as screen) */

        /* When main container has sidebar-open, slide the content-area to the right */
        #main-content.sidebar-open #content-area {
            transform: translateX(250px);
        }
        
        /* Professional Header Styles */
        .app-header-pro {
            position: relative;
        }
        
        .app-header-pro::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #6366f1, #ec4899, #818cf8);
            background-size: 200% 100%;
            animation: shimmerGradient 3s ease infinite;
        }
        
        @keyframes shimmerGradient {
            0%, 100% { background-position: 0% 0%; }
            50% { background-position: 100% 0%; }
        }
        
        /* Hamburger Menu Styles */
        .hamburger-menu {
            cursor: pointer;
            padding: 8px;
            display: flex;
            flex-direction: column;
        }
        
        .hamburger-menu.active .line-2 {
            opacity: 0;
        }
        
        .hamburger-menu.active .line-3 {
            transform: translateY(-9px) rotate(-45deg);
        }

        /* --- MODERN SIDEBAR STYLES --- */
        .sidebar {
            background: linear-gradient(180deg, #1a1d2e 0%, #0f111a 100%);
            position: fixed;
            top: 55px;
            left: 0;
            height: calc(100vh - 55px);
            width: 260px;
            transition: all 0.3s ease;
            transform: translateX(0);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.15);
            z-index: 40;
            visibility: visible;
            opacity: 1;
            display: block;
            border-right: 1px solid rgba(99, 102, 241, 0.1);
        }
        
        .sidebar.closed {
            transform: translateX(-100%);
        }
        
        .sidebar.hidden {
            visibility: hidden;
            opacity: 0;
            display: none;
        }
        
        /* Overlay for sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 55px;
            left: 0;
            width: 100%;
            height: calc(100% - 55px);
            background-color: rgba(0, 0, 0, 0.5);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                        visibility 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(4px);
            z-index: 30;
        }
        
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        /* Theme variables for brighter color palette */
        :root {
            --accent-green-600: #059669;
            --accent-green-400: #34d399;
            --accent-red-600: #dc2626;
            --accent-red-400: #f87171;
            --muted-gray-700: #374151;
            --muted-gray-300: #d1d5db;
            --card-bg: rgba(255,255,255,0.04);
            --glass: rgba(255,255,255,0.06);
            --accent-indigo: #6366f1;
            --accent-yellow: #f59e0b;
        }

        /* Make the newest recent transaction more prominent in the sidebar */
        .recent-transaction-first {
            padding: 0.12rem 0.3rem;
            border-radius: 2px;
            background: linear-gradient(180deg, rgba(99,102,241,0.06), rgba(99,102,241,0.03));
            margin-bottom: 0; /* no gap */
            box-shadow: none; /* remove shadow for tighter list */
            border: 1px solid rgba(99,102,241,0.04);
            font-size: 0.86rem;
        }

        .recent-transaction-item {
            cursor: pointer;
            padding: 0.08rem 0.3rem; /* minimal padding */
            border-radius: 0px;
            transition: transform 140ms cubic-bezier(0.2,0,0.2,1), background-color 120ms ease;
            will-change: transform;
            font-size: 0.82rem;
            line-height: 1.02;
            margin: 0; /* ensure no gap between items */
        }

        .recent-transaction-item:hover {
            transform: translateY(-1px);
            background-color: rgba(255,255,255,0.02);
        }

        .recent-transaction-details {
            padding: 0.08rem 0.3rem; /* minimal padding */
            border-left: 2px solid rgba(255,255,255,0.03);
            margin-bottom: 0; /* no gap */
            color: var(--muted-gray-300);
            overflow: hidden;
            max-height: 0; /* collapsed */
            opacity: 0;
            transform: translateY(-2px);
            transition: max-height 180ms cubic-bezier(0.2, 0, 0, 1), opacity 150ms ease, transform 150ms ease;
            background: transparent; /* remove extra card feel */
            border-radius: 0px;
            font-size: 0.78rem;
            line-height: 1.02;
        }

        /* Expanded state - animate open */
        .recent-transaction-details.expanded {
            max-height: 520px; /* large enough for details content */
            opacity: 1;
            transform: translateY(0);
        }

        /* Match details color to the transaction type (received = green, payment = red) */
        .recent-received + .recent-transaction-details {
            color: var(--accent-green-600);
            border-left-color: rgba(16,185,129,0.65);
            background: linear-gradient(180deg, rgba(16,185,129,0.04), rgba(16,185,129,0.02));
        }
        .recent-payment + .recent-transaction-details {
            color: var(--accent-red-600);
            border-left-color: rgba(220,38,38,0.5);
            background: linear-gradient(180deg, rgba(239,68,68,0.03), rgba(239,68,68,0.01));
        }

        /* subtle entrance animation for cards */
        @keyframes floatIn {
            from { opacity: 0; transform: translateY(6px) scale(0.995); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
    .recent-transaction-item, .recent-transaction-details { animation: floatIn 220ms ease both; }

        /* Buttons: Received / Payment / Reset styles and click animation */
        .btn-received {
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg,var(--accent-green-400),var(--accent-green-600)); /* green */
            color: white;
            box-shadow: 0 10px 24px rgba(16,185,129,0.12);
            border: 1px solid rgba(16,185,129,0.18);
            animation: floatSlow 3.6s ease-in-out infinite;
        }
        .btn-received::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.08) 45%, rgba(255,255,255,0.0) 80%);
            transform: translateX(-110%);
            transition: transform 0.5s ease;
            pointer-events: none;
        }
        .btn-received:hover::after {
            transform: translateX(120%);
        }
        .btn-payment {
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg,var(--accent-red-400),var(--accent-red-600)); /* red */
            color: white;
            box-shadow: 0 10px 24px rgba(239,68,68,0.12);
            border: 1px solid rgba(239,68,68,0.14);
            animation: floatSlow 3.6s ease-in-out infinite;
        }
        .btn-payment::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.08) 45%, rgba(255,255,255,0.0) 80%);
            transform: translateX(-110%);
            transition: transform 0.5s ease;
            pointer-events: none;
        }
        .btn-payment:hover::after {
            transform: translateX(120%);
        }
        .btn-reset {
            position: relative;
            overflow: hidden;
            background: linear-gradient(180deg,#9ca3af,#6b7280); /* warm gray */
            color: white;
            box-shadow: 0 8px 20px rgba(55,65,81,0.08);
            border: 1px solid rgba(99,102,241,0.06);
            animation: floatSlow 3.6s ease-in-out infinite;
        }
        .btn-reset::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(255,255,255,0.0) 0%, rgba(255,255,255,0.08) 45%, rgba(255,255,255,0.0) 80%);
            transform: translateX(-110%);
            transition: transform 0.5s ease;
            pointer-events: none;
        }
        .btn-reset:hover::after {
            transform: translateX(120%);
        }

        .btn-animate {
            transition: transform 180ms cubic-bezier(0.2,0,0.2,1), box-shadow 180ms ease, filter 180ms ease;
            will-change: transform;
        }
        .btn-pressed {
            transform: translateY(1px) scale(0.985);
            box-shadow: 0 3px 8px rgba(0,0,0,0.12) !important;
        }

        .btn-received:hover, .btn-payment:hover, .btn-reset:hover {
            transform: translateY(-3px) scale(1.02);
            filter: saturate(1.06) contrast(1.02);
        }
        .btn-received:active, .btn-payment:active, .btn-reset:active { transform: translateY(0) scale(0.99); }
        
        @keyframes floatSlow {
            0% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0); }
        }
        /* Chevron for recent transaction rows */
        .recent-chevron {
            color: rgba(55, 65, 81, 0.75); /* gray-700 */
            transform-origin: center;
            transition: transform 260ms cubic-bezier(0.2,0,0.2,1);
        }
        .recent-chevron.chev-rotated {
            transform: rotate(-180deg);
        }
        
        /* Modern Button Base */
        .sidebar-button {
            background: linear-gradient(135deg, rgba(99,102,241,0.15) 0%, rgba(99,102,241,0.08) 100%);
            color: #ffffff;
            padding: 0.85rem 1rem;
            border-radius: 12px;
            width: 100%;
            text-align: left;
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            border: 1px solid rgba(99,102,241,0.2);
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.25s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .sidebar-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s ease;
        }
        
        .sidebar-button:hover::before {
            left: 100%;
        }

        /* Light stagger for sidebar list to feel lively */
        #recent-transactions-list .recent-transaction-item:nth-child(2) { animation-delay: 45ms; }
        #recent-transactions-list .recent-transaction-item:nth-child(4) { animation-delay: 90ms; }

        /* Received / Payment panel accents and value animation */
        .panel-accent-received {
            border-left: 6px solid rgba(16,185,129,0.9);
            background: linear-gradient(180deg, rgba(16,185,129,0.06), rgba(16,185,129,0.02));
            box-shadow: 0 10px 28px rgba(16,185,129,0.06);
            padding-left: 0.75rem; /* leave room for left accent */
        }
        .panel-accent-payment {
            border-left: 6px solid rgba(239,68,68,0.9);
            background: linear-gradient(180deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02));
            box-shadow: 0 10px 28px rgba(239,68,68,0.06);
            padding-left: 0.75rem; /* leave room for left accent */
        }

        /* Stronger header and total colors for the panels */
        .panel-accent-received h3 { color: var(--accent-green-600); }
        .panel-accent-payment h3 { color: var(--accent-red-600); }
        .panel-accent-received #totalReceived { color: var(--accent-green-600); font-weight: 700; }
        .panel-accent-payment #totalPayment { color: var(--accent-red-600); font-weight: 700; }

        /* Value flash when totals update (base) */
        @keyframes valueFlash {
            0% { transform: scale(1); opacity: 1; }
            35% { transform: scale(1.12); opacity: 1; }
            65% { transform: scale(0.98); opacity: 0.95; }
            100% { transform: scale(1); opacity: 1; }
        }
        .value-flash {
            animation: valueFlash 420ms cubic-bezier(0.2,0,0,1);
        }

        /* Panel-specific color pulses */
        @keyframes valueFlashReceivedColor {
            0% { color: var(--accent-green-600); filter: drop-shadow(0 0 0 rgba(16,185,129,0)); }
            40% { color: #ffffff; text-shadow: 0 2px 8px rgba(16,185,129,0.45); }
            100% { color: var(--accent-green-600); text-shadow: none; }
        }
        @keyframes valueFlashPaymentColor {
            0% { color: var(--accent-red-600); filter: drop-shadow(0 0 0 rgba(239,68,68,0)); }
            40% { color: #ffffff; text-shadow: 0 2px 8px rgba(239,68,68,0.45); }
            100% { color: var(--accent-red-600); text-shadow: none; }
        }
        .value-flash-received { animation-name: valueFlash, valueFlashReceivedColor; animation-duration: 420ms, 420ms; animation-timing-function: cubic-bezier(0.2,0,0,1), ease; }
        .value-flash-payment { animation-name: valueFlash, valueFlashPaymentColor; animation-duration: 420ms, 420ms; animation-timing-function: cubic-bezier(0.2,0,0,1), ease; }

        /* Respect reduced motion preferences */
        @media (prefers-reduced-motion: reduce) {
            .recent-transaction-item, .recent-transaction-details, .value-flash { animation: none !important; transition: none !important; }
        }
        #recent-transactions-list .recent-transaction-details:nth-child(3) { animation-delay: 60ms; }
        .sidebar-button:hover {
            background: linear-gradient(135deg, rgba(99,102,241,0.25) 0%, rgba(99,102,241,0.15) 100%);
            transform: translateX(4px);
            box-shadow: 0 6px 20px rgba(99,102,241,0.2);
            border-color: rgba(99,102,241,0.3);
        }
        .sidebar-button:focus {
            outline: none;
            background: linear-gradient(135deg, rgba(99,102,241,0.25) 0%, rgba(99,102,241,0.15) 100%);
            box-shadow: 0 0 0 3px rgba(99,102,241,0.3);
        }
        
        /* Navigation Title */
        .sidebar h2 {
            color: #ffffff;
            font-size: 1.15rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            margin-top: 0.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(99,102,241,0.3);
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        /* --- HAMBURGER MENU ANIMATION --- */
        /* Hamburger Icon Container */
        .menu-icon-container {
            width: 30px;
            height: 30px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
        }

        /* The lines */
        .menu-icon-line {
            height: 3px;
            width: 100%;
            background-color: #1a1b1e; /* Dark line color */
            border-radius: 2px;
            transition: all 0.3s ease;
            transform-origin: center;
        }
        
        .menu-icon-active .line-top {
            transform: translateY(12px) rotate(45deg);
        }
        
        .menu-icon-active .line-middle {
            opacity: 0;
        }
        
        .menu-icon-active .line-bottom {
            transform: translateY(-12px) rotate(-45deg);
        }

        /* General App Styles */
        .main-button {
            position: relative;
            overflow: hidden;
            background: linear-gradient(135deg, var(--primary, #6366f1), var(--primary-dark, #4f46e5));
            color: #fff;
            font-weight: 700;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 30px rgba(99,102,241,0.18);
            border: none;
            transition: all 0.25s ease;
            animation: floatButton 3.6s ease-in-out infinite;
        }
        .main-button::after { content: ''; position:absolute; inset:0; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.12) 50%, rgba(255,255,255,0) 100%); transform:translateX(-120%); transition: transform .6s ease; pointer-events:none }
        .main-button:hover::after { transform:translateX(120%); }
        .main-button:hover { transform: translateY(-4px); box-shadow: 0 15px 40px rgba(99,102,241,0.25); }
        .input-field {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.5rem;
            text-align: right;
        }
        .label {
            font-weight: 500;
            color: #374151;
        }
        .section-box {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            padding: 1.25rem;
            border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06), inset 0 1px 0 rgba(255,255,255,0.8);
            border: 1px solid rgba(99,102,241,0.08);
            transition: all 0.3s ease;
        }
        
        .section-box:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.08);
            transform: translateY(-2px);
        }

        /* Ensure panel accents override the default section-box visuals */
        .section-box.panel-accent-received {
            background: linear-gradient(135deg, rgba(16,185,129,0.04) 0%, #ffffff 100%);
            border-left: 4px solid #10b981;
            padding-left: 1.25rem;
            box-shadow: 0 4px 16px rgba(16,185,129,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        
        .section-box.panel-accent-received h3 {
            color: #059669;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-box.panel-accent-received h3::before {
            content: '↓';
            display: inline-block;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #10b981, #059669);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }
        
        .section-box.panel-accent-payment {
            background: linear-gradient(135deg, rgba(239,68,68,0.04) 0%, #ffffff 100%);
            border-left: 4px solid #ef4444;
            padding-left: 1.25rem;
            box-shadow: 0 4px 16px rgba(239,68,68,0.12), inset 0 1px 0 rgba(255,255,255,0.8);
        }
        
        .section-box.panel-accent-payment h3 {
            color: #dc2626;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-box.panel-accent-payment h3::before {
            content: '↑';
            display: inline-block;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        /* Subtle lift/pulse for panels when totals change */
        @keyframes panelPulse {
            0% { transform: translateY(0); box-shadow: none; }
            30% { transform: translateY(-6px); box-shadow: 0 12px 30px rgba(0,0,0,0.08); }
            100% { transform: translateY(0); box-shadow: none; }
        }
        .panel-pulse { animation: panelPulse 520ms cubic-bezier(0.2,0,0,1); }

        /* ATM Replenishment Specific Styles */
        .table-bordered, .table-bordered th, .table-bordered td {
            border: 1px solid black;
        }
        .form-container {
             background-color: white;
             padding: 2rem;
             border-radius: 0.5rem;
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Hide number input arrows */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }
        
        /* Print Styles */
        @media print {
            @page {
                size: A4;
                /* Reduced margins to fit content - smaller top margin to reduce upper gap */
                margin: 0.1cm 0.3cm 0.3cm 0.4cm; 
            }
            body {
                 background-color: white;
                 margin: 0 !important; /* ensure no default body margin */
            }
            .no-print {
                display: none;
            }

            /* Show elements with .print-only only when printing */
            .print-only { display: block !important; }
            /* Remove input boxes/borders for report inputs (VAT/Amount) when printing */
            #mainBillList input, #reportContainer input, #pagedReportView input, .report-table-cell input {
                border: none !important;
                background: transparent !important;
                background-color: transparent !important;
                box-shadow: none !important;
                -webkit-appearance: none !important;
                appearance: none !important;
                padding: 0 !important;
                width: auto !important;
                color: #111 !important;
            }
            /* Make extra-sure: remove any outline/border on all input types when printing */
            #mainBillList input[type], #mainBillList input[type="text"], #mainBillList input[type="number"],
            #mainBillList input, #reportContainer input, input[type="number"], input[type="text"], input {
                border: none !important;
                outline: none !important;
                box-shadow: none !important;
                background: transparent !important;
                background-color: transparent !important;
                -webkit-appearance: none !important;
                appearance: none !important;
            }
            /* Ensure focused inputs also show no border in print */
            #mainBillList input:focus, #reportContainer input:focus, input:focus {
                border: none !important;
                outline: none !important;
                box-shadow: none !important;
            }
            /* Also remove any box-shadow on containers when printing to ensure a flat look */
            #mainBillList, #mainBillList .border, #mainBillList .shadow-md, #mainTotalsGrid, .report-grid, .report-wrap {
                box-shadow: none !important;
            }
            
            /* Hide non-essential elements in print */
            #cash-calculator-page, #cash-receive-page, #vault-page, .sidebar, #cash-flow-page, #atm-input-page {
                display: none !important;
            }
            
            /* Header print styles */
            header {
                position: static !important;
                box-shadow: none !important;
                border-bottom: 2px solid #333 !important;
                margin-bottom: 8px !important; /* smaller gap under header */
                padding: 8px 12px !important; /* reduced header padding */
            }
            
            header h1 {
                font-size: 24px !important;
                color: #333 !important;
                margin: 0 !important;
            }
            
            header .text-xs {
                font-size: 12px !important;
            }
            
            #sidebarToggle, .menu-icon-container {
                display: none !important;
            }
            
            /* Show only the specific output container being printed */
            #atm-output-page, #cash-calculator-print-output {
                display: block !important;
                visibility: visible;
                position: static; /* Ensure it stays in the normal flow for printing */
                padding: 0;
            }

            /* ATM specific print styles for size and layout */
             #atm-output-page * { 
                 visibility: visible;
                 position: static;
                 font-size: 9.5pt !important; /* base font reduced by 1pt */
                 line-height: 1.18;
                 box-sizing: border-box;
            }
             #atm-output-page .text-2xl { font-size: 19pt !important; }
             #atm-output-page .text-lg { font-size: 11pt !important; }
             #atm-output-page .mb-6 { margin-bottom: 0.5rem !important; }
             #atm-output-page .mb-4 { margin-bottom: 0.3rem !important; }
             #atm-output-page .mt-2 { margin-top: 0.2rem !important; }
             #atm-output-page .p-1 { padding: 0.1rem !important; }
             #atm-output-page .py-1 { padding-top: 0.1rem !important; padding-bottom: 0.1rem !important;}
             #atm-output-page .px-2 { padding-left: 0.2rem !important; padding-right: 0.2rem !important;}
             #atm-output-page .mt-16 { margin-top: 0.8rem !important; }
             #atm-output-page .mt-8 { margin-top: 0.4rem !important; }
             #atm-output-page .gap-4 { gap: 0.3rem !important; }
             
             #atm-output-page .table-bordered td, #atm-output-page .table-bordered th {
                padding: 1px 3px; /* Minimal padding */
             }

                /* Compact ATM info block for print: reduce font, padding and box sizes */
                #atm-output-page .atm-info-table { font-size: 7pt !important; line-height: 1.05 !important; }
                #atm-output-page .atm-info-table td { padding: 1px 4px !important; }
                #atm-output-page .atm-info-table td.border { vertical-align: middle !important; }
                /* Shrink signature boxes for compact print */
                #atm-output-page .cust-sign-box { height: 28px !important; width: 140px !important; padding: 2px !important; }
             
             /* Force tight columns for cash status table */
             #atm-output-page table.table-fixed {
                width: 100% !important;
                table-layout: fixed !important;
             }
             #atm-output-page table.table-fixed col {
                width: 12% !important; /* Redistribute width for all 8 columns */
             }
             #atm-output-page table.table-fixed col:nth-child(1) {
                width: 15% !important; /* Particular column needs a bit more space */
             }

            /* PDF sample alignment tweaks */
            #atm-output-page { 
                font-family: 'Times New Roman', Times, serif !important;
                font-size: 11pt !important; /* reduced by 1pt */
                margin-top: 0 !important; /* remove any top gap */
                padding-top: 0 !important;
            }

            /* Custom grid for ATM export: left narrow info, right stacked procedures */
            #atm-output-page .atm-export-grid { display: grid !important; grid-template-columns: 30% 70% !important; gap: 0.2rem !important; align-items: start; }
            #atm-output-page .atm-export-grid .col-span-1 { padding-right: 0.2rem !important; }
            /* Align right column procedures to the right and set compact width */
            #atm-output-page .atm-export-grid .space-y-2 { justify-self: end !important; }
            #atm-output-page .atm-export-grid .space-y-2 table { width: 280px !important; }
            #atm-output-page .table-bordered, #atm-output-page .table-bordered th, #atm-output-page .table-bordered td { border: 1px solid #000 !important; border-collapse: collapse !important; }
            #atm-output-page .table-bordered td, #atm-output-page .table-bordered th { page-break-inside: avoid; break-inside: avoid; }
            #atm-output-page .table-bordered td:last-child, #atm-output-page .table-bordered th:last-child { text-align: right !important; }

             
            
             /* Cash Calculator Print styles */
             #cash-calculator-print-output .printable-section {
                 margin-bottom: 12pt;
                 padding: 8pt;
                 border: 1px solid #ccc;
                 border-radius: 4pt;
             }
             #cash-calculator-print-output .text-xl { font-size: 14pt; }
             #cash-calculator-print-output .text-lg { font-size: 11pt; }
             #cash-calculator-print-output .text-2xl { font-size: 16pt; }
        }

        /* --- Cash Receive & Vault Shared Styles --- */
        .cash-receive-container, .vault-container {
            max-width: 750px; 
            border: 1px solid #ccc;
            background-color: #fff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            min-height: 500px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
        }

        .cash-receive-header-row {
            display: flex;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            text-align: center;
        }

        .cash-receive-header-row .header-cell {
            padding: 5px;
            flex-basis: 30%; 
            box-sizing: border-box;
        }
        
        .cash-receive-header-row .header-cell:nth-child(1) {
            flex-basis: 10%; 
            flex-shrink: 0;
        }
        
        .cash-receive-denomination-row {
            display: flex;
            margin-bottom: 2px;
            align-items: center;
        }

        .cash-receive-denomination-row input, .cash-receive-denomination-row .input-like-label {
            border: 1px solid #999;
            padding: 5px;
            text-align: right;
            font-size: 14px;
            height: 30px;
            box-sizing: border-box;
            margin-right: 5px;
            flex-basis: 30%; 
            display: flex;
            align-items: center;
            justify-content: flex-end;
            background-color: white;
        }
        
        .cash-receive-denomination-row .input-like-label {
            background-color: #ddd; 
        }

        .cash-receive-denomination-value {
            flex-basis: 10%; 
            flex-shrink: 0;
            text-align: right;
            padding: 5px;
            font-weight: bold;
            color: #333;
        }

        .cash-receive-total-row {
            margin-top: 10px;
            border-top: 2px solid #333;
            padding-top: 5px;
            margin-bottom: 15px;
        }
        .cash-receive-total-row .cash-receive-denomination-value {
            font-weight: bolder;
        }
        .cash-receive-total-row .input-like-label {
            background-color: #cceeff; 
            font-weight: bold;
            color: #0056b3;
        }

        .cash-receive-separator {
            border: 0;
            height: 1px;
            background-color: #ccc;
            margin: 20px 0;
        }

        .summary-difference-container {
            display: flex; 
            align-items: center;
            width: 100%; 
            margin-bottom: 15px; 
            padding: 8px 10px;
            box-sizing: border-box;
            background-color: #fff; 
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        
        .diff-label {
            font-weight: bold;
            color: #555;
            margin-right: 15px;
            flex-shrink: 0;
            width: 120px;
        }

        .summary-difference-container input {
            width: 30%; 
            border: 1px solid #999;
            padding: 5px;
            text-align: right;
            height: 30px;
            box-sizing: border-box;
            font-size: 13px;
            margin-right: 5px; 
        }
        
        .summary-difference-container input[readonly] {
            width: 30%; /* Ensure readonly spans/inputs maintain size */
            margin-right: 5px;
            background-color: #f0f0f0;
            border: 1px solid #999;
            padding: 5px;
            text-align: right;
            height: 30px;
            box-sizing: border-box;
            font-size: 13px;
            
        }

        .difference-button {
            background-color: #fff;
            border: 1px solid #999;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            width: auto;
            flex-grow: 1; 
        }
        
        .highlighted-input {
            background-color: #007bff;
            color: white;
            text-align: center;
            justify-content: center;
            font-weight: bold;
        }
        .static-teller-cell {
            background-color: #f0f0f0; 
            border: 1px solid #999;
            padding: 5px;
            text-align: right;
            font-size: 14px;
            height: 30px;
            box-sizing: border-box;
            margin-right: 5px;
            flex-basis: 30%; 
            display: flex;
            align-items: center;
            justify-content: flex-end;
            color: #333;
        }
        
        /* --- Vault View Specific Styling --- */
        .vault-grid {
            display: flex;
            flex-wrap: nowrap; 
            gap: 20px;
        }
        .vault-lower-entry-wrapper { flex: 1 1 30%; order: 1; }
        .vault-totals-display-wrapper { flex: 1 1 65%; order: 2; }

        .vault-lower-entry-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px 10px;
            align-items: center;
            padding-top: 5px;
        }
        .vault-lower-entry-grid .denom-label { 
            font-weight: bold; 
            text-align: right; 
        }
        .vault-lower-entry-grid input { 
            padding: 5px; 
            border: 1px solid #999; 
            text-align: right; 
        }
        .vault-lower-title {
            font-weight: bold;
            text-align: center;
            margin-bottom: 5px;
            padding: 5px;
            background-color: #ccc;
        }
        .vault-lower-display-table {
            border: 1px solid #333;
            width: 100%;
            border-collapse: collapse;
        }
        .vault-lower-display-table td {
            padding: 4px;
            border: 1px solid #ccc;
            text-align: right;
        }
        .vault-lower-display-table th {
             padding: 4px;
            background-color: #333;
            color: white;
            text-align: left;
        }
        .vault-lower-display-table th:nth-child(1) { text-align: left; width: 30%; }
        .vault-lower-display-table th:nth-child(2) { text-align: right; width: 35%; }
        .vault-lower-display-table th:nth-child(3) { text-align: right; width: 35%; }
        
        .vault-lower-display-table td:nth-child(1) { text-align: left; font-weight: bold; width: 30%; } 
        .vault-coin-amount-input-style {
            width: 95%;
            padding: 3px;
            border: 1px solid #999;
            text-align: right;
            box-sizing: border-box;
            font-size: 14px;
        }
        .flexcube-row td {
            font-weight: bold;
            background-color: #f7f7f7;
            border-top: 2px solid #ccc !important;
        }
        .total-row-in-table td {
            font-weight: bold;
            background-color: #e0e0e0;
            border-top: 2px solid #333 !important;
        }
        .difference-row-in-table td {
            font-weight: bold;
            background-color: #fff; 
            border-top: 3px double #333 !important;
            font-size: 1.1em;
        }
        /* Cash Flow Specific Styles */
        .cash-flow-table-container {
             max-height: 500px; 
             overflow-y: auto;
        }
        
        /* Scrollbar styling for Cash Flow table */
        .cash-flow-table-container::-webkit-scrollbar {
            width: 10px;
        }
        
        .cash-flow-table-container::-webkit-scrollbar-track {
            background: rgba(99, 102, 241, 0.05);
            border-radius: 10px;
        }
        
        .cash-flow-table-container::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #6366f1, #4f46e5);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .cash-flow-table-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #4f46e5, #4338ca);
        }
        
        /* Balance breakdown scrollbar */
        #cf-name-balance-breakdown::-webkit-scrollbar {
            width: 8px;
        }
        
        #cf-name-balance-breakdown::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 8px;
        }
        
        #cf-name-balance-breakdown::-webkit-scrollbar-thumb {
            background: linear-gradient(to bottom, #10b981, #059669);
            border-radius: 8px;
        }
        
        #cf-name-balance-breakdown::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(to bottom, #059669, #047857);
        }

        /* Responsive Adjustments for smaller screens */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                height: 100%;
                z-index: 10;
                /* Ensure it starts off-screen when hidden on mobile */
                transform: translateX(-100%);
            }
            /* Override tailwind classes on smaller screens for sidebar */
             .sidebar:not(.hidden) {
                width: 256px;
                transform: translateX(0);
            }
            .main-button {
                padding: 0.75rem 0.5rem; /* Better padding on small screens */
            }
        }
        /* Style for vault count cells to show pointer and indicate interaction */
        .vault-count-value {
            cursor: pointer;
            transition: background-color 0.1s;
        }
        .vault-count-value:hover {
            background-color: #f0f4f8;
        }
        
        /* NEW: Styling for non-editable fields in the Received/Payment sections */
        #cash-calculator-page .calc-input[readonly], 
        #cash-calculator-page .payment-input[readonly] {
            background-color: #e5e7eb; /* Tailwind gray-200 equivalent */
            cursor: default;
        }

        /* Custom Styles for Recent Transactions */
        .recent-transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }
        .recent-received {
            background-color: #d1fae5;
            color: #065f46;
            border: 1px solid #6ee7b7;
        }
        .recent-payment {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* Electricity Bill Specific Styles */
        .report-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 20px;
        }

        .report-table-cell {
            border: 1px solid #000;
            padding: 6px 10px;
            font-size: 0.95rem;
            text-align: left;
            vertical-align: middle;
        }

        .report-table-header {
            background-color: #e0e0e0;
            font-weight: 700;
            text-align: center;
        }

        .print-page {
            background: white;
            padding: 40px 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 210mm;
            min-height: 297mm;
            box-sizing: border-box;
            position: relative;
        }

        .page-footer {
            position: absolute;
            bottom: 20mm;
            width: calc(100% - 60px);
            text-align: center;
            font-size: 0.85rem;
            color: #444;
        }

        .print-spacer-45mm {
            height: 45mm;
            width: 100%;
        }

        /* Hide input number spin buttons */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type=number] {
            -moz-appearance: textfield; /* Firefox equivalent */
            appearance: textfield;
        }

        /* Styles for the manual print preview mode */
        body.preview-active #inputSection,
        body.preview-active #mainReportView {
            display: none !important;
        }
        body.preview-active {
            background-color: #e0eeef; /* Light blue/gray background for preview mode */
            padding: 0;
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
        }
        body.preview-active #pagedReportView {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            /* Ensure the paged view is visible */
            visibility: visible !important;
            height: auto !important;
        }

        /* Print styles for electricity bill */
        @media print {
            /* Hide input and control sections */
            #inputSection,
            #mainReportView,
            #previewControls {
                display: none !important;
            }
            
            /* Show the report view */
            #pagedReportView {
                display: block !important;
                width: 100% !important;
                margin: 0 !important;
                padding: 0 !important;
            }
            
            /* Ensure header is visible and properly sized */
            body > header {
                display: flex !important;
                justify-content: space-between !important;
                align-items: center !important;
                width: 100% !important;
                background-color: white !important;
                border-bottom: 2px solid #333 !important;
                padding: 15px 20px !important;
                margin-bottom: 20px !important;
            }
            /* Ensure paged report page header (injected) is visible and centered */
            #pagedReportView .page-header, #pagedReportView .page-header * {
                display: block !important;
                text-align: center !important;
                visibility: visible !important;
            }
            /* Put the bank header above the report pages when printing */
            #pagedReportView .page-header { margin-bottom: 8px !important; }

            /* Make sure the main report container prints centered with minimal top gap */
            #pagedReportView, .print-page {
                margin: 0 auto !important;
                padding: 0 !important;
                width: 100% !important;
            }
            
            /* Maintain header text sizes */
            body > header h1 {
                font-size: 24px !important;
                font-weight: bold !important;
                color: #991b1b !important; /* UCB red color */
                margin: 0 !important;
                flex: 1 !important;
            }

            .print-page {
                box-shadow: none;
                padding: 15mm;
                width: 100%;
                min-height: auto;
                margin: 0;
                page-break-after: always;
            }
            .print-page:last-child {
                page-break-after: avoid;
            }
            .page-footer {
                display: none;
            }
        }
    </style>
        <style>
            /* Print overrides: hide header and scrollbars for cash print */
            @media print {
                /* Hide the app header when printing */
                header, header * {
                    display: none !important;
                    visibility: hidden !important;
                    height: 0 !important;
                    margin: 0 !important;
                    padding: 0 !important;
                }

                /* Prevent scrollbars from appearing in print output */
                html, body, #content-area, #main-content, #cash-calculator-print-output, #atm-output-page {
                    overflow: visible !important;
                    -webkit-overflow-scrolling: auto !important;
                }

                /* Hide scrollbars across browsers in print */
                * { -ms-overflow-style: none !important; scrollbar-width: none !important; }
                *::-webkit-scrollbar { display: none !important; width: 0 !important; height: 0 !important; }

                /* Ensure printed containers use full width and no fixed height or shadows */
                #cash-calculator-print-output, #atm-output-page {
                    width: 100% !important;
                    max-width: 100% !important;
                    position: static !important;
                    box-shadow: none !important;
                    margin: 0 !important;
                    padding: 0 !important;
                }
            }
        </style>
        <style>
            /* Ensure backgrounds are removed for all print contexts to avoid printing heavy backgrounds */
            @media print {
                /* Remove any background colors or images from all elements to ensure clean white paper output */
                * {
                    background: transparent !important;
                    background-image: none !important;
                    box-shadow: none !important;
                }

                /* Ensure main report containers print on a white background (paper) */
                body, .atm-output, .print-page, #pagedReportView, #cash-calculator-print-output {
                    background: #ffffff !important;
                }

                /* Remove large decorative shadows that shouldn't print */
                .shadow-lg, .shadow-2xl, .shadow-xl, .shadow-sm {
                    box-shadow: none !important;
                }
            }
        </style>
        </head>

        <style>
            /* Print-specific styling to match PDF layout for Electricity Bill */
            @media print {
                .print-page {
                    width: calc(210mm - 6mm) !important; /* account for small margins */
                    max-width: 100% !important;
                    margin: 0 auto !important;
                    padding: 6mm 6mm 4mm 6mm !important;
                    background: #fff !important;
                    box-shadow: none !important;
                    page-break-after: always;
                    box-sizing: border-box !important;
                    overflow: visible !important;
                }
                .bank-title {
                    font-family: 'Times New Roman', Times, serif !important;
                    font-size: 30pt !important;
                    font-weight: 800 !important;
                    margin: 0 !important;
                    text-transform: none !important;
                }
                .bank-sub { font-size: 12pt !important; margin-top: 4px !important; font-weight:600 !important; }
                .bank-divider { height: 2px; background: #c0392b; border: none; margin: 8px 0 10px 0 !important; }
                /* Stack report columns when printing to avoid horizontal overflow */
                .report-grid { display: grid !important; grid-template-columns: 1fr !important; gap: 10px !important; margin-bottom: 8px !important; }
                /* Keep totals side-by-side when printing */
                /* Ensure totals appear side-by-side in print */
                .totals-grid { display: grid !important; grid-template-columns: 1fr 1fr !important; gap: 10px !important; margin-bottom: 8px !important; align-items: start !important; }
                .totals-grid > div { width: auto !important; box-sizing: border-box !important; }
                .totals-grid .border { margin: 0 !important; }
                .report-grid > div { width: 100% !important; }
                .report-grid .border { border: 1px solid #000 !important; box-sizing: border-box !important; }
                .report-table-cell, .report-table-header { padding: 6px !important; border: 1px solid #000 !important; word-break: break-word !important; overflow-wrap: break-word !important; box-sizing: border-box !important; }
                /* Make tables inside stacked report sections use fixed layout and full width so columns don't force overflow */
                .report-grid table { table-layout: fixed !important; width: 100% !important; }
                /* Ensure inputs and inline boxes scale down to fit their cells when printing */
                .report-grid input, .report-grid .notes, .report-grid .amount, .report-grid td input, .report-grid input[type=number] {
                    max-width: 100% !important;
                    box-sizing: border-box !important;
                    font-size: 9pt !important;
                    padding: 2px 4px !important;
                }
                .report-table-header { background: #e6e6e6 !important; font-weight: 700 !important; }
                table { border-collapse: collapse !important; width: 100% !important; font-size: 9.5pt !important; table-layout: fixed !important; }
                /* Fix column widths to avoid horizontal overflow when tables are rendered full-width; tuned for stacked layout */
                .report-grid table col:nth-child(1){ width: 8% !important; }
                .report-grid table col:nth-child(2){ width: 46% !important; }
                .report-grid table col:nth-child(3){ width: 12% !important; }
                .report-grid table col:nth-child(4){ width: 18% !important; }
                .report-grid table col:nth-child(5){ width: 16% !important; }
                /* Align numeric columns to right for readability */
                .report-table-cell:nth-child(3),
                .report-table-cell:nth-child(4),
                .report-table-cell:nth-child(5) { text-align: right !important; }
                .page-footer { text-align: right !important; font-size: 10pt !important; margin-top: 8px !important; }
            }
        </style>

            <!-- Generated In-Hand styles (moved from runtime injection to head to prevent FOUC) -->
            <style data-generated="in-hand-styles">
                    .in-hand-calc-box { background: linear-gradient(180deg, rgba(59,130,246,0.05), rgba(59,130,246,0.02)); border-radius: 8px; padding: 2px 4px; max-height: none; overflow: visible; }
                    .in-hand-calc-box h3 { color: #2563EB; margin: 0 0 2px 0; font-size: 0.88rem; }
                    .in-hand-deno-box { background: linear-gradient(180deg, rgba(14,165,233,0.04), rgba(14,165,233,0.01)); border-radius: 12px; padding: 6px; }
                    .in-hand-deno-box h3 { color: #0EA5E9; }
                    .in-hand-calc-box .in-hand-input, .in-hand-calc-box .input-field { border: 1px solid rgba(0,0,0,0.08); box-shadow: inset 0 1px 0 rgba(255,255,255,0.6); padding: 2px 4px; border-radius: 6px; font-size: 0.72rem; height: 20px; }
                    .in-hand-calc-box .in-hand-amount-output { color: #0f172a; }
                    .in-hand-calc-box .label { color: #0f172a; }
                    .in-hand-deno-box .in-hand-deno-output { color: #0b2545; }
                    .in-hand-calc-box .grid > span, .in-hand-deno-box .grid > span { font-weight: 600; }
                    /* Larger, bolder totals */
                    #inHandCalcTotal { font-size: 1.15rem; font-weight: 800; color: #0b2545; display: inline-block; transition: transform 300ms ease, color 300ms ease; }
                    #inHandTotal { font-size: 1.35rem; font-weight: 900; display: inline-block; transition: transform 360ms cubic-bezier(.2,.9,.3,1), color 360ms ease; }

                    /* Flexcube / Target input styling */
                    #targetAmountInput { border: 1px solid rgba(0,0,0,0.08); padding: 6px 8px; border-radius: 6px; transition: box-shadow 260ms ease, border-color 260ms ease; }

                    /* Difference result */
                    #differenceResult { font-weight: 800; transition: transform 300ms ease, color 300ms ease; }

                    /* Flash / pulse utility classes */
                    .flash-pulse { animation: flashPulse 720ms ease forwards; }
                    .flash-pop { animation: flashPop 420ms cubic-bezier(.2,.9,.3,1) forwards; }

                    @keyframes flashPulse {
                        0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59,130,246,0.0); }
                        40% { transform: scale(1.02); box-shadow: 0 6px 18px -8px rgba(59,130,246,0.24); }
                        100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(59,130,246,0); }
                    }

                    @keyframes flashPop {
                        0% { transform: translateY(0) scale(1); }
                        50% { transform: translateY(-4px) scale(1.03); }
                        100% { transform: translateY(0) scale(1); }
                    }

                    /* Subtle glow for per-row amount updates */
                    @keyframes amountGlow {
                        0% { transform: translateY(0); box-shadow: 0 0 0 rgba(250,204,21,0); }
                        40% { transform: translateY(-2px); box-shadow: 0 18px 40px -18px rgba(250,204,21,0.22); }
                        100% { transform: translateY(0); box-shadow: 0 0 0 rgba(250,204,21,0); }
                    }
                    .amount-glow { animation: amountGlow 620ms ease forwards; }
                    /* Popup drag & resize styles */
                    /* overlay scrolls, popup sits near top and is narrow/tall like mobile card */
                    .calc-popup-overlay { display: none; position: fixed; inset: 0; background: rgba(11,14,20,0.18); align-items: flex-start; justify-content: center; padding-top: 36px; overflow: auto; z-index: 1200; }
                    .calc-popup-overlay.active { display: flex; }
                    .calc-popup { background: #fff; border-radius: 10px; box-shadow: 0 18px 40px -18px rgba(2,6,23,0.6); width: 320px; height: calc(100vh - 96px); max-width: calc(100% - 40px); max-height: calc(100vh - 56px); position: relative; overflow: visible; z-index: 1300; margin: 0 auto; }
                    .calc-popup .popup-header { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid rgba(0,0,0,0.06); cursor: move; }
                    .calc-popup .calc-popup-close { background:transparent; border:none; font-size:16px; padding:6px 8px; cursor:pointer; }
                    .calc-resize-handle { width:14px; height:14px; position:absolute; right:6px; bottom:6px; background:linear-gradient(135deg,#e2e8f0,#cbd5e1); border-radius:4px; box-shadow:0 4px 10px rgba(2,6,23,0.08); cursor:nwse-resize; z-index:1400; }
                    .calc-resize-handle:after { content:''; display:block; width:10px; height:10px; margin:4px; background:linear-gradient(135deg, rgba(16,24,40,0.06), transparent); transform:rotate(45deg); }
                    /* Extra-compact styles when calculation is inside popup */
                    #calcPopupBody .in-hand-calc-box { padding: 6px; border-radius:6px; }
                    #calcPopupBody .in-hand-calc-box h3 { display:none; }
                    #calcPopupBody .in-hand-input, #calcPopupBody .input-field { padding:3px 5px; font-size:0.72rem; border-radius:5px; width:56px; height:18px; }
                    #calcPopupBody .in-hand-amount-output, #calcPopupBody .calc-output { font-size:0.82rem; }
                    #calcPopupBody .grid { gap: 4px; }
                    #calcPopupBody .grid.grid-cols-3 > span { font-size:0.78rem; }
                    #calcPopupBody .grid.grid-cols-3 input { font-size:0.72rem; width:56px; height:18px; }
                    #calcPopupBody #inHandCalcTotal { font-size:0.98rem; }
                    #calcPopupBody .in-hand-deno-box { padding:6px; }
                    #calcPopupBody .in-hand-deno-output, #calcPopupBody .in-hand-deno-amount { font-size:0.8rem; }
                    #calcPopupBody .main-button { padding:5px 6px; font-size:0.85rem; }
                    /* collapse labels where space is tight */
                    #calcPopupBody .label { display:none; }
                    #calcPopupBody .text-right.font-medium { font-size:0.78rem; }
                    /* Ultra-compact variant */
                    #calcPopupBody.ultra-compact .in-hand-calc-box { padding:4px; }
                    #calcPopupBody.ultra-compact .in-hand-input, #calcPopupBody.ultra-compact .input-field { width:44px; padding:3px 4px; font-size:0.75rem; }
                    #calcPopupBody.ultra-compact .in-hand-amount-output, #calcPopupBody.ultra-compact .calc-output { font-size:0.72rem; }
                    #calcPopupBody.ultra-compact .grid { gap: 2px; }
                    #calcPopupBody.ultra-compact .in-hand-deno-output, #calcPopupBody.ultra-compact .in-hand-deno-amount { font-size:0.7rem; }
                    #calcPopupBody.ultra-compact .main-button { padding:4px 6px; font-size:0.78rem; }
                    #calcPopupBody.ultra-compact .in-hand-calc-box h3, #calcPopupBody.ultra-compact .label { display:none; }

                    /* Super-compact layout for very small popup header area */
                    #calcPopupBody.super-compact .in-hand-calc-box { padding:2px; }
                    #calcPopupBody.super-compact .in-hand-input, #calcPopupBody.super-compact .input-field { width:36px; padding:2px 3px; font-size:0.7rem; }
                    #calcPopupBody.super-compact .in-hand-amount-output, #calcPopupBody.super-compact .calc-output { font-size:0.68rem; }
                    #calcPopupBody.super-compact .grid { gap: 2px; }
                    #calcPopupBody.super-compact .main-button { padding:3px 6px; font-size:0.72rem; }

                    /* Micro-compact: smallest footprint; keep denomination labels visible */
                    #calcPopupBody.micro-compact .in-hand-calc-box { padding:1px; }
                    #calcPopupBody.micro-compact .in-hand-input, #calcPopupBody.micro-compact .input-field { width:30px; padding:2px 3px; font-size:0.64rem; }
                    #calcPopupBody.micro-compact .in-hand-amount-output, #calcPopupBody.micro-compact .calc-output { font-size:0.62rem; }
                    #calcPopupBody.micro-compact .grid { gap: 2px; }
                    #calcPopupBody.micro-compact .main-button { padding:3px 5px; font-size:0.7rem; }
                    /* keep denomination labels (.text-right.font-medium) visible so values like '1000 x' show */
                    #calcPopupBody.micro-compact .label { display:none; }
                    #calcPopupBody.micro-compact .in-hand-deno-output, #calcPopupBody.micro-compact .in-hand-deno-amount { font-size:0.66rem; }
                    /* shrink header and close button when popup has micro class */
                    .calc-popup.micro-compact .popup-header { padding:2px 6px; }
                    .calc-popup.micro-compact .calc-popup-close { font-size:0.95rem; padding:2px; }

                    /* Anchor the popup action buttons to bottom-right inside the popup */
                    .popup-btn-row { position: absolute; right: 12px; bottom: 12px; z-index: 1400; }
                    .popup-btn-row .main-button { box-shadow: 0 6px 18px rgba(2,6,23,0.08); }

                    /* Live RGB badge for user display */
                    /* Animated RGB gradient text for the header name */
                    .rgb-text {
                        display: inline-block;
                        background: linear-gradient(90deg, #ff004c 0%, #ff9900 25%, #00d4ff 50%, #7bff00 75%, #ff00a8 100%);
                        background-size: 300% 300%;
                        -webkit-background-clip: text;
                        background-clip: text;
                        color: transparent;
                        font-weight: 700;
                        /* Reduce gradient headline size for a more compact header */
                        font-size: 0.85rem;
                        line-height: 1;
                        animation: rgbTextMove 3.2s linear infinite;
                        text-decoration: none;
                    }

                    @keyframes rgbTextMove {
                        0% { background-position: 0% 50%; }
                        50% { background-position: 100% 50%; }
                        100% { background-position: 0% 50%; }
                    }

                    @media (prefers-reduced-motion: reduce) {
                        .rgb-text { animation: none; background-position: 50% 50%; }
                    }

                    /* Accessible focus rings */
                    .recent-transaction-item:focus {
                        outline: none;
                        box-shadow: 0 0 0 4px rgba(59,130,246,0.18), 0 2px 6px rgba(2,6,23,0.08);
                        border-radius: 8px;
                        transform: translateY(-1px);
                    }

                    #toggle-recv-pay-btn:focus {
                        outline: none;
                        box-shadow: 0 0 0 4px rgba(16,185,129,0.14), 0 2px 6px rgba(2,6,23,0.06);
                        border-radius: 10px;
                    }

                    #targetAmountInput:focus {
                        outline: none;
                        box-shadow: 0 0 0 3px rgba(234,88,12,0.12);
                        border-color: rgba(234,88,12,0.9);
                    }
                    /* Tighter vertical spacing */
                    .in-hand-calc-box .space-y-2 > .grid { margin-bottom: 0px; }
                    .in-hand-calc-box .grid.grid-cols-3 > span { font-size: 0.8rem; }
                    .in-hand-calc-box .grid.grid-cols-3 input { height: 18px; font-size: 0.72rem; }
                    .in-hand-calc-box .in-hand-amount-output { font-size: 0.8rem; }
                    .in-hand-calc-box .label { font-size: 0.8rem; }
                    .in-hand-deno-box .space-y-2 > .grid { margin-bottom: 4px; }
                    /* Extra tightening for grid rows inside in-hand sections */
                    .in-hand-calc-box .grid.items-center, .in-hand-deno-box .grid.items-center {
                        margin-bottom: 4px;
                        padding-top: 2px;
                        padding-bottom: 2px;
                    }
                    /* Popup modal for Calculation section */
                    .calc-popup-overlay {
                        position: fixed;
                        inset: 0;
                        background: rgba(0,0,0,0.18);
                        display: none;
                        align-items: flex-start;
                        justify-content: center;
                        padding-top: 36px;
                        overflow: auto;
                        z-index: 1200;
                    }
                    .calc-popup-overlay.active { display: flex; }
                    .calc-popup { background: #fff; border-radius: 10px; max-width: 720px; width: 320px; height: calc(100vh - 96px); max-height: 90vh; overflow: visible; box-shadow: 0 20px 50px rgba(2,6,23,0.4); padding: 12px; position: relative; margin:0 auto; }
                    .calc-popup .popup-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px; }
                    .calc-popup .popup-header h3 { margin:0; font-size:1.05rem; }
                    .calc-popup-close { background: transparent; border: none; font-size: 1.05rem; cursor: pointer; padding:4px; border-radius:6px; }
                    .calc-popup-openwin { background: transparent; border: none; font-size: 0.95rem; cursor: pointer; padding:4px; border-radius:6px; }
                    .calc-popup-close:focus { outline: none; box-shadow: 0 0 0 4px rgba(59,130,246,0.18); }

                    /* Floating calc button */
                    #openCalcPopupBtn { position: fixed; right: 18px; bottom: 18px; z-index: 1100; background: linear-gradient(180deg,#2563EB,#1D4ED8); color: #fff; border:none; padding: 10px 14px; border-radius: 10px; box-shadow: 0 8px 24px rgba(29,78,216,0.28); cursor:pointer; font-weight:700; }
                    #openCalcPopupBtn:focus { outline: none; box-shadow: 0 0 0 6px rgba(37,99,235,0.12); }
                    /* Responsive adjustments */
                    @media (max-width: 768px) {
                        .in-hand-calc-box, .in-hand-deno-box { padding: 10px; }
                        #inHandCalcTotal, #inHandTotal { font-size: 1.05rem; }
                    }

                    /* Reset and Cash Print button styles + animations */
                    .btn-animated {
                        border: none;
                        cursor: pointer;
                        display: inline-flex;
                        align-items: center;
                        justify-content: center;
                        gap: 8px;
                        box-shadow: 0 6px 18px -10px rgba(2,6,23,0.08);
                        transition: transform 160ms ease, box-shadow 160ms ease, background-color 200ms ease;
                    }
                    .btn-animated:hover { transform: translateY(-3px); box-shadow: 0 12px 26px -14px rgba(2,6,23,0.12); }
                    .btn-animated:active { transform: translateY(0) scale(0.995); }

                    /* specific looks */
                    #resetAllBtn.btn-animated { background: linear-gradient(180deg,#374151,#111827); color: #fff; padding: 10px 16px; border-radius: 10px; }
                    #cashPrintBtn.btn-animated { background: linear-gradient(180deg,#ef4444,#dc2626); color: #fff; padding: 10px 16px; border-radius: 10px; }

                    /* pulse used to draw attention when action occurs */
                    @keyframes btnPulse {
                        0% { transform: scale(1); box-shadow: 0 8px 20px -12px rgba(239,68,68,0.0); }
                        40% { transform: scale(1.03); box-shadow: 0 18px 44px -16px rgba(239,68,68,0.18); }
                        100% { transform: scale(1); box-shadow: 0 8px 20px -12px rgba(239,68,68,0); }
                    }
                    .btn-pulse { animation: btnPulse 640ms ease forwards; }

                    /* Modern card for Total Cash In Hand */
                    .in-hand-total-card {
                        background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(245,247,250,0.96));
                        border-radius: 14px;
                        padding: 12px 14px;
                        box-shadow: 0 8px 24px -12px rgba(2,6,23,0.12), inset 0 -1px 0 rgba(255,255,255,0.6);
                        align-items: center;
                        justify-content: space-between;
                        transition: transform 260ms ease, box-shadow 260ms ease, background 260ms ease;
                        border: 1px solid rgba(15,23,42,0.04);
                    }
                    .in-hand-total-card .label { color: #0f172a; font-weight: 700; }
                    .in-hand-total-card #inHandTotal { font-size: 1.25rem; font-weight: 900; color: #0b2545; }

                    /* State variants: positive (surplus), negative (shortage), neutral (match/blank) */
                    .in-hand-total-card.positive { background: linear-gradient(180deg,#ecfdf5,#f0fff4); border-color: rgba(16,185,129,0.12); }
                    .in-hand-total-card.negative { background: linear-gradient(180deg,#fff1f2,#fff7f7); border-color: rgba(239,68,68,0.08); }
                    .in-hand-total-card.neutral { background: linear-gradient(180deg,#f8fafc,#ffffff); border-color: rgba(15,23,42,0.04); }

                    .in-hand-total-card.positive #inHandTotal { color: #059669; }
                    .in-hand-total-card.negative #inHandTotal { color: #dc2626; }
                    .in-hand-total-card.neutral #inHandTotal { color: #0b2545; }
            </style>
</head>
<body class="bg-gray-200 flex flex-col h-screen">

    <!-- Header -->
    <header class="app-header-pro bg-white text-gray-800 border-b-2 border-gray-200 flex justify-between items-center shadow-sm fixed top-0 left-0 right-0 z-50" style="padding: 12px 20px;">
        <div class="flex items-center gap-4 flex-1">
            <button id="sidebarToggle" class="text-gray-800 focus:outline-none menu-icon-container" style="flex-shrink: 0;">
                <!-- Animated Hamburger Icon -->
                <div id="menuIcon" class="menu-icon-container">
                    <div class="menu-icon-line line-top"></div>
                    <div class="menu-icon-line line-middle"></div>
                    <div class="menu-icon-line line-bottom"></div>
                </div>
            </button>
            <div class="header-icon-box-pro" style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(99, 102, 241, 0.25); flex-shrink: 0;">
                <i class="fas fa-wallet" style="font-size: 20px; color: #fff;"></i>
            </div>
            <div class="header-text-pro" style="flex: 1; min-width: 0;">
                <h1 class="font-bold" style="font-size: 1.3rem; margin: 0; font-weight: 900; color: #6366f1; letter-spacing: -0.3px; line-height: 1.2;">Cash Management</h1>
            </div>
        </div>
        <div class="text-right" style="font-size: 0.7rem; flex-shrink: 0;">
            <p class="font-bold text-gray-700"><span class="rgb-text" style="font-size: 0.72rem;">Tanzil Ahmed</span></p>
            <p class="font-bold text-gray-700"><span class="rgb-text" style="font-size: 0.72rem;">EID: 7966</span></p>
        </div>
    </header>

    <!-- Main Container -->
    <main id="main-content" class="flex-1 flex p-6 gap-6 overflow-hidden mt-[24px]">
        
        <!-- Left Sidebar -->
        <aside id="sidebar" class="w-64 p-4 flex flex-col items-center rounded-xl shadow-lg sidebar closed hidden">
            
            <h2 class="text-white text-lg font-bold mb-6 mt-2 tracking-wide border-b border-red-700 pb-2 w-full text-center">
                NAVIGATION
            </h2>
            <div class="space-y-4 w-full flex flex-col">
                
                <!-- 1. Cash Calculator -->
                <button id="cashCalculatorBtn" class="sidebar-button"><i class="fas fa-calculator" style="margin-right: 10px; width: 18px; text-align: center;"></i>Cash Calculator</button>
                
                <!-- 2. Cash Flow -->
                <button id="cashFlowBtn" class="sidebar-button"><i class="fas fa-stream" style="margin-right: 10px; width: 18px; text-align: center;"></i>Cash Flow</button>

                <!-- 3. Cash Receive -->
                <button id="cashReceiveBtn" class="sidebar-button"><i class="fas fa-arrow-down" style="margin-right: 10px; width: 18px; text-align: center;"></i>Cash Receive</button>
                
                <!-- 4. Vault -->
                <button id="vaultBtn" class="sidebar-button"><i class="fas fa-vault" style="margin-right: 10px; width: 18px; text-align: center;"></i>Vault</button>
                
                <!-- 5. ATM -->
                <button id="atmBtn" class="sidebar-button"><i class="fas fa-money-check-alt" style="margin-right: 10px; width: 18px; text-align: center;"></i>ATM Replenishment</button>

                <!-- 6. Electricity Bill -->
                <button id="electricityBtn" class="sidebar-button"><i class="fas fa-file-invoice-dollar" style="margin-right: 10px; width: 18px; text-align: center;"></i>Electricity Bill</button>
                
            </div>
        </aside>

    <!-- Overlay for sidebar (click to close) -->
    <div class="sidebar-overlay" aria-hidden="true"></div>

    <!-- Main Content Area -->
    <section id="content-area" class="flex-1 rounded-xl shadow-lg p-6 flex flex-col items-center overflow-auto" style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border: 1px solid rgba(99,102,241,0.08);">
            
            <!-- Cash Calculator Page Content -->
            <div id="cash-calculator-page" class="flex-1 flex flex-col w-full">
                
                <!-- Page Title with Icon -->
                <div class="mb-6 pb-4 border-b-2 border-gray-200">
                    <h2 class="text-2xl font-bold" style="color: #6366f1; display: flex; align-items: center; gap: 12px;">
                        <span style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(99,102,241,0.2);">
                            <i class="fas fa-calculator" style="color: white; font-size: 18px;"></i>
                        </span>
                        Cash Calculator
                    </h2>
                    <p style="color: #64748b; margin-top: 8px; margin-left: 52px; font-size: 0.95rem;">Manage your cash transactions with real-time calculations and denomination tracking</p>
                </div>
                
                <div class="flex flex-col md:flex-row gap-6 w-full items-start">
                    
                    <!-- NEW: Column 1 - In Hand Calculation (with Amount Column) -->
                    <div class="w-full md:w-1/3">
                        <div class="section-box in-hand-calc-box flex flex-col gap-1">
                            <h3 class="text-lg font-bold mb-2 text-center">Calculation</h3>
                            <!-- Header Row for Denomination, Count, Amount -->
                            <div class="grid grid-cols-3 gap-1 text-xs font-bold text-gray-600 mb-1 border-b border-gray-300 pb-1">
                                <span class="text-right">Denom x</span>
                                <span class="text-center">Count</span>
                                <span class="text-right">Amount</span>
                            </div>
                            <div class="space-y-2">
                                <!-- INPUT ROWS: Changed to grid-cols-3 and added amount-output -->
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">1000 x</span>
                                    <input type="number" data-denomination="1000" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="1000">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">500 x</span>
                                    <input type="number" data-denomination="500" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="500">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">200 x</span>
                                    <input type="number" data-denomination="200" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="200">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">100 x</span>
                                    <input type="number" data-denomination="100" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="100">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">50 x</span>
                                    <input type="number" data-denomination="50" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="50">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">20 x</span>
                                    <input type="number" data-denomination="20" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="20">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">10 x</span>
                                    <input type="number" data-denomination="10" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="10">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">5 x</span>
                                    <input type="number" data-denomination="5" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="5">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">2 x</span>
                                    <input type="number" data-denomination="2" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="2">0</span>
                                </div>
                                <div class="grid grid-cols-3 gap-1 items-center">
                                    <span class="text-right font-medium">1 x</span>
                                    <input type="number" data-denomination="1" class="in-hand-input input-field col-span-1 text-center" value="">
                                    <span class="in-hand-amount-output font-semibold text-right" data-denomination="1">0</span>
                                </div>
                                <div class="flex justify-between items-center font-bold border-t border-gray-300 pt-2 mt-2">
                                    <span class="label">Total Amount</span>
                                    <span id="inHandCalcTotal" class="text-lg">0</span>
                                </div>
                            </div>
                        </div>
                        <!-- Calc popup removed -->
                        <div class="grid grid-cols-3 gap-1 items-center mt-4 w-full">
                            <!-- ADDED COPY LOGIC TO RECEIVED AND PAYMENT BUTTONS -->
                            <button id="addReceivedBtn" class="main-button btn-received btn-animate">Received</button>
                            <button id="addPaymentBtn" class="main-button btn-payment btn-animate">Payment</button>
                            <button id="inHandResetBtn" class="main-button btn-reset btn-animate">Reset</button>
                        </div>
                        <!-- Open in Window button -->
                        <!-- Open in Window button was moved to Recent Transactions column -->
                    </div>
                    
                    <!-- Column 2 - In Hand Denomination Section & Totals -->
                    <div class="w-full md:w-1/3 section-box in-hand-deno-box flex flex-col gap-1">
                        <h3 class="text-lg font-bold mb-2 text-center">Total Cash In Hand</h3>
                        <div class="space-y-2">
                            <div class="grid grid-cols-3 gap-1 text-xs font-bold text-gray-600 mb-1 border-b border-gray-300 pb-1">
                                <span class="text-right">Denom x</span>
                                <span class="text-center">Count</span>
                                <span class="text-right">Amount</span>
                            </div>
                             <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">1000 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="1000">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="1000">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">500 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="500">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="500">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">200 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="200">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="200">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">100 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="100">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="100">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">50 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="50">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="50">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">20 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="20">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="20">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">10 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="10">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="10">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">5 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="5">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="5">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-1 items-center">
                                <span class="text-right font-medium">2 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="2">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="2">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">1 x</span>
                                <span class="in-hand-deno-output font-semibold text-right" data-denomination="1">0</span>
                                <span class="in-hand-deno-amount font-semibold text-right" data-denomination="1">0</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center in-hand-total-card p-3 mt-4">
                            <span class="label">Total Cash In Hand</span>
                            <span id="inHandTotal" class="text-xl">0</span>
                        </div>
                        <!-- Difference Calculation Section - TARGET AMOUNT REPLACED WITH FLEXCUBE AMOUNT -->
                        <div class="flex flex-col justify-center items-center gap-2 border-t pt-4 mt-4">
                            <!-- New Flexcube Amount Label -->
                            <label for="targetAmountInput" class="label font-bold text-gray-700">Flexcube Amount:</label>
                            <input type="number" id="targetAmountInput" class="input-field w-full text-center" placeholder="0" value="0">
                            <!-- Removed Difference Button -->
                            <div class="flex justify-between w-full pt-1">
                                <span class="label">Difference:</span>
                                <span id="differenceResult" class="font-bold text-lg text-red-600">0</span>
                            </div>
                            <!-- Label showing To be Pay / To be Receive based on ledger sign -->
                            <div class="w-full text-center mt-1">
                                <span id="differenceLabel" class="text-sm font-semibold text-gray-700">Current</span>
                            </div>
                        </div>
                    </div>

                    <!-- NEW: Column 3 - Recent Transactions -->
                    <div class="w-full md:w-1/3 section-box flex flex-col">
                        <h3 class="text-lg font-bold mb-2 text-center">Recent Transactions</h3>
                        <div id="recent-transactions-list" class="space-y-3 flex-1 overflow-y-auto">
                            <!-- Transactions will be injected here by JS -->
                            <p class="text-center text-sm text-gray-500 py-4">No recent transactions.</p>
                        </div>
                        <div class="mt-3">
                            <button id="openCalcWindowBtn" class="main-button btn-animated w-full" title="Open calculator in a separate window">Open in Window</button>
                        </div>
                        
                    </div>
                </div>

                <!-- Single control to show/hide both Received and Payment panels -->
                <div class="w-full flex justify-end mb-3">
                                        <button id="toggle-recv-pay-btn" class="main-button flex items-center gap-2" aria-pressed="false" title="Show or hide Received and Payment panels">
                                            <span class="toggle-recv-pay-label">Hide Received & Payment</span>
                                            <svg class="toggle-chevron w-5 h-5 transition-transform duration-300" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M6 9l6 6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                                        </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full mt-6">
                    <!-- Received Section -->
                    <div id="received-panel" class="section-box flex flex-col panel-accent-received">
                        <h3 class="text-lg font-bold mb-2 text-center">Received</h3>
                        <div class="space-y-2">
                            <div class="grid grid-cols-3 gap-2 text-xs font-bold text-gray-600 mb-1 border-b border-gray-300 pb-1">
                                <span class="text-right">Denom x</span>
                                <span class="text-center">Count</span>
                                <span class="text-right">Amount</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">1000 x</span>
                                <!-- count -->
                                <input type="number" data-denomination="1000" class="calc-input input-field col-span-1" value="0" readonly>
                                <!-- amount -->
                                <span class="calc-amount font-semibold text-right" data-denomination="1000">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">500 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="500" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="500">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">200 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="200" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="200">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">100 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="100" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="100">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">50 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="50" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="50">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">20 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="20" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="20">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">10 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="10" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="10">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">5 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="5" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="5">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">2 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="2" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="2">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">1 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="1" class="calc-input input-field col-span-1" value="0" readonly>
                                <span class="calc-amount font-semibold text-right" data-denomination="1">0</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center border-t border-gray-300 pt-4 mt-4 font-bold text-lg">
                            <span class="label">Total Received</span>
                            <span id="totalReceived" class="text-gray-900">0</span>
                        </div>
                    </div>

                    <!-- Payment Section -->
                    <div id="payment-panel" class="section-box flex flex-col panel-accent-payment">
                        <h3 class="text-lg font-bold mb-2 text-center">Payment</h3>
                        <div class="space-y-2">
                            <div class="grid grid-cols-3 gap-2 text-xs font-bold text-gray-600 mb-1 border-b border-gray-300 pb-1">
                                <span class="text-right">Denom x</span>
                                <span class="text-center">Count</span>
                                <span class="text-right">Amount</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">1000 x</span>
                                <input type="number" data-denomination="1000" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="1000">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">500 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="500" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="500">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">200 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="200" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="200">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">100 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="100" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="100">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">50 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="50" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="50">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">20 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="20" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="20">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">10 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="10" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="10">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">5 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="5" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="5">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">2 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="2" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="2">0</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 items-center">
                                <span class="text-right font-medium">1 x</span>
                                <!-- ADDED READONLY -->
                                <input type="number" data-denomination="1" class="payment-input input-field col-span-1" value="0" readonly>
                                <span class="payment-amount font-semibold text-right" data-denomination="1">0</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center border-t border-gray-300 pt-4 mt-4 font-bold text-lg">
                            <span class="label">Total Payment</span>
                            <span id="totalPayment" class="text-gray-900">0</span>
                        </div>
                    </div>

                    <!-- Reset and Print buttons here (swapped order) -->
                    <div class="w-full flex flex-col items-center mt-4 md:mt-0 space-y-4">
                        <button id="cashPrintBtn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 700; padding: 12px 16px; border-radius: 8px; border: none; box-shadow: 0 6px 16px rgba(245, 158, 11, 0.3); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 24px rgba(245, 158, 11, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 16px rgba(245, 158, 11, 0.3)'"><i class="fas fa-print"></i>Cash Print</button>
                        <button id="resetAllBtn" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; font-weight: 700; padding: 12px 16px; border-radius: 8px; border: none; box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 24px rgba(99, 102, 241, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 6px 16px rgba(99, 102, 241, 0.3)'"><i class="fas fa-redo-alt"></i>Reset All</button>
                    </div>

                </div>

            </div>
            
            <!-- Cash Calculator Print Output Container (Hidden by default, shown only for printing) -->
            <div id="cash-calculator-print-output" class="hidden flex-1 flex-col w-full">
                <!-- Content generated by JS -->
            </div>
            
            <!-- Cash Flow Page Content (NOW FULLY FUNCTIONAL LEDGER) -->
            <div id="cash-flow-page" class="hidden flex-1 flex flex-col w-full">
                
                <!-- Page Title with Icon -->
                <div class="mb-6 pb-4 border-b-2 border-gray-200">
                    <h2 class="text-2xl font-bold" style="color: #6366f1; display: flex; align-items: center; gap: 12px;">
                        <span style="width: 40px; height: 40px; background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 10px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(99,102,241,0.2);">
                            <i class="fas fa-stream" style="color: white; font-size: 18px;"></i>
                        </span>
                        Cash Flow Ledger
                    </h2>
                    <p style="color: #64748b; margin-top: 8px; margin-left: 52px; font-size: 0.95rem;">Track all cash transactions with automatic balance calculations and name-based summaries</p>
                </div>

                <div class="max-w-7xl mx-auto w-full space-y-6">
                    
                    <!-- Error Message Box -->
                    <div id="error-message" class="hidden px-4 py-3 rounded-lg relative" role="alert" style="border-left: 4px solid;"></div>

                    <!-- Transaction Input Form Card -->
                    <div class="section-box" style="background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%); padding: 1.5rem; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.06);">
                        <h3 class="text-xl font-bold mb-4" style="color: #1e293b; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-plus-circle" style="color: #6366f1;"></i>
                            New Transaction
                        </h3>
                        <form id="cash-flow-transaction-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                            
                            <!-- Name field -->
                            <div class="md:col-span-3">
                                <label for="cf-description" class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-user" style="color: #6366f1; margin-right: 6px;"></i>Name / Details
                                </label>
                                <input type="text" id="cf-description" name="description" placeholder="Enter name or transaction details" required 
                                    class="w-full px-4 py-2.5 border-2 border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-all" 
                                    style="font-size: 0.95rem;">
                            </div>

                            <!-- PAID Field -->
                            <div class="md:col-span-1">
                                <label for="cf-payment" class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-arrow-up" style="color: #ef4444; margin-right: 6px;"></i>Paid
                                </label>
                                <input type="number" id="cf-payment" name="payment" min="0" step="0.01" placeholder="0.00" 
                                    class="w-full px-4 py-2.5 border-2 border-red-300 rounded-lg shadow-sm focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" 
                                    style="font-size: 0.95rem; text-align: right; font-weight: 600;">
                            </div>

                            <!-- RECEIVED Field -->
                            <div class="md:col-span-1">
                                <label for="cf-receipt" class="block text-sm font-bold text-gray-700 mb-2">
                                    <i class="fas fa-arrow-down" style="color: #10b981; margin-right: 6px;"></i>Received
                                </label>
                                <input type="number" id="cf-receipt" name="receipt" min="0" step="0.01" placeholder="0.00" 
                                    class="w-full px-4 py-2.5 border-2 border-green-300 rounded-lg shadow-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 transition-all" 
                                    style="font-size: 0.95rem; text-align: right; font-weight: 600;">
                            </div>

                            <div class="md:col-span-5 flex justify-end space-x-4 mt-2">
                                <!-- ADD TRANSACTION BUTTON -->
                                <button type="submit" id="cf-submit-btn" class="main-button" style="background: linear-gradient(135deg, #6366f1, #4f46e5); padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 700; box-shadow: 0 4px 12px rgba(99,102,241,0.25);">
                                    <i class="fas fa-plus" style="margin-right: 8px;"></i>Add Transaction
                                </button>
                                <!-- CLEAR ALL BUTTON -->
                                <button type="button" id="cf-clear-all-btn" onclick="cashFlowHandleClearAll()" class="main-button" style="background: linear-gradient(135deg, #ef4444, #dc2626); padding: 0.75rem 1.5rem; border-radius: 10px; font-weight: 700; box-shadow: 0 4px 12px rgba(239,68,68,0.25);">
                                    <i class="fas fa-trash-alt" style="margin-right: 8px;"></i>Clear All
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- BALANCE SECTIONS -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <!-- Current Cash Balance Card -->
                        <div class="section-box lg:col-span-1" style="background: linear-gradient(135deg, rgba(99,102,241,0.08) 0%, #ffffff 100%); border-left: 4px solid #6366f1; padding: 1.5rem; border-radius: 14px; box-shadow: 0 6px 20px rgba(99,102,241,0.15);">
                            <div class="flex items-center gap-3 mb-3">
                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #6366f1, #4f46e5); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-wallet" style="color: white; font-size: 16px;"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-700">Current Balance</h3>
                            </div>
                            <div class="text-right">
                                <span id="cf-final-balance" class="text-4xl font-extrabold" style="color: #6366f1;">0.00</span>
                                <p class="text-sm text-gray-500 mt-1">Total Cash on Hand</p>
                            </div>
                        </div>

                        <!-- Balance Breakdown Card -->
                        <div class="section-box lg:col-span-2" style="background: #ffffff; padding: 1.5rem; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); border: 1px solid rgba(99,102,241,0.1);">
                            <div class="flex items-center gap-3 mb-4 pb-3 border-b-2 border-gray-200">
                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-chart-pie" style="color: white; font-size: 16px;"></i>
                                </div>
                                <h3 class="text-lg font-bold text-gray-700">Balance Breakdown</h3>
                            </div>
                            <div id="cf-name-balance-breakdown" class="max-h-52 overflow-y-auto pr-2" style="scrollbar-width: thin; scrollbar-color: #6366f1 #e5e7eb;">
                                <p class="text-gray-500 text-center py-6 text-sm italic">No named transactions yet</p>
                            </div>
                        </div>
                    </div>

                    <!-- Transaction Table Card -->
                    <div class="section-box" style="background: #ffffff; padding: 0; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); border: 1px solid rgba(99,102,241,0.1); overflow: hidden;">
                        <div style="padding: 1.25rem 1.5rem; background: linear-gradient(135deg, rgba(99,102,241,0.04) 0%, transparent 100%); border-bottom: 2px solid #e5e7eb;">
                            <h3 class="text-lg font-bold" style="color: #1e293b; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-list" style="color: #6366f1;"></i>
                                Transaction History
                            </h3>
                        </div>
                        <div class="cash-flow-table-container" style="max-height: 500px; overflow-y: auto;">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="sticky top-0" style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); z-index: 10;">
                                    <tr>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="color: #475569;">
                                            <i class="fas fa-clock" style="margin-right: 6px; color: #6366f1;"></i>Time Stamp
                                        </th>
                                        <th scope="col" class="px-6 py-4 text-left text-xs font-bold uppercase tracking-wider" style="color: #475569;">
                                            <i class="fas fa-user" style="margin-right: 6px; color: #6366f1;"></i>Name
                                        </th>
                                        <th scope="col" class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider" style="color: #475569;">
                                            <i class="fas fa-arrow-up" style="margin-right: 6px; color: #ef4444;"></i>Paid
                                        </th>
                                        <th scope="col" class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider" style="color: #475569;">
                                            <i class="fas fa-arrow-down" style="margin-right: 6px; color: #10b981;"></i>Received
                                        </th>
                                        <th scope="col" class="px-6 py-4 text-right text-xs font-bold uppercase tracking-wider" style="color: #475569;">
                                            <i class="fas fa-balance-scale" style="margin-right: 6px; color: #6366f1;"></i>Balance
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="cf-cash-book-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="py-8 text-center text-gray-500 italic">No transactions recorded yet</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>


            </div>

            <!-- Cash Receive Page Content -->
            <div id="cash-receive-page" class="hidden flex-1 flex flex-col w-full p-4 sm:p-0 items-center">
                 <div class="cash-receive-container w-full">
                    
                    <!-- Professional Page Header -->
                    <div style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 10px; backdrop-filter: blur(10px);">
                                <i class="fas fa-money-bill-wave" style="font-size: 1.8rem; color: #fff;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h2 style="font-size: 1.5rem; font-weight: 900; color: #fff; margin: 0; letter-spacing: 0.5px;">Cash Receive Calculator</h2>
                                <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; margin: 0.25rem 0 0 0;">Multi-Teller Denomination Entry & Reconciliation</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Top Denomination Calculator Card -->
                    <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(99, 102, 241, 0.1);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <i class="fas fa-calculator" style="color: #6366f1; font-size: 1.1rem;"></i>
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0;">Denomination Calculator</h3>
                        </div>
                        <div class="calculator-section">
                            <div class="cash-receive-header-row">
                                <!-- Column Headers -->
                                <div class="header-cell cash-receive-denomination-value"></div>
                                <div class="header-cell" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 12px; border-radius: 8px; font-weight: 700; text-align: center;"><i class="fas fa-user" style="margin-right: 6px;"></i>Teller 1</div>
                                <div class="header-cell" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px; border-radius: 8px; font-weight: 700; text-align: center;"><i class="fas fa-user" style="margin-right: 6px;"></i>Teller 2</div>
                                <div class="header-cell" style="background: linear-gradient(135deg, #ec4899 0%, #db2777 100%); color: white; padding: 12px; border-radius: 8px; font-weight: 700; text-align: center;"><i class="fas fa-user" style="margin-right: 6px;"></i>Teller 3</div>
                            </div>
                            <!-- Rows will be injected here by JavaScript -->
                            <div id="top-calc"></div>
                            
                            <!-- Grand Totals Row will be injected here by JavaScript -->
                            <div id="grand-totals-row-receive"></div>
                        </div>
                    </div>

                    <!-- Reconciliation Section Card -->
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1.25rem;">
                            <i class="fas fa-balance-scale" style="color: #10b981; font-size: 1.1rem;"></i>
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0;">Flexcube Reconciliation</h3>
                        </div>
                        <div class="totals-section">
                            
                            <!-- 1. Difference for Teller 1 (Tanzil) -->
                            <div class="summary-difference-container" style="background: white; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); border-left: 4px solid #10b981;">
                                <span class="diff-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #1e293b;"><i class="fas fa-user-check" style="color: #10b981;"></i>Teller 1 Difference:</span>
                                <!-- User Flexcube Input -->
                                <input type="text" id="target-tanzil" value="" placeholder="Flexcube Amount" class="receive-target-input" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; transition: all 0.3s;">
                                <!-- Difference Result Display (Readonly) -->
                                <input type="text" id="result-tanzil" value="" readonly style="background: #f1f5f9; border: 2px solid #cbd5e1; border-radius: 8px; padding: 10px; font-weight: 700;">
                            </div>
                            
                            <!-- 2. Difference for Teller 2 (Siam) -->
                            <div class="summary-difference-container" style="background: white; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); border-left: 4px solid #3b82f6;">
                                <span class="diff-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #1e293b;"><i class="fas fa-user-check" style="color: #3b82f6;"></i>Teller 2 Difference:</span>
                                <input type="text" id="target-siam" value="" placeholder="Flexcube Amount" class="receive-target-input" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; transition: all 0.3s;">
                                <input type="text" id="result-siam" value="" readonly style="background: #f1f5f9; border: 2px solid #cbd5e1; border-radius: 8px; padding: 10px; font-weight: 700;">
                            </div>
                            
                            <!-- 3. Difference for Teller 3 (N/A) -->
                            <div class="summary-difference-container" style="background: white; border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06); border-left: 4px solid #ec4899;">
                                <span class="diff-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600; color: #1e293b;"><i class="fas fa-user-check" style="color: #ec4899;"></i>Teller 3 Difference:</span>
                                <input type="text" id="target-na" value="" placeholder="Flexcube Amount" class="receive-target-input" style="border: 2px solid #e2e8f0; border-radius: 8px; padding: 10px; transition: all 0.3s;">
                                <input type="text" id="result-na" value="" readonly style="background: #f1f5f9; border: 2px solid #cbd5e1; border-radius: 8px; padding: 10px; font-weight: 700;">
                            </div>

                            <!-- Clear Button moved to the bottom right of the main content area -->
                            <div style="text-align: right; margin-top: 20px;">
                                <button class="difference-button clear-data-button" id="clear-all-data" style="width: auto; padding: 12px 24px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 10px; font-weight: 700; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem;"><i class="fas fa-trash-alt"></i>Clear All Data</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VAULT PAGE CONTENT (NEW) -->
            <div id="vault-page" class="hidden flex-1 flex flex-col w-full p-4 sm:p-0 items-center">
                 <div class="vault-container w-full">
                    
                    <!-- Professional Page Header -->
                    <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 10px; backdrop-filter: blur(10px);">
                                <i class="fas fa-vault" style="font-size: 1.8rem; color: #fff;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h2 style="font-size: 1.5rem; font-weight: 900; color: #fff; margin: 0; letter-spacing: 0.5px;">Cash Vault Management</h2>
                                <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; margin: 0.25rem 0 0 0;">Secure Denomination Storage & Balance Tracking</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Vault Content Area -->
                    <div class="vault-grid">
                        
                        <!-- LEFT COLUMN: Vault Denomination Counts Input -->
                        <div class="vault-lower-entry-wrapper" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(139, 92, 246, 0.2);">
                            
                            <!-- Denomination Title -->
                            <div class="vault-lower-title" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; padding: 12px; border-radius: 10px; font-weight: 700; text-align: center; margin-bottom: 1rem; box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3); display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <i class="fas fa-coins" style="font-size: 1.1rem;"></i>
                                Vault Denomination Input
                            </div>

                            <!-- Lower Entry Grid -->
                            <div class="vault-lower-entry-grid" id="vault-lower-input-grid" style="gap: 0.75rem;">
                                <!-- Denomination inputs inserted by JS -->
                            </div>
                        </div>
                        
                        <!-- RIGHT COLUMN: Vault Totals Display Table -->
                        <div class="vault-totals-display-wrapper" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <i class="fas fa-table" style="color: #10b981; font-size: 1.1rem;"></i>
                                <h3 style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0;">Vault Balance Summary</h3>
                            </div>
                            <table class="vault-lower-display-table" style="background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);">
                                <thead>
                                    <tr style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                        <th style="color: white; padding: 12px; font-weight: 700; text-align: center;"><i class="fas fa-money-bill" style="margin-right: 6px;"></i>Denomination</th>
                                        <th style="cursor: pointer; color: white; padding: 12px; font-weight: 700; text-align: center;"><i class="fas fa-hashtag" style="margin-right: 6px;"></i>Count</th> 
                                        <th style="color: white; padding: 12px; font-weight: 700; text-align: center;"><i class="fas fa-dollar-sign" style="margin-right: 6px;"></i>Amount</th> 
                                    </tr>
                                </thead>
                                <tbody id="vault-totals-display" style="font-size: 0.95rem;">
                                    <!-- JS will inject rows here -->
                                </tbody>
                            </table>
                        </div>

                    </div>
                    
                </div>
            </div>
            
            <!-- ATM Replenishment Page Content -->
            <div id="atm-replenishment-page" class="hidden flex-1 flex flex-col w-full p-4 sm:p-0">
                <div id="atm-input-page" class="max-w-7xl mx-auto form-container w-full">
                    <!-- Professional Page Header -->
                    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 10px; backdrop-filter: blur(10px);">
                                <i class="fas fa-credit-card" style="font-size: 1.8rem; color: #fff;"></i>
                            </div>
                            <div style="flex: 1;" class="text-center">
                                <h1 style="font-size: 1.6rem; font-weight: 900; color: #fff; margin: 0; letter-spacing: 0.5px;">United Commercial Bank PLC</h1>
                                <h2 style="font-size: 1.3rem; font-weight: 700; color: rgba(255, 255, 255, 0.95); margin: 0.5rem 0 0 0;">ATM Replenishment Form - Data Input</h2>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 mb-6">
                        <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(217, 119, 6, 0.05) 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(245, 158, 11, 0.2);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <i class="fas fa-info-circle" style="color: #f59e0b; font-size: 1.1rem;"></i>
                                <h3 class="font-bold text-lg" style="margin: 0; color: #1e293b;">ATM & Branch Info</h3>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center"><label for="atm-id" class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-hashtag" style="color: #f59e0b; font-size: 0.9rem;"></i>ATM ID:</label><input type="text" id="atm-id" value="UCB KNB-01" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label for="gl-code" class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-file-alt" style="color: #f59e0b; font-size: 0.9rem;"></i>AC:NO (GL Code):</label><input type="text" id="gl-code" value="101010501" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label for="branch-code" class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-code-branch" style="color: #f59e0b; font-size: 0.9rem;"></i>Branch Code:</label><input type="text" id="branch-code" value="187" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label for="atm-location" class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-map-marker-alt" style="color: #f59e0b; font-size: 0.9rem;"></i>ATM Location:</label><input type="text" id="atm-location" value="Kashinathpur, Pabna" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                            </div>
                        </div>
                         <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.05) 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(59, 130, 246, 0.2);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <i class="fas fa-history" style="color: #3b82f6; font-size: 1.1rem;"></i>
                                <h3 class="font-bold text-lg" style="margin: 0; color: #1e293b;">Previous Replenishment</h3>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center"><label class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-calendar" style="color: #3b82f6; font-size: 0.9rem;"></i>Date:</label><input type="date" id="prev_date" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-money-bill-wave" style="color: #3b82f6; font-size: 0.9rem;"></i>Amount:</label><input type="number" id="prev_amount" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" value="0" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-clock" style="color: #3b82f6; font-size: 0.9rem;"></i>Time:</label><input type="time" id="prev_time" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <h3 class="font-bold text-lg text-center underline">1. Reject Box - Notes (E-Journal)</h3>
                            <table id="reject-ejournal-table" class="w-full table-bordered text-center text-sm"><thead><tr><th>Reject Bin</th><th>Denomination</th><th>Notes</th><th>Amount</th></tr></thead><tbody><tr><td>1</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>2</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>3</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>4</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr></tbody><tfoot><tr class="font-bold"><td colspan="2">Total</td><td id="reject-ejournal-total-notes">0</td><td id="reject-ejournal-total-amount">0</td></tr></tfoot></table>
                        </div>
                        <div class="space-y-4">
                            <h3 class="font-bold text-lg text-center underline">2. Cassette - Notes (E-Journal)</h3>
                            <table id="cassette-ejournal-table" class="w-full table-bordered text-center text-sm"><thead><tr><th>Cassette</th><th>Denomination</th><th>Notes</th><th>Amount</th></tr></thead><tbody><tr><td>1</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>2</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>3</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>4</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr></tbody><tfoot><tr class="font-bold"><td colspan="2">Total</td><td id="cassette-ejournal-total-notes">0</td><td id="cassette-ejournal-total-amount">0</td></tr></tfoot></table>
                        </div>
                         <div class="space-y-4">
                            <h3 class="font-bold text-lg text-center underline">3. Reject Box - Notes (Actual)</h3>
                            <table id="reject-actual-table" class="w-full table-bordered text-center text-sm"><thead><tr><th>Reject Bin</th><th>Denomination</th><th>Notes</th><th>Amount</th></tr></thead><tbody><tr><td>1</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>2</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>3</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>4</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr></tbody><tfoot><tr class="font-bold"><td colspan="2">Total</td><td id="reject-actual-total-notes">0</td><td id="reject-actual-total-amount">0</td></tr></tfoot></table>
                        </div>
                        <div class="space-y-4">
                            <h3 class="font-bold text-lg text-center underline">4. Cassette - Notes (Actual)</h3>
                            <table id="cassette-actual-table" class="w-full table-bordered text-center text-sm"><thead><tr><th>Cassette</th><th>Denomination</th><th>Notes</th><th>Amount</th></tr></thead><tbody><tr><td>1</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>2</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>3</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>4</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr></tbody><tfoot><tr class="font-bold"><td colspan="2">Total</td><td id="cassette-actual-total-notes">0</td><td id="cassette-actual-total-amount">0</td></tr></tfoot></table>
                        </div>
                        <div class="space-y-4 md:col-span-2">
                            <h3 class="font-bold text-lg text-center underline">5. Cash Load</h3>
                            <table id="cash-load-table" class="w-full table-bordered text-center text-sm"><thead><tr><th>Cassette</th><th>Denomination</th><th>Notes</th><th>Amount</th></tr></thead><tbody><tr><td>1</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>2</td><td class="denom">500</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>3</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr><tr><td>4</td><td class="denom">1000</td><td><input type="number" value="0" class="w-full text-center p-1 notes atm-input"></td><td class="amount">0</td></tr></tbody><tfoot><tr class="font-bold"><td colspan="2">Total</td><td id="cash-load-total-notes">0</td><td id="cash-load-total-amount">0</td></tr></tfoot></table>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.05) 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(16, 185, 129, 0.2);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <i class="fas fa-balance-scale" style="color: #10b981; font-size: 1.1rem;"></i>
                                <h3 class="font-bold text-lg" style="margin: 0; color: #1e293b;">GL Reconciliation</h3>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center"><label class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-file-invoice" style="color: #10b981; font-size: 0.9rem;"></i>As per ATM GL (C):</label><input type="number" id="atm-gl" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" value="0" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-cash-register" style="color: #10b981; font-size: 0.9rem;"></i>Found Physical Cash (D):</label><span id="physical-cash" class="font-bold text-right w-1/2 p-1" style="color: #10b981;"></span></div>
                                <div class="flex justify-between items-center"><label class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-chart-line" style="color: #10b981; font-size: 0.9rem;"></i>Short/Excess/Zero (D-C):</label><span id="short-excess" class="font-bold text-right w-1/2 p-1" style="color: #10b981;">0</span></div>
                            </div>
                        </div>
                         <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08); border: 1px solid rgba(139, 92, 246, 0.2);">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                                <i class="fas fa-user-shield" style="color: #8b5cf6; font-size: 1.1rem;"></i>
                                <h3 class="font-bold text-lg" style="margin: 0; color: #1e293b;">Custodian Information</h3>
                            </div>
                            <div class="space-y-2">
                                <div class="flex justify-between items-center"><label for="custodian1-name" class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-user" style="color: #8b5cf6; font-size: 0.9rem;"></i>Custodian-1 Name:</label><input type="text" id="custodian1-name" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label for="custodian1-eid" class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-id-badge" style="color: #8b5cf6; font-size: 0.9rem;"></i>Custodian-1 E-ID:</label><input type="text" id="custodian1-eid" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label for="custodian2-name" class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-user" style="color: #8b5cf6; font-size: 0.9rem;"></i>Custodian-2 Name:</label><input type="text" id="custodian2-name" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                                <div class="flex justify-between items-center"><label for="custodian2-eid" class="font-semibold" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-id-badge" style="color: #8b5cf6; font-size: 0.9rem;"></i>Custodian-2 E-ID:</label><input type="text" id="custodian2-eid" class="border-b-2 border-gray-300 text-right w-1/2 p-1 atm-info-input" style="border-radius: 6px; border: 2px solid #e2e8f0; padding: 8px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-8"><button id="generate-report-btn" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 700; padding: 14px 32px; border-radius: 10px; border: none; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 1rem;"><i class="fas fa-file-alt"></i>Generate Report</button></div>
                </div>
                
                <div id="atm-output-page" class="mx-auto mt-4" style="display: none;"></div>
            </div>

            <!-- Electricity Bill Page Content -->
            <div id="electricity-bill-page" class="hidden flex-1 flex flex-col w-full p-4 sm:p-0 items-center">
                <div class="w-full max-w-4xl bg-white p-6 md:p-10 rounded-xl shadow-2xl">
                    <!-- Professional Page Header -->
                    <div style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="background: rgba(255, 255, 255, 0.15); padding: 12px; border-radius: 10px; backdrop-filter: blur(10px);">
                                <i class="fas fa-file-invoice-dollar" style="font-size: 1.8rem; color: #fff;"></i>
                            </div>
                            <div style="flex: 1;">
                                <h2 style="font-size: 1.5rem; font-weight: 900; color: #fff; margin: 0; letter-spacing: 0.5px;">Electricity Bill Processor</h2>
                                <p style="color: rgba(255, 255, 255, 0.9); font-size: 0.9rem; margin: 0.25rem 0 0 0;">Automated Bill Entry & Report Generation</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bill Input Section -->
                    <div id="inputSection" class="w-full p-5 bg-gradient-to-br from-cyan-50 to-blue-50 border border-cyan-200 rounded-xl shadow-xl mb-6">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
                            <i class="fas fa-bolt" style="color: #06b6d4; font-size: 1.1rem;"></i>
                            <h3 style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin: 0;">Bill Information Entry</h3>
                        </div>
                        <!-- Use 4 equal columns on medium+ screens so inputs occupy full row without right-side gap -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                            <div>
                                <label for="billNoInput" class="block text-sm font-medium text-gray-700 mb-1" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-hashtag" style="color: #06b6d4; font-size: 0.9rem;"></i>Bill No.</label>
                                <input type="text" id="billNoInput" class="w-full p-2 border-2 border-cyan-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 text-sm transition">
                            </div>
                            <div>
                                <label for="amountInput" class="block text-sm font-medium text-gray-700 mb-1" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-dollar-sign" style="color: #06b6d4; font-size: 0.9rem;"></i>Amount</label>
                                <input type="number" id="amountInput" oninput="updateCalculatedFields()" class="w-full p-2 border-2 border-cyan-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 text-sm transition">
                            </div>
                            <div>
                                <label for="vatInput" class="block text-sm font-medium text-gray-700 mb-1" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-percent" style="color: #06b6d4; font-size: 0.9rem;"></i>Vat</label>
                                <input type="number" id="vatInput" value="0" class="w-full p-2 border-2 border-cyan-300 rounded-lg focus:ring-cyan-500 focus:border-cyan-500 text-sm transition">
                            </div>
                            <div>
                                <label for="rStampInput" class="block text-sm font-medium text-gray-700 mb-1" style="display: flex; align-items: center; gap: 0.5rem;"><i class="fas fa-stamp" style="color: #06b6d4; font-size: 0.9rem;"></i>R.Stamp</label>
                                <input type="number" id="rStampInput" value="0" class="w-full p-2 border-2 border-gray-300 rounded-lg text-sm bg-gray-100" readonly>
                            </div>
                        </div>
                        <!-- Buttons moved directly below the Bill fields -->
                        <div class="flex gap-4 mt-2 flex-wrap justify-center">
                            <button onclick="addBill()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: 700; padding: 10px 20px; border-radius: 10px; border: none; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-plus-circle"></i>Add Bill
                            </button>
                            <button onclick="clearReport()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; font-weight: 700; padding: 10px 20px; border-radius: 10px; border: none; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-trash-alt"></i>Clear Report
                            </button>
                            <button id="printButton" onclick="printReportSection()" style="background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); color: white; font-weight: 700; padding: 10px 20px; border-radius: 10px; border: none; box-shadow: 0 4px 12px rgba(6, 182, 212, 0.3); cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-print"></i>Print
                            </button>
                        </div>
                        <p id="messageBox" class="mt-3 text-sm font-medium text-red-600"></p>
                    </div>

                    <header class="mb-8 border-b-2 border-red-600 pb-4">
                        <div class="flex flex-col items-center text-center">
                            <div class="w-full">
                                <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">United Commercial Bank PLC</h1>
                                <p class="text-lg font-semibold text-gray-800 mt-1" contenteditable="true" id="branchInfo">Kasinathpur Branch, Santhia, Pabna</p>
                                <p class="text-lg font-semibold text-gray-800 mt-2" contenteditable="true" id="samityInfo">Pabna Palli Biddyut Samity-2</p>
                            </div>
                        </div>
                    </header>

                    <!-- Report Display Section -->
                    <div id="reportContainer" class="border border-gray-400 p-4 rounded-lg shadow-xl">
                        <h2 id="reportDate" class="text-xl font-bold mb-6 text-gray-800 text-center">DATE: <span>--</span></h2>
                        
                        <!-- Totals Grid -->
                        <div class="report-grid mb-6" id="mainTotalsGrid">
                            <div class="border border-black shadow-md">
                                <table class="w-full border-collapse">
                                    <thead><tr><th colspan="2" class="report-table-cell report-table-header bg-gray-200">Grand Total</th></tr></thead>
                                    <tbody id="grandTotalBody">
                                        <tr><td class="report-table-cell text-left font-semibold">Amount</td><td class="report-table-cell text-right" id="totalAmount">0</td></tr>
                                        <tr><td class="report-table-cell text-left font-semibold">Vat</td><td class="report-table-cell text-right" id="totalVat">0</td></tr>
                                        <tr><td class="report-table-cell text-left font-semibold">R.Stamp</td><td class="report-table-cell text-right" id="totalRStamp">0</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="border border-black shadow-md">
                                <table class="w-full border-collapse">
                                    <thead><tr><th colspan="2" class="report-table-cell report-table-header bg-gray-200">Voucher Taka</th></tr></thead>
                                    <tbody id="voucherTakaBody">
                                        <tr><td class="report-table-cell text-left font-semibold">Revenue</td><td class="report-table-cell text-right" id="voucherRevenue">0</td></tr>
                                        <tr><td class="report-table-cell text-left font-semibold">Vat</td><td class="report-table-cell text-right" id="voucherVat">0</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Itemized Bill List: two-column layout on screen (no right gap). Print still uses paged single table. -->
                        <div class="report-grid" id="mainBillList" style="display:flex; gap:0; align-items:flex-start;">
                            <!-- Left column table -->
                            <div class="border border-black shadow-md" style="flex:1; margin:0;">
                                <table class="w-full border-collapse">
                                    <colgroup>
                                        <col style="width:6%;" />
                                        <col style="width:44%;" />
                                        <col style="width:10%;" />
                                        <col style="width:30%;" />
                                        <col style="width:10%;" />
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th class="report-table-cell report-table-header">S/L</th>
                                            <th class="report-table-cell report-table-header">Bill No</th>
                                            <th class="report-table-cell report-table-header">Vat</th>
                                            <th class="report-table-cell report-table-header">Amount</th>
                                            <th class="report-table-cell report-table-header">R.Stamp</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billListRows"></tbody>
                                </table>
                            </div>

                            <!-- Right column table -->
                            <div class="border border-black shadow-md" style="flex:1; margin:0; margin-left:0;">
                                <table class="w-full border-collapse">
                                    <colgroup>
                                        <col style="width:6%;" />
                                        <col style="width:44%;" />
                                        <col style="width:10%;" />
                                        <col style="width:30%;" />
                                        <col style="width:10%;" />
                                    </colgroup>
                                    <thead>
                                        <tr>
                                            <th class="report-table-cell report-table-header">S/L</th>
                                            <th class="report-table-cell report-table-header">Bill No</th>
                                            <th class="report-table-cell report-table-header">Vat</th>
                                            <th class="report-table-cell report-table-header">Amount</th>
                                            <th class="report-table-cell report-table-header">R.Stamp</th>
                                        </tr>
                                    </thead>
                                    <tbody id="billListRowsRight"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Paged Report View Container (Hidden by default) -->
                <div id="pagedReportView" class="hidden w-full max-w-4xl mt-6">
                    <div id="previewControls" class="bg-white p-4 my-4 rounded-lg shadow-xl flex gap-4 justify-center">
                            <button onclick="togglePrintPreview()" class="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg shadow-md hover:bg-red-700 transition duration-150 ease-in-out">
                                <span id="exitButtonText">Exit Print Preview</span>
                            </button>
                            <button onclick="initiateElectricityPrint()" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-150 ease-in-out">
                                Initiate Print
                            </button>
                            <button id="exportPagedReportPdfBtn" class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-150 ease-in-out">Export PDF</button>
                        </div>
                </div>
            </div>

        </section>
    </main>

    <script>
        // --- PERSISTENCE SETUP: LOCAL STORAGE ---
        const appDataKey = 'ucbBankData'; 
        const CASH_FLOW_STORAGE_KEY = 'cashBookEntries'; // Separate key for Cash Flow ledger
        
        const defaultState = {
            denominations: [1000, 500, 200, 100, 50, 20, 10, 5, 2, 1],
            calcInputs: {}, 
            paymentInputs: {},
            inHandInputs: {},
            targetAmount: 0,
            tellerCounts: { tanzil: {}, siam: {}, na: {} },
            flexcubeAmounts: { tanzil: 0, siam: 0, na: 0 },
            vaultLowerCounts: {},
            coinValue: 0,
            vaultFlexcube: 0,
            atmInputs: {
                info: {},
                rejectEjournal: [], 
                cassetteEjournal: [],
                rejectActual: [],
                cassetteActual: [],
                cashLoad: [],
            },
            // Added state variable for current page ID
            currentPage: 'cash-calculator-page',
            // NEW: Transaction History storage
            transactionHistory: [],
            // NEW: Electricity Bill State
            electricityBills: [],
            electricityBranchInfo: "Kasinathpur Branch, Santhia, Pabna",
            electricitySamityInfo: "Pabna Palli Biddyut Samity-2"
        };

        let appData = {};

        function parseNumber(formattedNumber) {
            // Parses a formatted string (with commas) back into a float or returns 0
            const str = String(formattedNumber).replace(/,/g, '');
            if (str === '' || str === null || str === undefined) return 0;
            return parseFloat(str) || 0;
        }
        
        // --- Clipboard Utility ---
        function copyTextToClipboard(text) {
            // Fallback method for copying text
            const dummy = document.createElement('textarea');
            document.body.appendChild(dummy);
            dummy.value = text;
            dummy.select();
            document.execCommand('copy');
            document.body.removeChild(dummy);
        }

        // --- Persistence Functions (localStorage) for Main App Data ---
        function saveDataToLocal() {
            try {
                // 1. Cash Calculator
                document.querySelectorAll('#cash-calculator-page .in-hand-input').forEach(input => {
                    // Save empty string as 0 for consistency in persistence, but UI shows blank
                    const value = parseNumber(input.value);
                    appData.inHandInputs[input.dataset.denomination] = value;
                });
                document.querySelectorAll('#cash-calculator-page .calc-input').forEach(input => {
                    appData.calcInputs[input.dataset.denomination] = parseNumber(input.value);
                });
                document.querySelectorAll('#cash-calculator-page .payment-input').forEach(input => {
                    appData.paymentInputs[input.dataset.denomination] = parseNumber(input.value);
                });
                const targetInput = document.getElementById('targetAmountInput');
                if (targetInput) {
                    const raw = String(targetInput.value).trim();
                    // Preserve blank input as empty string in storage to allow a visible blank field
                    appData.targetAmount = raw === '' ? '' : parseNumber(raw);
                }

                // 2. Cash Receive Targets & Inputs (Teller 2/3 only)
                const targetTanzil = document.getElementById('target-tanzil');
                if (targetTanzil) appData.flexcubeAmounts.tanzil = parseNumber(targetTanzil.value);
                const targetSiam = document.getElementById('target-siam');
                if (targetSiam) appData.flexcubeAmounts.siam = parseNumber(targetSiam.value);
                const targetNa = document.getElementById('target-na');
                if (targetNa) appData.flexcubeAmounts.na = parseNumber(targetNa.value);
                
                // Save Teller 2 and Teller 3 actual counts from inputs
                document.querySelectorAll('#cash-receive-page .cash-receive-input').forEach(input => {
                    const denom = parseInt(input.dataset.denomination);
                    const tellerId = input.dataset.teller;
                    if (tellerId !== 'tanzil') { // Only save inputs for T2 and T3
                         appData.tellerCounts[tellerId][denom] = parseNumber(input.value);
                    }
                });

                // 3. Vault Inputs
                document.querySelectorAll('#vault-lower-input-grid input[type="text"]').forEach(input => {
                    const denom = input.dataset.denomination;
                    appData.vaultLowerCounts[denom] = parseNumber(input.value);
                });

                const coinInput = document.getElementById('vault-coin-amount-input');
                if (coinInput) appData.coinValue = parseNumber(coinInput.value);
                const flexcubeInput = document.getElementById('vault-flexcube-amount-input');
                if (flexcubeInput) appData.vaultFlexcube = parseNumber(flexcubeInput.value);

                // 4. ATM Inputs
                document.querySelectorAll('.atm-info-input').forEach(input => {
                    appData.atmInputs.info[input.id] = input.value;
                });
                
                const tables = ['rejectEjournal', 'cassetteEjournal', 'rejectActual', 'cassetteEjournal', 'cashLoad'];
                const tableIds = ['reject-ejournal-table', 'cassette-ejournal-table', 'reject-actual-table', 'cassette-actual-table', 'cash-load-table'];
                
                tables.forEach((key, tableIndex) => {
                    const table = document.getElementById(tableIds[tableIndex]);
                    if (table) {
                        appData.atmInputs[key] = Array.from(table.querySelectorAll('.notes')).map(input => parseNumber(input.value));
                    }
                });

                // 5. Electricity Bill Data
                appData.electricityBills = collectedBills;
                const branchInfo = document.getElementById('branchInfo');
                const samityInfo = document.getElementById('samityInfo');
                if (branchInfo) appData.electricityBranchInfo = branchInfo.textContent;
                if (samityInfo) appData.electricitySamityInfo = samityInfo.textContent;

                localStorage.setItem(appDataKey, JSON.stringify(appData));
            } catch (error) {
                console.error('Error saving data to local storage:', error);
            }
        }

        function loadDataFromLocal() {
            try {
                const storedData = localStorage.getItem(appDataKey);
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Merge loaded data with defaults to ensure all keys exist
                    appData = { ...defaultState, ...parsedData };
                    // Handle nested objects that might be null in old storage
                    appData.tellerCounts = { ...defaultState.tellerCounts, ...parsedData.tellerCounts };
                    appData.flexcubeAmounts = { ...defaultState.flexcubeAmounts, ...parsedData.flexcubeAmounts };
                    appData.atmInputs = { ...defaultState.atmInputs, ...parsedData.atmInputs };
                    // Ensure transactionHistory is array
                    appData.transactionHistory = parsedData.transactionHistory || [];
                    // Ensure electricity bills is array
                    appData.electricityBills = parsedData.electricityBills || [];
                } else {
                    appData = defaultState;
                }
            } catch (error) {
                console.error('Error loading data from local storage, using default state:', error);
                appData = defaultState;
            }
        }

        // --- Function to apply loaded data to the UI ---
        function applyLoadedDataToUI() {
            // 1. Cash Calculator
            document.querySelectorAll('#cash-calculator-page .in-hand-input').forEach(input => {
                const denom = input.dataset.denomination;
                // If the loaded value is 0, display blank, otherwise display the value
                const loadedValue = appData.inHandInputs[denom] || 0;
                input.value = loadedValue === 0 ? '' : loadedValue;
            });
            document.querySelectorAll('#cash-calculator-page .calc-input').forEach(input => {
                const denom = input.dataset.denomination;
                input.value = appData.calcInputs[denom] || 0;
            });
            document.querySelectorAll('#cash-calculator-page .payment-input').forEach(input => {
                const denom = input.dataset.denomination;
                input.value = appData.paymentInputs[denom] || 0;
            });
            const targetInput = document.getElementById('targetAmountInput');
            if (targetInput) targetInput.value = appData.targetAmount === '' ? '' : (appData.targetAmount || 0);
            
            // 2. Cash Receive Targets
            const targetTanzil = document.getElementById('target-tanzil');
            if (targetTanzil) targetTanzil.value = appData.flexcubeAmounts.tanzil || '';
            const targetSiam = document.getElementById('target-siam');
            if (targetSiam) targetSiam.value = appData.flexcubeAmounts.siam || '';
            const targetNa = document.getElementById('target-na');
            if (targetNa) targetNa.value = appData.flexcubeAmounts.na || '';
            
            // 3. ATM Inputs
            document.querySelectorAll('.atm-info-input').forEach(input => {
                if (appData.atmInputs.info[input.id] !== undefined) {
                    input.value = appData.atmInputs.info[input.id];
                }
            });

            const tables = ['rejectEjournal', 'cassetteEjournal', 'rejectActual', 'cassetteActual', 'cashLoad'];
            const tableIds = ['reject-ejournal-table', 'cassette-ejournal-table', 'reject-actual-table', 'cassette-actual-table', 'cash-load-table'];
            
            tables.forEach((key, tableIndex) => {
                const table = document.getElementById(tableIds[tableIndex]);
                const savedNotes = appData.atmInputs[key];
                if (table && savedNotes && savedNotes.length > 0) {
                    table.querySelectorAll('.notes').forEach((input, index) => {
                        input.value = savedNotes[index] || 0;
                    });
                }
            });
            
            // 5. Electricity Bill Data
            if (appData.electricityBills && appData.electricityBills.length > 0) {
                collectedBills = appData.electricityBills;
            }
            
            const branchInfo = document.getElementById('branchInfo');
            const samityInfo = document.getElementById('samityInfo');
            if (branchInfo && appData.electricityBranchInfo) {
                branchInfo.textContent = appData.electricityBranchInfo;
            }
            if (samityInfo && appData.electricitySamityInfo) {
                samityInfo.textContent = appData.electricitySamityInfo;
            }
            
            // Recalculate everything after setting base inputs
            updateAndSaveCalculatorState();
            window.atm_calculateAllInputTotals();
            // Render recent transactions once after loading UI state
            renderRecentTransactions();
            
            // Render the electricity bill if we're on that page
            if (document.getElementById('electricity-bill-page') && !document.getElementById('electricity-bill-page').classList.contains('hidden')) {
                renderReport();
            }

            // Update cash flow current balance display in calculator UI
            try { updateCashCalculatorCurrentBalance(); } catch (e) { console.warn('Could not update cash calculator current balance on load', e); }
        }


        // --- Global Formatting ---
        const formatter = new Intl.NumberFormat('en-US');
        function formatNumber(number) {
            return formatter.format(number);
        }
        /**
         * Format amounts for print/export: if the value is a whole number, show without decimals
         * otherwise show exactly two decimals. Uses the same thousands separator as formatNumber.
         */
        function formatAmountForPrint(value) {
            const n = Number(value) || 0;
            if (Number.isInteger(n)) return formatNumber(n);
            // ensure two decimals for fractional amounts
            return n.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        
        // --- Page Navigation Function ---
        function showPage(pageId) {
            const pages = ['cash-calculator-page', 'cash-flow-page', 'atm-replenishment-page', 'cash-receive-page', 'vault-page', 'electricity-bill-page', 'cash-calculator-print-output'];
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (page) {
                    page.classList.toggle('hidden', id !== pageId);
                }
            });
            // Trigger Cash Flow initialization/render if navigating to it
            if (pageId === 'cash-flow-page') {
                cashFlowInitializeData();
            }

            // Initialize electricity bill when accessed
            if (pageId === 'electricity-bill-page') {
                renderReport();
            }

            // Update global state for persistence (only for main input pages)
            if (pageId !== 'cash-calculator-print-output' && pageId !== 'atm-output-page') {
                appData.currentPage = pageId;
                saveDataToLocal();
            }
            
            // Ensure ATM input page is visible if ATM is selected
            if (pageId === 'atm-replenishment-page') {
                const atmInputPage = document.getElementById('atm-input-page');
                const atmOutputPage = document.getElementById('atm-output-page');
                if (atmInputPage && atmOutputPage) {
                    atmInputPage.style.display = 'block';
                    atmOutputPage.style.display = 'none';
                }
            }
        }
        
        // --- Sidebar Toggle Function ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (!sidebar) return;
            const menuIcon = document.getElementById('menuIcon');
            
            const isHidden = sidebar.classList.toggle('hidden');

            // Toggle visual state of the hamburger icon (if present)
            if (menuIcon) menuIcon.classList.toggle('menu-icon-active', !isHidden);

            // Adjust main content layout (responsive handling)
            const mainContentArea = document.getElementById('mainContentArea');
            if (window.innerWidth >= 768) {
                // Desktop/Tablet: Use padding/gap classes
                if (isHidden) {
                    mainContentArea.classList.add('p-0');
                    mainContentArea.classList.remove('p-6', 'gap-6');
                } else {
                    mainContentArea.classList.remove('p-0');
                    mainContentArea.classList.add('p-6', 'gap-6');
                }
            } else {
                // Mobile: Sidebar handles position: fixed
                if (!isHidden) {
                    // Prevent main content from scrolling while menu is open
                    document.body.style.overflow = 'hidden';
                } else {
                     document.body.style.overflow = '';
                }
            }
        }
        
        // --- ATM Replenishment Functions (minimal changes, only save on input) ---
        window.atm_showPage = function(pageName) {
            const atmInputPage = document.getElementById('atm-input-page');
            const atmOutputPage = document.getElementById('atm-output-page');
            if (atmInputPage) atmInputPage.style.display = pageName === 'input' ? 'block' : 'none';
            if (atmOutputPage) atmOutputPage.style.display = pageName === 'output' ? 'block' : 'none';
            if (pageName === 'output') window.scrollTo(0, 0);
        }

        window.atm_calculateTableTotals = function(tableId, totalNotesId, totalAmountId) {
            let totalNotes = 0, totalAmount = 0;
            document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => {
                const denomElement = row.querySelector('.denom');
                const notesElement = row.querySelector('.notes');
                const amountElement = row.querySelector('.amount');
                
                if (denomElement && notesElement && amountElement) {
                    const denom = parseNumber(denomElement.textContent) || 0;
                    const notes = parseNumber(notesElement.value);
                    const amount = denom * notes;
                    
                    amountElement.textContent = formatNumber(amount);
                    totalNotes += notes;
                    totalAmount += amount;
                }
            });
            const totalNotesEl = document.getElementById(totalNotesId);
            const totalAmountEl = document.getElementById(totalAmountId);
            
            if (totalNotesEl) totalNotesEl.textContent = formatNumber(totalNotes);
            if (totalAmountEl) totalAmountEl.textContent = formatNumber(totalAmount);
            
            return { totalNotes, totalAmount };
        }

        window.atm_calculateAllInputTotals = function() {
            const cassetteActual = window.atm_calculateTableTotals('cassette-actual-table', 'cassette-actual-total-notes', 'cassette-actual-total-amount');
            window.atm_calculateTableTotals('cassette-ejournal-table', 'cassette-ejournal-total-notes', 'cassette-ejournal-total-amount');
            const rejectActual = window.atm_calculateTableTotals('reject-actual-table', 'reject-actual-total-notes', 'reject-actual-total-amount');
            window.atm_calculateTableTotals('reject-ejournal-table', 'reject-ejournal-total-notes', 'reject-ejournal-total-amount');
            window.atm_calculateTableTotals('cash-load-table', 'cash-load-total-notes', 'cash-load-total-amount');
            
            const physicalCashAmount = cassetteActual.totalAmount + rejectActual.totalAmount;
            const physicalCashEl = document.getElementById('physical-cash');
            if (physicalCashEl) physicalCashEl.textContent = formatNumber(physicalCashAmount);
            
            const atmGlEl = document.getElementById('atm-gl');
            const shortExcessEl = document.getElementById('short-excess');
            if (atmGlEl && shortExcessEl) {
                const atmGl = parseNumber(atmGlEl.value);
                shortExcessEl.textContent = formatNumber(physicalCashAmount - atmGl);
            }
            saveDataToLocal(); // Save ATM state immediately
        }
        
        window.atm_populateOutputPage = function() {
            // ... (HTML generation logic remains the same) ...
            const atmId = document.getElementById('atm-id').value;
            const glCode = document.getElementById('gl-code').value;
            const branchCode = document.getElementById('branch-code').value;
            const atmLocation = document.getElementById('atm-location').value;

            const prevDate = document.getElementById('prev_date').value ? new Date(document.getElementById('prev_date').value).toLocaleDateString('en-GB').replace(/\//g, '.') : '';
            const prevAmount = formatAmountForPrint(parseNumber(document.getElementById('prev_amount').value) || 0);
            const prevTimeValue = document.getElementById('prev_time').value;
            let prevTime = '';
            if (prevTimeValue) {
                const [hours, minutes] = prevTimeValue.split(':');
                const date = new Date();
                date.setHours(hours);
                date.setMinutes(minutes);
                prevTime = date.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
            }

            const now = new Date();
            const currentDate = now.toLocaleDateString('en-GB').replace(/\//g, '.');
            const currentTime = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: 'numeric', hour12: true });
            
            let cashLoadTotalAmountEl = document.getElementById('cash-load-total-amount');
            let cashLoadTotalNotesEl = document.getElementById('cash-load-total-notes');
            
            const currentAmount = formatAmountForPrint(parseNumber(cashLoadTotalAmountEl ? cashLoadTotalAmountEl.textContent : '0') || 0);
            const cashLoadNotes = cashLoadTotalNotesEl ? cashLoadTotalNotesEl.textContent : '0';
            const cashLoadAmount = formatAmountForPrint(parseNumber(cashLoadTotalAmountEl ? cashLoadTotalAmountEl.textContent : '0') || 0);


            let cassetteRowsHtml = '';
            const cassetteActualRows = document.querySelectorAll('#cassette-actual-table tbody tr');
            const cassetteEjournalRows = document.querySelectorAll('#cassette-ejournal-table tbody tr');
            const cashLoadRows = document.querySelectorAll('#cash-load-table tbody tr');
            for (let i = 0; i < cassetteActualRows.length; i++) {
                const beforeDenom = cassetteActualRows[i].querySelector('.denom').textContent;
                const beforeNotesActual = cassetteActualRows[i].querySelector('.notes').value;
                const beforeNotesEjournal = cassetteEjournalRows[i].querySelector('.notes').value;
                const beforeAmountActual = parseNumber(beforeDenom) * parseNumber(beforeNotesActual || 0);
                const beforeAmountEjournal = parseNumber(beforeDenom) * parseNumber(beforeNotesEjournal || 0);
                const loadNotes = cashLoadRows[i].querySelector('.notes').value;
                const loadAmount = parseNumber(cashLoadRows[i].querySelector('.denom').textContent) * parseNumber(loadNotes || 0);
                cassetteRowsHtml += `<tr><td class="p-1 text-left">Cassette ${i+1}</td><td>${beforeDenom}</td><td>${beforeNotesActual}</td><td>${beforeAmountActual.toLocaleString()}</td><td>${beforeNotesEjournal}</td><td>${beforeAmountEjournal.toLocaleString()}</td><td>${loadNotes}</td><td>${loadAmount.toLocaleString()}</td></tr>`;
            }

            let rejectRowsHtml = '';
            const rejectActualRows = document.querySelectorAll('#reject-actual-table tbody tr');
            const rejectEjournalRows = document.querySelectorAll('#reject-ejournal-table tbody tr');
            for (let i = 0; i < rejectActualRows.length; i++) {
                const denom = rejectActualRows[i].querySelector('.denom').textContent;
                const notesActual = rejectActualRows[i].querySelector('.notes').value;
                const notesEjournal = rejectEjournalRows[i].querySelector('.notes').value;
                const amountActual = parseNumber(denom) * parseNumber(notesActual || 0);
                const amountEjournal = parseNumber(denom) * parseNumber(notesEjournal || 0);
                rejectRowsHtml += `<tr><td class="p-1 text-left">Reject Bin C-${i+1}</td><td>${denom}</td><td>${notesActual}</td><td>${amountActual.toLocaleString()}</td><td>${notesEjournal}</td><td>${amountEjournal.toLocaleString()}</td><td></td><td></td></tr>`;
            }

            const retractRowsHtml = `
                <tr><td class="p-1 text-left">Retract-1</td><td>100</td><td>0</td><td>0</td><td>0</td><td>0</td><td></td><td></td></tr>
                <tr><td class="p-1 text-left">Retract-2</td><td>500</td><td>0</td><td>0</td><td>0</td><td>0</td><td></td><td></td></tr>
                <tr><td class="p-1 text-left">Retract-3</td><td>1000</td><td>0</td><td>0</td><td>0</td><td>0</td><td></td><td></td></tr>
            `;
            
            const cassetteActualTotalNotes = document.getElementById('cassette-actual-total-notes').textContent;
            const cassetteEjournalTotalNotes = document.getElementById('cassette-ejournal-total-notes').textContent;
            const cassetteActualTotalAmount = formatAmountForPrint(parseNumber(document.getElementById('cassette-actual-total-amount').textContent) || 0);
            const cassetteEjournalTotalAmount = formatNumber(parseNumber(document.getElementById('cassette-ejournal-total-amount').textContent) || 0);

            const rejectActualTotalNotes = document.getElementById('reject-actual-total-notes').textContent;
            const rejectEjournalTotalNotes = document.getElementById('reject-ejournal-total-notes').textContent;
            const rejectActualTotalAmount = (parseNumber(document.getElementById('reject-actual-total-amount').textContent) || 0).toLocaleString();
            const rejectEjournalTotalAmount = (parseNumber(document.getElementById('reject-ejournal-total-amount').textContent) || 0).toLocaleString();
            
            const subTotalBNotesActual = parseNumber(rejectActualTotalNotes);
            const subTotalBNotesEjournal = parseNumber(rejectEjournalTotalNotes);
            const subTotalBAmountActual = (parseNumber(rejectActualTotalAmount) || 0).toLocaleString();
            const subTotalBAmountEjournal = (parseNumber(rejectEjournalTotalAmount) || 0).toLocaleString();

            const cashLoadTotalNotes = document.getElementById('cash-load-total-notes').textContent;
            
            const grandTotalNotesActual = (parseNumber(cassetteActualTotalNotes) + subTotalBNotesActual).toLocaleString();
            const grandTotalNotesEjournal = (parseNumber(cassetteEjournalTotalNotes) + subTotalBNotesEjournal).toLocaleString();
            
            const cassetteActualTotalAmountInt = parseNumber(cassetteActualTotalAmount);
            const subTotalBAmountActualInt = parseNumber(subTotalBAmountActual);
            const grandTotalAmountActual = formatAmountForPrint(cassetteActualTotalAmountInt + subTotalBAmountActualInt);

            const cassetteEjournalTotalAmountInt = parseNumber(cassetteEjournalTotalAmount);
            const subTotalBAmountEjournalInt = parseNumber(subTotalBAmountEjournal);
            const grandTotalAmountEjournal = (cassetteEjournalTotalAmountInt + subTotalBAmountEjournalInt).toLocaleString();
            
            const atmGl = formatAmountForPrint(parseNumber(document.getElementById('atm-gl').value) || 0);
            const physicalCash = formatAmountForPrint(parseNumber(document.getElementById('physical-cash').textContent) || 0);
            
            const shortExcessValue = parseNumber(document.getElementById('short-excess').textContent);
            const shortExcessText = formatAmountForPrint(shortExcessValue);
            
            let shortExcessLabel = '';
            if (shortExcessValue < 0) {
                shortExcessLabel = '<b>Short</b>/excess/zero(D-C)';
            } else if (shortExcessValue > 0) {
                shortExcessLabel = 'Short/<b>excess</b>/zero(D-C)';
            } else {
                shortExcessLabel = 'Short/excess/<b>zero</b>(D-C)';
            }
            
            const isShort = shortExcessValue < 0;
            const shortAmount = isShort ? formatAmountForPrint(Math.abs(shortExcessValue)) : formatAmountForPrint(0);
            const excessAmount = !isShort && shortExcessValue > 0 ? formatAmountForPrint(Math.abs(shortExcessValue)) : formatAmountForPrint(0);
            
            const custodian1Name = document.getElementById('custodian1-name').value;
            const custodian1Eid = document.getElementById('custodian1-eid').value;
            const custodian2Name = document.getElementById('custodian2-name').value;
            const custodian2Eid = document.getElementById('custodian2-eid').value;

            const atmOutputPage = document.getElementById('atm-output-page');
            if (atmOutputPage) {
                atmOutputPage.innerHTML = `
                    <style>
                        /* Final export: readable, printable sizes for ATM output */
                        .atm-output * { box-sizing: border-box; }
                        .atm-output { font-size: 10pt; line-height: 1.12; font-family: 'Times New Roman', serif; color: #111; }
                        .atm-output table, .atm-output td, .atm-output th { font-size: 9pt; }
                        .atm-output table { border-collapse: collapse; }
                        /* Thicker borders for printed boxes to match sample */
                        .atm-output .table-bordered td, .atm-output .table-bordered th { padding: 6px 8px; border: 2px solid #000; }
                        /* Letterhead styles */
                        .atm-output h1, .atm-output .text-2xl {
                            font-family: 'Times New Roman', 'Georgia', serif !important;
                            font-size: 34pt !important;
                            line-height: 1.02 !important;
                            font-weight: 900 !important;
                            letter-spacing: 1px !important;
                            text-transform: uppercase !important;
                            margin: 0 0 10pt 0 !important;
                        }
                        .atm-output p.text-2xl {
                            font-family: 'Times New Roman', 'Georgia', serif !important;
                            font-size: 20pt !important;
                            line-height: 1.06 !important;
                            font-weight: 700 !important;
                            margin: 0 0 18pt 0 !important;
                        }
                        .atm-output .text-lg { font-size: 12pt; line-height: 1.08; }
                        .atm-output .atm-info-table { border-collapse: collapse; width:100%; border: 1px solid #000; table-layout: fixed; }
                        .atm-output .atm-info-table td { padding: 6px 8px !important; vertical-align: middle; border-left: 1px solid #000; border-right: 1px solid #000; }
                        .atm-output .atm-info-table tr:first-child td { border-top:1px solid #000; }
                        .atm-output .atm-info-table tr:last-child td { border-bottom:1px solid #000; }
                        .atm-output .atm-info-table td.label { width: 70%; text-align:left; font-weight:700; font-size:11pt; padding-left:10px; overflow-wrap:break-word; word-break:break-word; white-space:normal; }
                        .atm-output .atm-info-table td.amount { width: 30%; text-align:right; white-space:nowrap; font-variant-numeric: tabular-nums; font-weight:700; font-size:10pt; padding-right:12px; }
                        .atm-output .cust-sign-box { height: 36px; padding: 6px; width: 160px; font-size: 10pt; }

                        /* Top info row: distribute three boxes across the width */
                        .atm-top-row { display:flex; justify-content:space-between; gap:4px; align-items:flex-start; margin-bottom:4px; }
                        .atm-top-row .box { border:1px solid #000; padding:2px 4px; min-width:90px; font-size:9pt; }
                        .atm-top-row .box.center { text-align:center; flex:1 1 200px; }
                        .atm-top-row .box.left { flex:1 1 160px; }

                        /* Replenishment details: two centered boxes */
                        .replenish-grid { display:flex; gap:8px; justify-content:center; align-items:flex-start; margin-bottom:4px; }
                        .replenish-box { border:1px solid #000; padding:6px 8px; width:46%; box-sizing:border-box; font-size:10pt; }
                        .replenish-box h3 { font-weight:700; margin-bottom:2px; text-align:left; font-size:10pt; }

                        /* Print-only overrides: make boxes larger on printed page */
                        @media print {
                            .atm-output { font-size: 11pt !important; }
                            /* Reduce label size and force wrapping in print to avoid overlap */
                            .atm-output .atm-info-table td.label {
                                font-size:10pt !important;
                                padding-left:10px !important;
                                overflow-wrap:break-word !important;
                                word-break:break-word !important;
                                white-space:normal !important;
                            }
                            .atm-output .atm-info-table td.amount { font-size:11pt !important; padding-right:16px !important; }
                            .atm-top-row .box { padding:6px 8px !important; min-width:120px !important; font-size:11pt !important; }
                            .replenish-box { padding:10px 12px !important; width:48% !important; font-size:11pt !important; }
                            .atm-output .cust-sign-box { height:42px !important; width:180px !important; }
                        }
                        .replenish-box table { width:100%; border-collapse:collapse; }
                        .replenish-box td { border: none; padding:2px 4px; }
                        .replenish-box td.label { text-align:left; font-weight:600; font-size:9pt; }
                        .replenish-box td.value { text-align:center; font-weight:700; font-size:11pt; }

                        /* Make amounts bold and large in the main cash status footer rows */
                        .atm-output .font-semibold { font-weight:800; }

                        .atm-output .text-center { text-align: center; }
                        .atm-output .text-right { text-align: right; }
                        .atm-output .w-48 { width: 120px; }
                        .atm-output .p-1 { padding: 4px; }
                        .atm-output .p-2 { padding: 8px; }
                        .atm-output .mt-16 { margin-top: 12px; }
                        .atm-output .mt-8 { margin-top: 8px; }
                        .atm-output .mb-6 { margin-bottom: 8px; }
                        .atm-output h3, .atm-output h1, .atm-output p { margin: 0; padding: 0; }
                    </style>
                    <div class="text-center mb-6">
                        <div class="atm-output">
                        <h1 class="text-2xl font-bold tracking-wider">UNITED COMMERCIAL BANK PLC</h1>
                        <p class="text-2xl mt-2 tracking-wide">ATM REPLENISHMENT FORM</p>
                    </div>
                    <div class="atm-top-row text-sm">
                        <div class="box left">ATM ID: <strong>${atmId}</strong></div>
                        <div class="box center">AC:NO <div style="margin-top:6px; font-weight:800;">${glCode}</div></div>
                        <div class="box" style="text-align:left;">
                            <div style="margin-bottom:4px;"><strong>Branch Code:</strong> ${branchCode}</div>
                            <div><strong>ATM Location:</strong> ${atmLocation}</div>
                        </div>
                    </div>
                    <div class="replenish-grid">
                        <div class="replenish-box">
                            <h3>Current Replenishment Details:</h3>
                            <table>
                                <tr><td class="label">Replenishment date</td><td class="value">${currentDate}</td></tr>
                                <tr><td class="label">Replenishment Amount</td><td class="value">${currentAmount}</td></tr>
                                <tr><td class="label">Replenishment Time</td><td class="value">${currentTime}</td></tr>
                            </table>
                        </div>
                        <div class="replenish-box">
                            <h3>Previous Replenishment Details:</h3>
                            <table>
                                <tr><td class="label">Replenishment Date</td><td class="value">${prevDate}</td></tr>
                                <tr><td class="label">Replenishment Amount</td><td class="value">${prevAmount}</td></tr>
                                <tr><td class="label">Replenishment Time</td><td class="value">${prevTime}</td></tr>
                            </table>
                        </div>
                    </div>
                    
                    <h3 class="font-bold text-center my-2">Cash Status (Actual & Receipt paper/E-journal)</h3>
                    <table class="w-full table-bordered text-center text-xs table-fixed">
                         <colgroup>
                            <col style="width: 15%;">
                            <col style="width: 12.1%;">
                            <col style="width: 12.1%;">
                            <col style="width: 12.1%;">
                            <col style="width: 12.1%;">
                            <col style="width: 12.1%;">
                            <col style="width: 12.1%;">
                            <col style="width: 12.1%;">
                        </colgroup>
                        <thead>
                            <tr class="font-bold"><td colspan="6">Before cash loading</td><td colspan="2">After cash loading</td></tr>
                            <tr><td>Particular</td><td>Denomination</td><td>No. of notes (Actual)</td><td>Amount</td><td>No of notes (Receipt/ Ejournal)</td><td>Amount</td><td>No. of notes (Actual)</td><td>Amount</td></tr>
                            <tr><td>A</td><td>B</td><td>C</td><td>D</td><td>E</td><td>F</td><td>G</td><td>H</td></tr>
                        </thead>
                        <tbody>
                            ${cassetteRowsHtml}
                            <tr class="font-bold"><td class="text-left p-1">Sub Total Tk. (A)</td><td></td><td>${cassetteActualTotalNotes}</td><td>${cassetteActualTotalAmount}</td><td>${cassetteEjournalTotalNotes}</td><td>${cassetteEjournalTotalAmount}</td><td>${cashLoadNotes}</td><td>${cashLoadAmount}</td></tr>
                            ${rejectRowsHtml}
                            ${retractRowsHtml}
                            <tr class="font-bold"><td class="text-left p-1">Sub Total Tk. (B)</td><td></td><td>${subTotalBNotesActual.toLocaleString()}</td><td>${formatAmountForPrint(parseNumber(subTotalBAmountActual))}</td><td>${subTotalBNotesEjournal.toLocaleString()}</td><td>${subTotalBAmountEjournal}</td><td></td><td></td></tr>
                            <tr class="font-bold"><td class="text-left p-1">Gr. Total Tk.(A+B)</td><td></td><td>${grandTotalNotesActual}</td><td>${grandTotalAmountActual}</td><td>${grandTotalNotesEjournal}</td><td>${grandTotalAmountEjournal}</td><td>${cashLoadNotes}</td><td>${cashLoadAmount}</td></tr>
                        </tbody>
                    </table>
                    
                    <div class="grid grid-cols-2 gap-4 mt-4 atm-export-grid" style="grid-template-columns: 45% 1fr;">
                        <div>
                            <table class="w-full text-sm atm-info-table">
                                <colgroup>
                                    <col style="width:70%" />
                                    <col style="width:30%" />
                                </colgroup>
                                <tr><td class="border border-black label">As per ATM GL (C)</td><td class="border border-black amount">${atmGl}</td></tr>
                                <tr><td class="border border-black label">Found physical cash(D)</td><td class="border border-black amount">${physicalCash}</td></tr>
                                <tr><td class="border border-black label">${shortExcessLabel}</td><td class="border border-black amount">${shortExcessText}</td></tr>
                            </table>
                        </div>
                        <div class="space-y-2 w-full flex justify-end">
                            <!-- Excess / Short Posting Procedures (compact, right column) -->
                            <div style="width:280px; margin-left: auto;" class="grid grid-cols-1 gap-3">
                                <table class="w-full table-bordered text-sm table-fixed" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th colspan="3" class="text-center font-bold p-1">In case of Excess found in ATM</th>
                                        </tr>
                                        <tr>
                                            <th class="p-1 w-[60%]" colspan="2">Posting procedure</th>
                                            <th class="p-1 w-[40%] text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="p-1 text-left">DR ATM GL</td>
                                            <td class="p-1 text-center">${glCode}</td>
                                            <td class="p-1 text-right font-semibold">${excessAmount}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-1 text-left">CR Cash in Excess_ATM</td>
                                            <td class="p-1 text-center">205103007</td>
                                            <td class="p-1 text-right font-semibold">${excessAmount}</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <table class="w-full table-bordered text-sm table-fixed" style="width:100%;">
                                    <thead>
                                        <tr>
                                            <th colspan="3" class="text-center font-bold p-1">In case of Short found in ATM</th>
                                        </tr>
                                        <tr>
                                            <th class="p-1 w-[60%]" colspan="2">Posting procedure</th>
                                            <th class="p-1 w-[40%] text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="p-1 text-left">DR Cash in Short_ATM</td>
                                            <td class="p-1 text-center">125270141</td>
                                            <td class="p-1 text-right font-semibold">${shortAmount}</td>
                                        </tr>
                                        <tr>
                                            <td class="p-1 text-left">CR ATM GL</td>
                                            <td class="p-1 text-center">${glCode}</td>
                                            <td class="p-1 text-right font-semibold">${shortAmount}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between items-end mt-16 text-sm">
                        <div class="text-left">
                            <p class="font-bold">Custodian-1</p>
                            <p>Name: ${custodian1Name}</p>
                            <p>E-ID: ${custodian1Eid}</p>
                            <div class="border border-black h-14 mt-1 p-1 w-48 cust-sign-box">Sign:</div>
                        </div>
                        <div class="text-left">
                            <p class="font-bold">Custodian-2</p>
                            <p>Name: ${custodian2Name}</p>
                            <p>E-ID: ${custodian2Eid}</p>
                            <div class="border border-black h-14 mt-1 p-1 w-48 cust-sign-box">Sign:</div>
                        </div>
                        <div class="text-left">
                            <p class="font-bold">OM/HOB</p>
                             <p class="invisible">Name:</p>
                            <p class="invisible">E-ID:</p>
                            <div class="border border-black h-14 mt-1 p-1 w-48 cust-sign-box">Sign:</div>
                        </div>
                    </div>

                    <!-- Buttons removed: Generate Report will print directly -->
                    </div> <!-- .atm-output end -->
                `;
                
                // Remove interactive UI controls that should not appear for direct printing
                const toRemoveUi = atmOutputPage.querySelectorAll('#back-to-input-btn, #print-btn, #back-to-input-btn-print, #print-btn-print, #exportPdfBtn-print, .no-print, .print-only');
                toRemoveUi.forEach(n => { try { n.remove(); } catch(e) {} });

                // Print only the ATM output: temporarily hide other printable containers (like Teller Report) before printing
                const atmPrintHandler = () => {
                    try {
                        const otherSelectors = ['#cash-calculator-print-output', '#pagedReportView'];
                        const prevStates = [];
                        otherSelectors.forEach(sel => {
                            const el = document.querySelector(sel);
                            if (el) {
                                prevStates.push({ el, display: el.style.display });
                                el.style.display = 'none';
                            }
                        });
                        // Ensure atm output is visible
                        if (atmOutputPage) atmOutputPage.style.display = 'block';

                        // Give the browser a moment to repaint before opening print dialog
                        setTimeout(() => {
                            window.print();
                            // restore previous display states after print dialog closes
                            prevStates.forEach(s => { s.el.style.display = s.display; });
                        }, 60);
                    } catch (err) {
                        console.error('ATM print failed to prepare:', err);
                        window.print();
                    }
                };

                // Invoke print immediately for direct-print behavior (Generate Report -> Print)
                atmPrintHandler();
            }
        }
        // --- End of ATM Replenishment Functions ---


        // --- Cash Calculator Page Data and Utility ---
        
    const calcInputs = document.querySelectorAll('.calc-input');
    const calcOutputs = document.querySelectorAll('.calc-amount');
        const paymentInputs = document.querySelectorAll('.payment-input');
        const inHandInputs = document.querySelectorAll('.in-hand-input');
        
        // NEW: Function to render recent transactions
        function renderRecentTransactions() {
            const listContainer = document.getElementById('recent-transactions-list');
            if (!listContainer) return;
            
            // Clear existing content
            listContainer.innerHTML = '';

                // Sort history by time (newest first) and show ALL entries in the recent list
                const recent = (appData.transactionHistory || [])
                    .slice() // clone to avoid mutating original
                    .sort((a, b) => b.timestamp - a.timestamp);

                if (recent.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-sm text-gray-500 py-4">No recent transactions.</p>`;
                    return;
                }

                // Make the container scrollable when long (apply inline styles here in case page doesn't include dedicated CSS)
                listContainer.style.maxHeight = '320px';
                listContainer.style.overflowY = 'auto';
                listContainer.style.paddingRight = '8px';

                recent.forEach((tx, idx) => {
                const typeText = tx.type === 'received' ? 'Rcvd' : 'Paid';
                const typeClass = tx.type === 'received' ? 'recent-received' : 'recent-payment';
                const amountSign = tx.type === 'received' ? '+' : '-';
                const amountColor = tx.type === 'received' ? 'text-green-800' : 'text-red-800';
                
                const displayTime = new Date(tx.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });
                const item = document.createElement('div');
                // Make the first (newest) transaction stand out
                const firstItemClasses = idx === 0 ? 'recent-transaction-first' : '';
                item.className = `recent-transaction-item ${typeClass} ${firstItemClasses}`;
                // Accessibility: make each row keyboard focusable and announceable
                item.setAttribute('tabindex', '0');
                item.setAttribute('role', 'button');
                item.setAttribute('aria-expanded', 'false');
                item.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-baseline gap-3">
                            <span class="${idx === 0 ? 'text-xl font-extrabold' : 'font-bold'}">${displayTime}</span>
                            <span class="${idx === 0 ? 'text-sm font-extrabold' : 'text-xs font-medium'}">${typeText}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div>
                                <span class="${idx === 0 ? 'text-xl font-extrabold' : 'font-extrabold'} ${amountColor}">${amountSign} ${formatNumber(tx.totalAmount)}</span>
                            </div>
                            <svg class="recent-chevron w-4 h-4 transition-transform duration-200" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </div>
                    </div>
                `;

                // Build a hidden details block that shows denomination breakdown for this transaction
                const details = document.createElement('div');
                // start collapsed; animation will use the `expanded` class
                details.className = 'recent-transaction-details text-sm mt-2';
                if (tx.denominations && Object.keys(tx.denominations).length > 0) {
                    const rows = Object.keys(tx.denominations).sort((a,b) => parseInt(b) - parseInt(a)).map(den => {
                        const cnt = tx.denominations[den];
                        const amt = (parseInt(den) * parseNumber(cnt)) || 0;
                        return `<div class="flex justify-between"><span>${formatNumber(parseInt(den))} x ${formatNumber(cnt)}</span><span>${formatNumber(amt)}</span></div>`;
                    }).join('');
                    details.innerHTML = rows;
                } else {
                    details.textContent = 'No denomination details recorded.';
                }

                // Toggle details on click with accordion behavior (close others) and rotate chevron
                // Use inline max-height to smoothly animate to/from content height
                details.addEventListener('transitionend', () => {
                    // after opening, clear maxHeight so content can grow dynamically
                    if (details.classList.contains('expanded')) {
                        details.style.maxHeight = 'none';
                    }
                });

                item.addEventListener('click', (ev) => {
                    ev.stopPropagation();

                    // Close any other expanded details in the list
                    const otherDetails = listContainer.querySelectorAll('.recent-transaction-details.expanded');
                    otherDetails.forEach(d => {
                        if (d !== details) {
                            d.classList.remove('expanded');
                            d.style.maxHeight = '0px';
                            const prevItem = d.previousElementSibling;
                            if (prevItem) {
                                prevItem.setAttribute('aria-expanded', 'false');
                                const chev = prevItem.querySelector('.recent-chevron');
                                if (chev) chev.classList.remove('chev-rotated');
                            }
                        }
                    });

                    const willOpen = !details.classList.contains('expanded');
                    if (willOpen) {
                        details.classList.add('expanded');
                        // set explicit maxHeight to allow transition from 0 to scrollHeight
                        details.style.maxHeight = details.scrollHeight + 'px';
                    } else {
                        // collapse
                        details.classList.remove('expanded');
                        // set maxHeight to measured height first if it's 'none'
                        if (details.style.maxHeight === 'none' || details.style.maxHeight === '') {
                            details.style.maxHeight = details.scrollHeight + 'px';
                            // force repaint
                            // eslint-disable-next-line no-unused-expressions
                            details.offsetHeight;
                        }
                        details.style.maxHeight = '0px';
                    }

                    item.setAttribute('aria-expanded', willOpen ? 'true' : 'false');

                    // rotate the chevron in this item
                    const chevron = item.querySelector('.recent-chevron');
                    if (chevron) chevron.classList.toggle('chev-rotated', willOpen);
                });

                // Keyboard support: Enter or Space toggles the details
                item.addEventListener('keydown', (ev) => {
                    if (ev.key === 'Enter' || ev.key === ' ' || ev.key === 'Spacebar') {
                        ev.preventDefault();
                        // simulate click
                        item.click();
                    }
                });

                listContainer.appendChild(item);
                listContainer.appendChild(details);
            });
        }

        // NEW: Function to update In Hand Calculation amounts
        function updateInHandCalculationAmounts() {
            let total = 0;
            const amountOutputs = document.querySelectorAll('.in-hand-amount-output');

            inHandInputs.forEach((input, index) => {
                const denomination = parseInt(input.dataset.denomination);
                const count = parseNumber(input.value);
                const amount = denomination * count;
                
                if (amountOutputs[index]) {
                    const newText = formatNumber(amount);
                    if (amountOutputs[index].dataset.prev !== newText) {
                        amountOutputs[index].textContent = newText;
                        amountOutputs[index].classList.remove('amount-glow');
                        void amountOutputs[index].offsetWidth;
                        amountOutputs[index].classList.add('amount-glow');
                        amountOutputs[index].dataset.prev = newText;
                    } else {
                        amountOutputs[index].textContent = newText;
                    }
                }
                
                total += amount;
            });

            const inHandCalcTotal = document.getElementById('inHandCalcTotal');
            if (inHandCalcTotal) {
                const newText = formatNumber(total);
                if (inHandCalcTotal.dataset.prev !== newText) {
                    inHandCalcTotal.textContent = newText;
                    // animate
                    inHandCalcTotal.classList.remove('flash-pulse');
                    void inHandCalcTotal.offsetWidth;
                    inHandCalcTotal.classList.add('flash-pulse');
                    inHandCalcTotal.dataset.prev = newText;
                } else {
                    inHandCalcTotal.textContent = newText;
                }
            }
        }

        function updateReceivedTotal() {
            let total = 0;
            calcInputs.forEach((input, index) => {
                const denomination = parseInt(input.dataset.denomination);
                const count = parseNumber(input.value);
                const amount = denomination * count;
                const newCalcText = formatNumber(amount);
                if (calcOutputs[index]) {
                    if (calcOutputs[index].dataset.prev !== newCalcText) {
                        calcOutputs[index].textContent = newCalcText;
                        calcOutputs[index].classList.remove('amount-glow');
                        void calcOutputs[index].offsetWidth;
                        calcOutputs[index].classList.add('amount-glow');
                        calcOutputs[index].dataset.prev = newCalcText;
                    } else {
                        calcOutputs[index].textContent = newCalcText;
                    }
                }
                total += amount;
            });
            const totalReceivedSpan = document.getElementById('totalReceived');
            if (totalReceivedSpan) {
                const newText = formatNumber(total);
                // only trigger animation when value actually changes
                if (totalReceivedSpan.dataset.prev !== newText) {
                    totalReceivedSpan.textContent = newText;
                    // remove any flash variants first
                    totalReceivedSpan.classList.remove('value-flash', 'value-flash-received', 'value-flash-payment');
                    // trigger reflow to restart animation
                    void totalReceivedSpan.offsetWidth;
                    totalReceivedSpan.classList.add('value-flash-received');
                    totalReceivedSpan.dataset.prev = newText;

                    // pulse the panel container briefly
                    const panel = totalReceivedSpan.closest('.section-box');
                    if (panel) {
                        panel.classList.remove('panel-pulse');
                        void panel.offsetWidth;
                        panel.classList.add('panel-pulse');
                        // remove the panel-pulse after animation ends
                        setTimeout(() => panel.classList.remove('panel-pulse'), 600);
                    }
                } else {
                    totalReceivedSpan.textContent = newText;
                }
            }
            updateInHandTotal();
            updateInHandDenominations();
            window.syncCalculatorToReceive(); 
        }

        function updatePaymentTotal() {
            let total = 0;
            paymentInputs.forEach((input, index) => {
                const denomination = parseInt(input.dataset.denomination);
                const count = parseNumber(input.value);
                const amount = denomination * count;
                const paymentOutputs = document.querySelectorAll('.payment-amount');
                const newPayText = formatNumber(amount);
                if (paymentOutputs[index]) {
                   if (paymentOutputs[index].dataset.prev !== newPayText) {
                       paymentOutputs[index].textContent = newPayText;
                       paymentOutputs[index].classList.remove('amount-glow');
                       void paymentOutputs[index].offsetWidth;
                       paymentOutputs[index].classList.add('amount-glow');
                       paymentOutputs[index].dataset.prev = newPayText;
                   } else {
                       paymentOutputs[index].textContent = newPayText;
                   }
                }
                total += amount;
            });
            const totalPaymentSpan = document.getElementById('totalPayment');
            if (totalPaymentSpan) {
                const newText = formatNumber(total);
                if (totalPaymentSpan.dataset.prev !== newText) {
                    totalPaymentSpan.textContent = newText;
                    totalPaymentSpan.classList.remove('value-flash', 'value-flash-received', 'value-flash-payment');
                    void totalPaymentSpan.offsetWidth;
                    totalPaymentSpan.classList.add('value-flash-payment');
                    totalPaymentSpan.dataset.prev = newText;

                    const panel = totalPaymentSpan.closest('.section-box');
                    if (panel) {
                        panel.classList.remove('panel-pulse');
                        void panel.offsetWidth;
                        panel.classList.add('panel-pulse');
                        setTimeout(() => panel.classList.remove('panel-pulse'), 600);
                    }
                } else {
                    totalPaymentSpan.textContent = newText;
                }
            }
            updateInHandTotal();
            updateInHandDenominations();
            window.syncCalculatorToReceive(); 
        }

        function calculateInHand() {
            // NOTE: This function is now mostly handled by updateInHandCalculationAmounts() 
            // but is kept to trigger the amount calculation and ensure the total updates.
            updateInHandCalculationAmounts();
        }
        
        function resetInHand() {
            inHandInputs.forEach(input => input.value = ''); // Reset to blank
            updateAndSaveCalculatorState(); // Calls wrapper functions
        }

        function updateInHandDenominations() {
            const inHandDenoOutputs = document.querySelectorAll('#cash-calculator-page .in-hand-deno-output');
            const denominations = appData.denominations; // Use appData.denominations
            if (!denominations) return; // safety check

            const receivedCounts = {};
            calcInputs.forEach(input => {
                receivedCounts[input.dataset.denomination] = parseNumber(input.value);
            });

            const paymentCounts = {};
            paymentInputs.forEach(input => {
                paymentCounts[input.dataset.denomination] = parseNumber(input.value);
            });

            const netCounts = {};
            denominations.forEach(denom => {
                const rCount = receivedCounts[denom] || 0;
                const pCount = paymentCounts[denom] || 0;
                
                // The net count shown in the middle panel is ONLY (Received) - (Payment)
                const netChangeCount = rCount - pCount;
                netCounts[denom] = netChangeCount; 
            });

            inHandDenoOutputs.forEach(outputEl => {
                const denomination = parseInt(outputEl.dataset.denomination);
                const netCount = netCounts[denomination] !== undefined ? netCounts[denomination] : 0;
                outputEl.textContent = formatNumber(netCount);
            });
            
            // Update per-denomination amount cells as well
            const denoAmountEls = document.querySelectorAll('.in-hand-deno-amount');
            denoAmountEls.forEach((amtEl, idx) => {
                const denom = parseInt(amtEl.dataset.denomination);
                const cnt = netCounts[denom] || 0;
                const amt = denom * cnt;
                const newText = formatNumber(amt);
                if (amtEl.dataset.prev !== newText) {
                    amtEl.textContent = newText;
                    amtEl.classList.remove('amount-glow');
                    void amtEl.offsetWidth;
                    amtEl.classList.add('amount-glow');
                    amtEl.dataset.prev = newText;
                } else {
                    amtEl.textContent = newText;
                }
            });

            updateInHandTotal();
        }

        window.syncCalculatorToReceive = function() {
            const inHandDenoOutputs = document.querySelectorAll('#cash-calculator-page .in-hand-deno-output');
            const teller1Cells = document.querySelectorAll('#cash-receive-page .cash-receive-teller1-link');
            const denominations = appData.denominations; // Use appData.denominations
            
            if (inHandDenoOutputs.length === 0 || teller1Cells.length === 0 || !denominations) return;

            const inHandDenoMap = {};
            inHandDenoOutputs.forEach(outputEl => {
                const denomination = outputEl.dataset.denomination;
                const count = parseNumber(outputEl.textContent);
                inHandDenoMap[denomination] = count;
            });
            
            // Update appData.tellerCounts.tanzil for persistence
            denominations.forEach(denom => {
                appData.tellerCounts.tanzil[denom] = inHandDenoMap[denom] || 0;
            });


            teller1Cells.forEach(cell => {
                const denomination = cell.dataset.denomination;
                const count = inHandDenoMap[denomination] !== undefined ? inHandDenoMap[denomination] : 0;
                cell.textContent = formatNumber(count);
            });
            
            window.receive_calculateTotals();
        }

        
        function updateInHandTotal() {
            const inHandTotalSpan = document.getElementById('inHandTotal');
            const targetAmountInput = document.getElementById('targetAmountInput'); 
            const differenceResult = document.getElementById('differenceResult'); 
            
            let inHandTotal = 0;
            
            // *** MODIFIED LOGIC: Total In Hand (Blue Box) = Sum of Net Denominations (Rcv - Pay) only ***
            // This ensures the blue total is entirely separate from the "In Hand Calculation" input.
            const inHandDenoOutputs = document.querySelectorAll('.in-hand-deno-output');
            
            inHandDenoOutputs.forEach(outputEl => {
                const denomination = parseInt(outputEl.dataset.denomination);
                // The net count is Rcv - Pay, calculated in updateInHandDenominations()
                const netCount = parseNumber(outputEl.textContent); 
                inHandTotal += denomination * netCount;
            });
            // *** END MODIFIED LOGIC ***


            // Ensure the UI displays the correct total and animate on change
            if (inHandTotalSpan) {
                const newText = formatNumber(inHandTotal);
                if (inHandTotalSpan.dataset.prev !== newText) {
                    inHandTotalSpan.textContent = newText;
                    inHandTotalSpan.classList.remove('flash-pop');
                    void inHandTotalSpan.offsetWidth;
                    inHandTotalSpan.classList.add('flash-pop');
                    inHandTotalSpan.dataset.prev = newText;
                } else {
                    inHandTotalSpan.textContent = newText;
                }
                // Update card state (positive / negative / neutral) based on comparison to target
                const totalCard = document.querySelector('.in-hand-total-card');
                if (totalCard && targetAmountInput) {
                    const raw = String(targetAmountInput.value).trim();
                    const targetVal = raw === '' ? null : parseNumber(raw);
                    totalCard.classList.remove('positive','negative','neutral');
                    if (targetVal === null) {
                        totalCard.classList.add('neutral');
                    } else if (inHandTotal > targetVal) {
                        totalCard.classList.add('positive');
                    } else if (inHandTotal < targetVal) {
                        totalCard.classList.add('negative');
                    } else {
                        totalCard.classList.add('neutral');
                    }
                }
            }
            
            if (targetAmountInput) {
                calculateDifference();
            } else {
                if (differenceResult) differenceResult.textContent = formatNumber(0);
            }
        }

        function calculateDifference() {
            const inHandTotalSpan = document.getElementById('inHandTotal');
            const targetAmountInput = document.getElementById('targetAmountInput'); 
            const differenceResult = document.getElementById('differenceResult'); 

            const inHand = parseNumber(inHandTotalSpan ? inHandTotalSpan.textContent : '0');
            // Use the same formula as the printed report: TOTAL NET CASH - Current Cash Balance (Ledger) - Flexcube Amount
            const ledger = (typeof computeCurrentCashBalance === 'function') ? computeCurrentCashBalance() : 0;
            const raw = targetAmountInput ? String(targetAmountInput.value).trim() : '';
            const flexcubeAmount = raw === '' ? 0 : parseNumber(raw);
            let difference = inHand - ledger - (isNaN(flexcubeAmount) ? 0 : flexcubeAmount);

            if (differenceResult) {
                const newText = formatNumber(difference);
                // only animate when value changed
                if (differenceResult.dataset.prev !== newText) {
                    differenceResult.textContent = newText;
                    // color class update (positive -> green, negative -> red, zero -> neutral)
                    differenceResult.classList.remove('text-red-600', 'text-green-600', 'text-gray-800');
                    if (difference > 0) {
                        differenceResult.classList.add('text-green-600');
                    } else if (difference < 0) {
                        differenceResult.classList.add('text-red-600');
                    } else {
                        differenceResult.classList.add('text-gray-800');
                    }
                    // animate pop
                    differenceResult.classList.remove('flash-pop');
                    void differenceResult.offsetWidth;
                    differenceResult.classList.add('flash-pop');
                    // flash the target input briefly when its interpreted value changes
                    if (targetAmountInput) {
                        const displayKey = raw === '' ? '__blank__' : String(parseNumber(raw) || raw);
                        if (targetAmountInput.dataset.prev !== displayKey) {
                            targetAmountInput.classList.remove('flash-pulse');
                            void targetAmountInput.offsetWidth;
                            targetAmountInput.classList.add('flash-pulse');
                            targetAmountInput.dataset.prev = displayKey;
                        }
                    }
                    differenceResult.dataset.prev = newText;
                } else {
                    differenceResult.textContent = newText;
                }
            }
                // Update the below-label that indicates To be Pay / To be Receive based on ledger
                try {
                    const labelEl = document.getElementById('differenceLabel');
                    if (labelEl) {
                        // Use the cash flow ledger current balance to decide wording (same as print logic)
                        const ledger = (typeof computeCurrentCashBalance === 'function') ? computeCurrentCashBalance() : 0;
                        if (ledger > 0) {
                            labelEl.textContent = `To be Pay: ${formatNumber(ledger)}`;
                            labelEl.className = 'text-sm font-semibold text-green-700';
                        } else if (ledger < 0) {
                            labelEl.textContent = `To be Receive: ${formatNumber(ledger)}`;
                            labelEl.className = 'text-sm font-semibold text-red-700';
                        } else {
                            labelEl.textContent = 'Current';
                            labelEl.className = 'text-sm font-semibold text-gray-700';
                        }
                    }
                } catch (err) {
                    console.warn('Could not update differenceLabel', err);
                }

            try { updateDifferenceLabel(); } catch (e) {}
            saveDataToLocal(); // Save target amount
        }

        function addCountsToSection(sourceInputs, targetInputs, type) {
            let totalAmount = 0;
            const denominations = {};
            const totalInHandCalculationValue = document.getElementById('inHandCalcTotal').textContent;
            
            sourceInputs.forEach(sourceInput => {
                const denomination = parseInt(sourceInput.dataset.denomination);
                const countToAdd = parseNumber(sourceInput.value);
                
                if (countToAdd > 0) {
                    totalAmount += denomination * countToAdd;
                    denominations[denomination] = countToAdd;
                }
                
                targetInputs.forEach(targetInput => {
                    if (targetInput.dataset.denomination === String(denomination)) {
                        const currentCount = parseNumber(targetInput.value);
                        targetInput.value = currentCount + countToAdd;
                    }
                });
            });

            // 1. Record Transaction History
            if (totalAmount > 0) {
                appData.transactionHistory.push({
                    type: type === 'calcInputs' ? 'received' : 'payment',
                    totalAmount: totalAmount,
                    timestamp: Date.now(),
                    denominations: denominations
                });
            }
            
            resetInHand(); 
            updateAndSaveCalculatorState(); // Calls wrapper function
            
            // 2. Copy the transaction total (formatted). If there's no transaction amount, fall back to the displayed in-hand total.
            try {
                if (totalAmount && totalAmount > 0) {
                    copyTextToClipboard(formatNumber(totalAmount));
                } else if (totalInHandCalculationValue) {
                    copyTextToClipboard(totalInHandCalculationValue);
                }
            } catch (e) {
                // ignore clipboard errors
            }
            
            // 3. Re-render recent transactions
            renderRecentTransactions();
        }
        
        function updateAndSaveCalculatorState() {
            updateInHandCalculationAmounts(); // NEW: Triggers calculation for the first column
            updateReceivedTotal();
            updatePaymentTotal();
            // calculateInHand(); // Redundant now, covered by updateInHandCalculationAmounts
            updateInHandDenominations(); // Recalculates final 'In Hand Denomination' counts (Rcv - Pay)
            calculateDifference();
            // NOTE: renderRecentTransactions is intentionally NOT called here to avoid
            // reflow/blink when users type in the calculator. The list is rendered on
            // load and whenever a new transaction is recorded (see addCountsToSection).
            saveDataToLocal();
        }

        // Utility: copy text to clipboard with fallback
        function copyTextToClipboard(text) {
            if (!text && text !== "0") return;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text.toString()).catch(() => {
                    // ignore clipboard errors
                });
            } else {
                const ta = document.createElement('textarea');
                ta.value = text.toString();
                ta.style.position = 'fixed';
                ta.style.opacity = '0';
                document.body.appendChild(ta);
                ta.select();
                try { document.execCommand('copy'); } catch (e) {}
                document.body.removeChild(ta);
            }
        }

    // Single toggle for Received & Payment panels with animated collapse/expand
        (function initRecvPayToggle(){
            const btn = document.getElementById('toggle-recv-pay-btn');
            const recv = document.getElementById('received-panel');
            const pay = document.getElementById('payment-panel');
            if (!btn || !recv || !pay) return;

            const STORAGE_KEY = 'ucb_recv_pay_collapsed';
            const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

            // Accessibility: ensure the toggle is keyboard focusable and has proper ARIA
            btn.setAttribute('tabindex', '0');
            btn.setAttribute('role', 'button');
            if (!btn.hasAttribute('aria-pressed')) btn.setAttribute('aria-pressed', 'false');
            // Key handling for Enter / Space
            btn.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter' || ev.key === ' ' || ev.key === 'Spacebar') {
                    ev.preventDefault();
                    btn.click();
                }
            });

            function animatePanel(panel, collapse) {
                // If reduced motion, just toggle instantly
                if (prefersReduced) {
                    if (collapse) panel.classList.add('hidden'); else panel.classList.remove('hidden');
                    return;
                }

                // Ensure panel is visible for measurements when expanding
                if (!collapse) {
                    panel.classList.remove('hidden');
                    // start from 0
                    panel.style.overflow = 'hidden';
                    panel.style.maxHeight = '0px';
                    panel.style.opacity = '0';
                    panel.style.transform = 'translateY(-6px)';
                    // force layout
                    void panel.offsetHeight;
                    const to = panel.scrollHeight + 'px';
                    panel.style.transition = 'max-height 420ms cubic-bezier(0.2,0,0,1), opacity 320ms ease, transform 420ms cubic-bezier(0.2,0,0,1)';
                    panel.style.maxHeight = to;
                    panel.style.opacity = '1';
                    panel.style.transform = 'translateY(0)';
                    const onEnd = (e) => {
                        if (e.propertyName === 'max-height') {
                            panel.style.maxHeight = '';
                            panel.style.overflow = '';
                            panel.style.transition = '';
                            panel.removeEventListener('transitionend', onEnd);
                        }
                    };
                    panel.addEventListener('transitionend', onEnd);
                } else {
                    // collapse
                    panel.style.overflow = 'hidden';
                    // set current height explicitly
                    panel.style.maxHeight = panel.scrollHeight + 'px';
                    // force layout
                    void panel.offsetHeight;
                    panel.style.transition = 'max-height 420ms cubic-bezier(0.2,0,0,1), opacity 320ms ease, transform 420ms cubic-bezier(0.2,0,0,1)';
                    panel.style.maxHeight = '0px';
                    panel.style.opacity = '0';
                    panel.style.transform = 'translateY(-6px)';
                    const onEnd = (e) => {
                        if (e.propertyName === 'max-height') {
                            panel.classList.add('hidden');
                            panel.style.maxHeight = '';
                            panel.style.overflow = '';
                            panel.style.transition = '';
                            panel.style.opacity = '';
                            panel.style.transform = '';
                            panel.removeEventListener('transitionend', onEnd);
                        }
                    };
                    panel.addEventListener('transitionend', onEnd);
                }
            }

            function applyState(collapsed){
                const label = btn.querySelector('.toggle-recv-pay-label');
                const chev = btn.querySelector('.toggle-chevron');
                if (collapsed) {
                    animatePanel(recv, true);
                    animatePanel(pay, true);
                    if (label) label.textContent = 'Show Received & Payment';
                    btn.setAttribute('aria-pressed', 'true');
                    if (chev) chev.classList.remove('chev-rotated');
                } else {
                    animatePanel(recv, false);
                    animatePanel(pay, false);
                    if (label) label.textContent = 'Hide Received & Payment';
                    btn.setAttribute('aria-pressed', 'false');
                    if (chev) chev.classList.add('chev-rotated');
                }
// ...existing code...
            }

            // Load saved state
            let saved = false;
            try { saved = JSON.parse(localStorage.getItem(STORAGE_KEY)) || false; } catch(e) { saved = false; }
            applyState(saved);

            btn.addEventListener('click', () => {
                const isCollapsed = recv.classList.contains('hidden') && pay.classList.contains('hidden');
                const nextCollapsed = !isCollapsed;
                applyState(nextCollapsed);
                try { localStorage.setItem(STORAGE_KEY, JSON.stringify(nextCollapsed)); } catch(e){}
            });
        })();
        
        /* --- In Hand section styling moved to static <style> in head to avoid FOUC --- */
        
        // --- CASH CALCULATOR PRINT LOGIC ---
        
        // Helper to load external scripts dynamically
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                if (document.querySelector(`script[src="${src}"]`)) return resolve();
                const s = document.createElement('script');
                s.src = src;
                s.onload = () => resolve();
                s.onerror = (e) => reject(e);
                document.head.appendChild(s);
            });
        }

        // Helper: generate PDF from a DOM element using html2pdf (loads library if needed)
        async function generatePdfFromElement(element, filename = 'report.pdf', options = {}) {
            // options: { fitToOnePage: boolean }
            if (!element) throw new Error('No element to export');
            try {
                // Offline: load local copy of html2pdf. Put the file at js/html2pdf.bundle.min.js
                await loadScript('js/html2pdf.bundle.min.js');
            } catch (e) {
                console.error('Failed to load html2pdf:', e);
                alert('Could not load PDF generator library. Please try Print instead.');
                return;
            }

            // Default PDF options
            const marginMm = 10; // matches previous margin usage
            const opt = {
                margin: [marginMm, marginMm, marginMm, marginMm],
                filename: filename,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // If requested, render the element as a single image and add it to one A4 PDF page
            if (options.fitToOnePage) {
                try {
                    // Render the full element to canvas at its natural size
                    const renderScale = Math.max(1, window.devicePixelRatio || 1);
                    const canvas = await html2canvas(element, Object.assign({}, opt.html2canvas, {
                        useCORS: true,
                        scale: renderScale,
                        width: Math.max(element.scrollWidth, element.offsetWidth),
                        height: Math.max(element.scrollHeight, element.offsetHeight),
                        windowWidth: Math.max(element.scrollWidth, element.offsetWidth),
                        windowHeight: Math.max(element.scrollHeight, element.offsetHeight)
                    }));
                    const imgData = canvas.toDataURL('image/jpeg', 0.98);

                    // Compute A4 printable area in pixels (consider device pixel ratio)
                    const dpi = 96 * (window.devicePixelRatio || 1);
                    const mmToIn = 1 / 25.4;
                    const pageWidthMm = 210 - (marginMm * 2);
                    const pageHeightMm = 297 - (marginMm * 2);
                    const pageWidthPx = Math.round(pageWidthMm * mmToIn * dpi);
                    const pageHeightPx = Math.round(pageHeightMm * mmToIn * dpi);

                    // Create a jsPDF instance with pixel units and A4 size in px
                    const pdf = new jsPDF({ unit: 'px', format: [pageWidthPx + 0, pageHeightPx + 0], orientation: 'portrait' });

                    // Compute shrink-only scale to ensure the entire canvas fits into a single A4 printable area
                    // (do not upscale beyond 1)
                    const computedScale = Math.min(pageWidthPx / canvas.width, pageHeightPx / canvas.height);
                    const scale = Math.min(1, computedScale);
                    const imgW = Math.round(canvas.width * scale);
                    const imgH = Math.round(canvas.height * scale);
                    const x = Math.round((pageWidthPx - imgW) / 2);
                    const y = Math.round((pageHeightPx - imgH) / 2);

                    pdf.addImage(imgData, 'JPEG', x, y, imgW, imgH, undefined, 'FAST');
                    pdf.save(filename);
                    return;
                } catch (e) {
                    console.error('Fit-to-one-page export failed, falling back to html2pdf:', e);
                }
            }

            // Default multi-page exporter (html2pdf)
            try {
                await html2pdf().set(opt).from(element).save();
            } catch (err) {
                console.error('PDF generation failed:', err);
                alert('PDF generation failed. Try printing instead.');
            }
        }

        // Print report. If exportPdf is true, generate and download a PDF instead of opening print dialog.
    // exportPdf: when true, generate and download a PDF file
    // directPrint: when true, immediately open the print dialog without showing the preview
    window.cashCalculatorPrintReport = async function(exportPdf = false, directPrint = false) {
            const outputContainer = document.getElementById('cash-calculator-print-output');
            if (!outputContainer) return;

            // 1. Get Calculator Data
            const inHandDenos = Array.from(document.querySelectorAll('#cash-calculator-page .in-hand-deno-output')).map(el => ({
                denom: parseInt(el.dataset.denomination),
                count: parseNumber(el.textContent)
            })).filter(item => item.count !== 0);

            const inHandTotalValue = parseNumber(document.getElementById('inHandTotal').textContent.replace(/,/g, ''));
            const flexcubeAmount = parseNumber(document.getElementById('targetAmountInput').value);
            const difference = parseNumber(document.getElementById('differenceResult').textContent.replace(/,/g, ''));
            
            // 2. Get Cash Flow Data (Balance Breakdown & Current Cash Balance)
            const entries = cashFlowGetEntries();
            let currentBalance = 0;
            let nameBalances = {};
            
            // Recalculate Cash Flow totals
            entries.forEach(entry => {
                const isReceipt = entry.type === 'receipt';
                const amount = entry.type === 'receipt' ? entry.amount : -entry.amount;
                currentBalance += amount;
                
                const name = entry.description;
                if (!nameBalances[name]) {
                    nameBalances[name] = 0;
                }
                nameBalances[name] += amount;
            });
            
            // *** START MODIFICATION FOR PRINT REPORT BALANCE BREAKDOWN ***
            // Filter out zero balances for printing
            const nonZeroNameBalances = Object.keys(nameBalances)
                .filter(name => Math.abs(nameBalances[name]) > 0.001)
                .reduce((acc, name) => {
                    acc[name] = nameBalances[name];
                    return acc;
                }, {});

            // --- HTML Generation for Printing ---
            
            // Compute printed difference as: TOTAL NET CASH - Current Cash Balance (Ledger) - Flexcube Amount
            const printedDifference = inHandTotalValue - currentBalance - flexcubeAmount;
            const diffClass = printedDifference < 0 ? 'teller-diff-negative' : (printedDifference > 0 ? 'teller-diff-positive' : 'text-gray-800');

            // Determine ledger label and color based on currentBalance sign
            const ledgerLabel = currentBalance > 0 ? 'To be Pay:' : (currentBalance < 0 ? 'To be Receive:' : 'Current Cash Balance (Ledger):');
            const ledgerLabelClass = currentBalance > 0 ? 'teller-diff-positive' : (currentBalance < 0 ? 'teller-diff-negative' : 'text-gray-800');

            // New reconciliation rows to inject into the table footer (ORDERED to match requested layout)
            const reconciliationRowsHtml = `
                <tr>
                    <td colspan="2" class="py-2 px-2 text-right text-lg font-extrabold">TOTAL NET CASH:</td>
                    <td class="py-2 px-2 teller-amount">${formatNumber(inHandTotalValue)}</td>
                </tr>
                <tr>
                    <td colspan="2" class="py-1 px-2 text-right font-bold ${ledgerLabelClass}">${ledgerLabel}</td>
                    <td class="py-1 px-2 teller-amount ${ledgerLabelClass}">${formatNumber(currentBalance)}</td>
                </tr>
                <tr>
                    <td colspan="2" class="py-1 px-2 text-right font-bold">Flexcube Amount:</td>
                    <td class="py-1 px-2 teller-amount">${formatNumber(flexcubeAmount)}</td>
                </tr>
                <tr><td colspan="3" style="border-top:1px solid #111827; padding-top:8px;"></td></tr>
                <tr class="">
                    <td colspan="2" class="py-3 px-2 text-right text-lg font-extrabold">Difference:</td>
                    <td class="py-3 px-2 text-right text-lg font-extrabold ${diffClass}">${formatNumber(printedDifference)}</td>
                </tr>
            `;

            let inHandTableHtml = `
                <h2 class="text-xl font-bold mb-3 text-red-800">In Hand Denomination</h2>
                ${inHandDenos.length > 0 ? `
                    <table class="w-full text-sm">
                        <thead class="font-bold border-b border-gray-400"><tr><td class="py-1 w-1/3">Denomination</td><td class="py-1 w-1/3 text-right">Count</td><td class="py-1 w-1/3 text-right">Amount</td></tr></thead>
                        <tbody>
                        ${inHandDenos.map(item => `
                            <tr class="border-b border-gray-200">
                                <td class="py-1 px-2">${formatNumber(item.denom)}</td>
                                <td class="py-1 px-2 text-right">${formatNumber(item.count)}</td>
                                <td class="py-1 px-2 text-right">${formatNumber(item.denom * item.count)}</td>
                            </tr>
                        `).join('')}
                        </tbody>
                        <tfoot>
                            ${reconciliationRowsHtml}
                        </tfoot>
                    </table>
                ` : '<p class="text-sm italic">No net denominations currently in hand.</p>'}
            `;

            // Split balances into Payable (positive amounts) and Receivable (negative amounts)
            const payable = [];
            const receivable = [];
            Object.keys(nonZeroNameBalances).sort().forEach(name => {
                const val = nonZeroNameBalances[name];
                if (val > 0.001) payable.push({ name, amount: val });
                else if (val < -0.001) receivable.push({ name, amount: Math.abs(val) });
            });

            const payableTotal = payable.reduce((s, it) => s + it.amount, 0);
            const receivableTotal = receivable.reduce((s, it) => s + it.amount, 0);

            let payableHtml = '';
            if (payable.length > 0) {
                payableHtml = `
                    <div class="w-full md:w-1/2 pr-2">
                        <h3 class="font-bold">Payable</h3>
                        <table class="w-full text-sm">
                            <thead class="font-bold border-b border-gray-400"><tr><td class="py-1">Name</td><td class="py-1 text-right">Amount</td></tr></thead>
                            <tbody>
                                ${payable.map(p => `
                                    <tr class="border-b border-gray-200"><td class="py-1 px-2">${p.name}</td><td class="py-1 px-2 text-right font-semibold">${formatNumber(p.amount)}</td></tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr><td class="py-1 px-2 text-right font-bold">Total Payable:</td><td class="py-1 px-2 text-right font-extrabold">${formatNumber(payableTotal)}</td></tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            }

            let receivableHtml = '';
            if (receivable.length > 0) {
                receivableHtml = `
                    <div class="w-full md:w-1/2 pl-2">
                        <h3 class="font-bold">Receivable</h3>
                        <table class="w-full text-sm">
                            <thead class="font-bold border-b border-gray-400"><tr><td class="py-1">Name</td><td class="py-1 text-right">Amount</td></tr></thead>
                            <tbody>
                                ${receivable.map(r => `
                                    <tr class="border-b border-gray-200"><td class="py-1 px-2">${r.name}</td><td class="py-1 px-2 text-right font-semibold">${formatNumber(r.amount)}</td></tr>
                                `).join('')}
                            </tbody>
                            <tfoot>
                                <tr><td class="py-1 px-2 text-right font-bold">Total Receivable:</td><td class="py-1 px-2 text-right font-extrabold">${formatNumber(receivableTotal)}</td></tr>
                            </tfoot>
                        </table>
                    </div>
                `;
            }

            let balanceBreakdownHtml = `
                <h2 class="text-xl font-bold mb-3 text-red-800">Balance Breakdown (By Name)</h2>
                ${payableHtml || receivableHtml ? `
                    <div class="flex flex-col md:flex-row gap-4">
                        ${payableHtml}
                        ${receivableHtml}
                    </div>
                ` : '<p class="text-sm italic">No outstanding cash flow balances found.</p>'}
            `;
            // *** END MODIFICATION FOR PRINT REPORT BALANCE BREAKDOWN ***

            outputContainer.innerHTML = `
                <style>
                    /* Print-specific overrides for the Teller Report preview */
                    .teller-print-container { font-family: Arial, Helvetica, sans-serif; color: #111827; }
                    .teller-print-container h1 { font-size: 20px; letter-spacing: 0.5px; }
                    .teller-print-table { width: 100%; border-collapse: collapse; }
                    .teller-print-table th, .teller-print-table td { padding: 6px 8px; }
                    .teller-print-table thead th { font-weight: 700; border-bottom: 2px solid #d1d5db; }
                    .teller-print-table tbody tr { border-bottom: 1px solid #e5e7eb; }
                    .teller-print-table tfoot tr { border-top: 2px solid #111827; }
                    .teller-amount { text-align: right; font-weight: 800; font-size: 15px; }
                    .teller-label { text-align: right; font-weight: 700; }
                    .teller-diff-positive { color: #059669; } /* green-600 */
                    .teller-diff-negative { color: #dc2626; } /* red-600 */
                    .printable-section { background: transparent; padding: 8px 0; }
                    .no-print { display: block; margin-top: 12px; }
                    @media print {
                        .no-print { display: none !important; }
                        /* Remove shadows, rounded corners and border decorations for print */
                        .shadow-lg, .shadow, .rounded-xl, .rounded-lg { box-shadow: none !important; border-radius: 0 !important; }
                        .teller-print-container, .printable-section, .teller-print-table, .teller-print-table th, .teller-print-table td { box-shadow: none !important; border: none !important; background: transparent !important; }
                        .teller-print-table tbody tr, .teller-print-table thead th, .teller-print-table tfoot tr { border: none !important; }
                    }
                </style>

                <div class="p-6 max-w-xl mx-auto teller-print-container">
                    <!-- CHANGED TITLE TO TELLER REPORT -->
                    <h1 class="text-2xl font-extrabold text-center mb-2 text-gray-800">TELLER REPORT</h1>
                    <p class="text-sm text-center mb-6 text-gray-500">Date/Time: ${new Date().toLocaleString()}</p>

                    <div class="printable-section mt-0">
                        ${inHandTableHtml.replace(/<table class="w-full text-sm">/g, '<table class="teller-print-table">')}
                    </div>

                    <div class="printable-section mt-6">
                        ${balanceBreakdownHtml.replace(/<table class="w-full text-sm">/g, '<table class="teller-print-table">')}
                    </div>

                </div>
            `;
            
            // 3. Switch view and trigger print
            if (directPrint) {
                // If directPrint requested, don't switch to the preview page — just trigger printing.
                // Ensure DOM updates are painted before invoking print.
                await new Promise(resolve => setTimeout(resolve, 80));
                window.print();
                // After printing, ensure the app returns to calculator page
                showPage('cash-calculator-page');
                return;
            }

            // Default behavior: show preview so user can manually print or export PDF
            showPage('cash-calculator-print-output'); // Temporarily show print view
            
            // Show print button for user to manually trigger printing or close
            const printManualControls = document.createElement('div');
            printManualControls.className = 'text-center mt-8 space-x-4 no-print';
            printManualControls.innerHTML = `
                <button onclick="showPage('cash-calculator-page')" class="bg-gray-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-600">Close Preview</button>
                <button onclick="window.print()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Print Report</button>
                <button id="exportPdfBtn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">Export PDF</button>
            `;
            outputContainer.appendChild(printManualControls);

            // Wire up Export PDF button to call the report function with exportPdf = true
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            if (exportPdfBtn) {
                exportPdfBtn.addEventListener('click', () => {
                    // visually indicate action
                    exportPdfBtn.disabled = true;
                    exportPdfBtn.textContent = 'Generating PDF...';
                    // call the same function to generate PDF
                    window.cashCalculatorPrintReport(true).finally(() => {
                        exportPdfBtn.disabled = false;
                        exportPdfBtn.textContent = 'Export PDF';
                    });
                });
            }

            if (exportPdf) {
                // Hide .print-only elements before PDF export
                const printOnlyEls = outputContainer.querySelectorAll('.print-only');
                const prevDisplay = [];
                printOnlyEls.forEach(el => {
                    prevDisplay.push(el.style.display);
                    el.style.display = 'none';
                });
                // Load html2pdf bundle from CDN then export
                try {
                    // Offline: load local copy of html2pdf. Put the file at js/html2pdf.bundle.min.js
                    await loadScript('js/html2pdf.bundle.min.js');
                } catch (e) {
                    console.error('Failed to load html2pdf:', e);
                    alert('Could not load PDF generator library. Please try Print instead.');
                    // Restore .print-only elements
                    printOnlyEls.forEach((el, i) => { el.style.display = prevDisplay[i]; });
                    return;
                }

                // Pick the printable container inside output for rendering
                const printEl = outputContainer.querySelector('.teller-print-container') || outputContainer;
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: 'teller-report.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                // Use html2pdf to generate and save PDF
                try {
                    await html2pdf().set(opt).from(printEl).save();
                } catch (e) {
                    console.error('PDF generation failed:', e);
                    alert('PDF generation failed. Try printing instead.');
                } finally {
                    // Restore .print-only elements
                    printOnlyEls.forEach((el, i) => { el.style.display = prevDisplay[i]; });
                }
            }
        }

        // --- End of Core Cash Calculator Utility Functions ---

        // --- Cash Receive Page Logic ---
        // const denominations_receive = appData.denominations; <-- REMOVED GLOBAL DECLARATION
        let receiveAllInputs = [];
        const receiveTellerMap = {
            tanzil: { totalElement: null },
            siam: { totalElement: null },
            na: { totalElement: null }
        };
        let receiveTotalElementsInitialized = false;
        
        function receiveHandleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
        
                const currentInput = event.target;
                const currentIndex = receiveAllInputs.indexOf(currentInput);
                
                if (currentIndex !== -1) {
                    let nextInput = receiveAllInputs[(currentIndex + 1) % receiveAllInputs.length];
                    nextInput.focus();
                    nextInput.select(); 
                }
            }
        }
        
        function receive_createTotalDisplay() {
            if (receiveTotalElementsInitialized) return;

            const row = document.createElement('div');
            row.className = 'cash-receive-denomination-row cash-receive-total-row';

            const offset = document.createElement('div');
            offset.className = 'cash-receive-denomination-value';
            offset.textContent = 'TOTAL:'; 
            row.appendChild(offset);
            
            Object.keys(receiveTellerMap).forEach(key => {
                const totalBox = document.createElement('div');
                totalBox.className = 'input-like-label total-box';
                totalBox.id = `receive-total-${key}`;
                totalBox.textContent = '0';
                receiveTellerMap[key].totalElement = totalBox; 
                row.appendChild(totalBox);
            });

            const receiveTotalDisplayContainer = document.getElementById('grand-totals-row-receive');
            if (receiveTotalDisplayContainer) receiveTotalDisplayContainer.appendChild(row);
            receiveTotalElementsInitialized = true;
        }

        window.receive_calculateTotals = function() {
            const receiveTopCalc = document.getElementById('top-calc');
            if (!receiveTopCalc) return;

            const totals = { tanzil: 0, siam: 0, na: 0 };
            
            // Note: We don't clear appData.tellerCounts here, only update based on UI

            const tellerCells = receiveTopCalc.querySelectorAll('.cash-receive-denomination-row > [data-teller]');

            tellerCells.forEach(element => {
                let count = 0;
                if (element.tagName === 'INPUT') {
                    count = parseNumber(element.value);
                } else { 
                    count = parseNumber(element.textContent);
                }
                
                const denomination = parseInt(element.dataset.denomination);
                const tellerId = element.dataset.teller; 

                if (denomination && tellerId) {
                    totals[tellerId] += count * denomination;
                    appData.tellerCounts[tellerId][denomination] = count; 
                }
            });

            if (receiveTotalElementsInitialized) {
                if (receiveTellerMap.tanzil.totalElement) receiveTellerMap.tanzil.totalElement.textContent = formatNumber(totals.tanzil);
                if (receiveTellerMap.siam.totalElement) receiveTellerMap.siam.totalElement.textContent = formatNumber(totals.siam);
                if (receiveTellerMap.na.totalElement) receiveTellerMap.na.totalElement.textContent = formatNumber(totals.na);
            }
            
            Object.keys(receiveTellerMap).forEach(receive_calculateDifference);
            
            window.vault_calculateTotals();
            saveDataToLocal(); // Save latest counts and totals
        }
        
        function receive_calculateDifference(tellerId) {
            if (!receiveTellerMap[tellerId] || !receiveTotalElementsInitialized) return;
            
            const targetInput = document.getElementById(`target-${tellerId}`);
            const resultDisplay = document.getElementById(`result-${tellerId}`);
            const totalElement = receiveTellerMap[tellerId].totalElement; 

            if (!targetInput || !resultDisplay || !totalElement) return;

            const grandTotal = parseNumber(totalElement.textContent);
            const targetValue = parseNumber(targetInput.value);
            
            const difference = grandTotal - targetValue; 
            
            if (targetInput && resultDisplay) {
                 if (targetValue === 0 && grandTotal === 0) {
                    resultDisplay.value = '';
                } else {
                    resultDisplay.value = formatNumber(difference);
                }

                resultDisplay.style.backgroundColor = '#f0f0f0'; 
                resultDisplay.style.color = '#333';
                
                if (targetInput.value.length > 0) {
                     if (difference > 0) {
                        resultDisplay.style.backgroundColor = '#ccffcc'; 
                        resultDisplay.style.color = '#006600';
                    } else if (difference < 0) {
                        resultDisplay.style.backgroundColor = '#ffcccc'; 
                        resultDisplay.style.color = '#cc0000';
                    }
                }
            }
            
            saveDataToLocal(); // Save flexcube amounts
        }

        function receive_clearAllData() {
            const receiveTopCalc = document.getElementById('top-calc');
            if (!receiveTopCalc) return;

            const editableInputs = receiveTopCalc.querySelectorAll('input[type="text"]');
            editableInputs.forEach(input => {
                input.value = '';
            });

            const targetInputs = document.querySelectorAll('#cash-receive-page [id^="target-"]');
            const resultInputs = document.querySelectorAll('#cash-receive-page [id^="result-"]');
            
            targetInputs.forEach(input => { input.value = ''; });
            resultInputs.forEach(input => { 
                input.value = '';
                input.style.backgroundColor = '#f0f0f0';
                input.style.color = '#333';
            });
            
            appData.flexcubeAmounts = { tanzil: 0, siam: 0, na: 0 };
            appData.tellerCounts = { tanzil: {}, siam: {}, na: {} };

            window.vault_clearAllData();
            updateAndSaveCalculatorState(); // Syncs T1 counts and saves
            receive_calculateTotals(); // Calculates T2/T3 totals
        }

        function receive_createDenominationRow(value) {
            const row = document.createElement('div');
            row.className = 'cash-receive-denomination-row';

            const valueLabel = document.createElement('div');
            valueLabel.className = 'cash-receive-denomination-value';
            valueLabel.textContent = value;
            row.appendChild(valueLabel);
            
            const createCell = (tellerId) => {
                let element;

                if (tellerId === 'tanzil') {
                    element = document.createElement('div');
                    element.className = 'static-teller-cell cash-receive-teller1-link';
                    element.textContent = '0'; 
                    
                    if (value === 1) {
                        element.classList.add('highlighted-input');
                    }
                } else {
                    element = document.createElement('input');
                    element.type = 'text';
                    element.className = 'cash-receive-input';
                    
                    // Load saved count for T2/T3 here
                    const loadedValue = appData.tellerCounts[tellerId][value] || 0;
                    element.value = loadedValue === 0 ? '' : loadedValue; 

                    element.addEventListener('input', window.receive_calculateTotals);
                    element.addEventListener('keydown', receiveHandleEnterKey);
                    receiveAllInputs.push(element); 
                }

                element.dataset.denomination = value; 
                element.dataset.teller = tellerId;     

                return element;
            };

            row.appendChild(createCell('tanzil')); 
            row.appendChild(createCell('siam'));
            row.appendChild(createCell('na'));

            return row;
        }

        window.receive_initPage = function() {
            const receiveTopCalc = document.getElementById('top-calc');
            if (!receiveTopCalc) return;

            const denominations_receive = appData.denominations; 

            if (receiveTopCalc.children.length === 0) {
                receiveAllInputs = []; 
                denominations_receive.forEach(value => { 
                    receiveTopCalc.appendChild(receive_createDenominationRow(value));
                });
            }
            
            receive_createTotalDisplay();
            
            const receiveClearButton = document.getElementById('clear-all-data');
            const receiveTargetInputs = document.querySelectorAll('#cash-receive-page .receive-target-input');

            if (receiveClearButton && !receiveClearButton.hasListener) {
                receiveClearButton.addEventListener('click', receive_clearAllData);
                receiveClearButton.hasListener = true;
            }
            
            receiveTargetInputs.forEach(input => {
                if (!input.hasListener) {
                    const tellerId = input.id.split('-')[1];
                    const handler = () => receive_calculateDifference(tellerId);
                    input.addEventListener('input', handler);
                    input.hasListener = true;
                }
            });
            
            window.syncCalculatorToReceive(); 
        }
        // --- End of Cash Receive Page Logic ---

        // --- VAULT PAGE LOGIC ---
        let vaultInputs = []; 
        let vaultInitialized = false;

        function handleVaultEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault(); 
                const currentInput = event.target;
                const currentIndex = vaultInputs.indexOf(currentInput);
                
                if (currentIndex !== -1) {
                    const nextInput = vaultInputs[(currentIndex + 1) % vaultInputs.length];
                    nextInput.focus();
                    nextInput.select(); 
                }
            }
        }
        
        window.calculateCoinValue = function() {
            const coinInput = document.getElementById('vault-coin-amount-input');
            if (coinInput) {
                appData.coinValue = parseNumber(coinInput.value);
            } else {
                appData.coinValue = 0;
            }
            window.vault_calculateTotals();
        }

        window.calculateVaultDenominationCounts = function() {
            const inputs = document.querySelectorAll('#vault-lower-input-grid input[type="text"]');
            const counts = {};

            inputs.forEach(input => {
                const count = parseNumber(input.value);
                const denomination = parseInt(input.dataset.denomination);
                
                counts[denomination] = (counts[denomination] || 0) + count;
            });

            appData.vaultLowerCounts = counts;
            window.vault_calculateTotals();
        }
        
        // --- Vault Copy Logic ---
        function vaultHandleCountDoubleClick(event) {
            const cell = event.target;
            if (cell.classList.contains('vault-count-value')) {
                const textToCopy = cell.textContent.replace(/,/g, ''); 
                copyTextToClipboard(textToCopy);
            }
        }

        window.vault_calculateTotals = function() {
            const vaultTotalsDisplay = document.getElementById('vault-totals-display');
            if (!vaultTotalsDisplay) return;

            const totalRows = vaultTotalsDisplay.querySelectorAll('tr');
            const denominations = appData.denominations; // Use appData.denominations
            if (!denominations) return; // safety check
            
            let grandTotalValueBills = 0;
            
            denominations.forEach((denom, index) => {
                let combinedCount = 0;

                ['tanzil', 'siam', 'na'].forEach(tellerId => {
                    combinedCount += appData.tellerCounts[tellerId][denom] || 0;
                });

                combinedCount += appData.vaultLowerCounts[denom] || 0;
                
                const combinedValue = combinedCount * denom;
                grandTotalValueBills += combinedValue;

                if (totalRows[index]) {
                    const tdCount = totalRows[index].querySelector('.vault-count-value');
                    const tdValue = totalRows[index].querySelector('td:last-child');
                    
                    if(tdCount) {
                        tdCount.textContent = combinedCount.toLocaleString('en-US'); 
                        // Attach double-click listener if not already attached
                        if (!tdCount.hasAttribute('data-copy-listener')) {
                            tdCount.addEventListener('dblclick', vaultHandleCountDoubleClick);
                            tdCount.setAttribute('data-copy-listener', 'true');
                        }
                    }
                    if(tdValue && totalRows[index].querySelector('#vault-coin-amount-input') === null) {
                        tdValue.textContent = combinedValue.toLocaleString('en-US'); 
                    }
                }
            });

            const coinIndex = denominations.length; 
            const totalIndex = denominations.length + 1; 
            
            const coinTotal = appData.coinValue; 
            const grandTotalValue = grandTotalValueBills + coinTotal;
            
            if (totalRows[coinIndex]) {
                const tdCoinValue = totalRows[coinIndex].querySelector('td:last-child');
                 if (tdCoinValue && tdCoinValue.querySelector('input') === null) {
                    tdCoinValue.textContent = coinTotal.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                 }
            }
            
            if (totalRows[totalIndex]) {
                const tdTotalValue = totalRows[totalIndex].querySelector('td:last-child');
                if (tdTotalValue) {
                    const tdTotalCount = totalRows[totalIndex].querySelector('.vault-count-value');
                    if (tdTotalCount) {
                        tdTotalCount.textContent = ''; 
                    }
                    
                    tdTotalValue.textContent = grandTotalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                }
            }

            window.calculateVaultDifference(grandTotalValue);
            saveDataToLocal(); // Save Vault state
        }

        window.calculateVaultDifference = function(totalValue) {
            const flexcubeInput = document.getElementById('vault-flexcube-amount-input');
            const differenceDisplay = document.getElementById('vault-difference-display');

            if (!flexcubeInput || !differenceDisplay) return;

            const flexcubeValue = parseNumber(flexcubeInput.value);

            const difference = totalValue - flexcubeValue;

            differenceDisplay.textContent = difference.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            
            differenceDisplay.style.backgroundColor = 'transparent'; 
            differenceDisplay.style.color = '#333';
            
            if (difference !== 0) {
                if (difference > 0) {
                    differenceDisplay.style.backgroundColor = '#ccffcc'; 
                    differenceDisplay.style.color = '#006600';
                } else if (difference < 0) {
                    differenceDisplay.style.backgroundColor = '#ffcccc'; 
                    differenceDisplay.style.color = '#cc0000';
                }
            } else {
                 differenceDisplay.style.backgroundColor = 'transparent';
                 differenceDisplay.style.color = '#333';
            }
            saveDataToLocal(); // Save flexcube amount
        }

        window.vault_clearAllData = function() {
            const vaultLowerInputs = document.querySelectorAll('#vault-lower-input-grid input[type="text"]');
            vaultLowerInputs.forEach(input => { input.value = ''; });
            
            const coinInput = document.getElementById('vault-coin-amount-input');
            if (coinInput) coinInput.value = '0.00';
            
            const vaultFlexcubeInput = document.getElementById('vault-flexcube-amount-input');
            if (vaultFlexcubeInput) vaultFlexcubeInput.value = '0.00';

            appData.vaultLowerCounts = {};
            appData.coinValue = 0;
            appData.vaultFlexcube = 0;
            
            window.calculateVaultDenominationCounts();
            window.calculateCoinValue();
            
            window.vault_calculateTotals();
            saveDataToLocal();
        }

        window.vault_initPage = function() {
            if (vaultInitialized) {
                window.receive_calculateTotals(); 
                return;
            }

            const vaultTotalsDisplay = document.getElementById('vault-totals-display');
            const vaultLowerInputGrid = document.getElementById('vault-lower-input-grid');
            const vaultDenoms = appData.denominations; // Use appData.denominations
            
            if (!vaultDenoms) return; // safety check

            vaultInputs = [];

            // 1. Build Denomination Input Grid (Left)
            vaultDenoms.forEach(denom => {
                const spanLabel = document.createElement('span');
                spanLabel.className = 'denom-label';
                spanLabel.textContent = denom.toLocaleString();
                spanLabel.dataset.denomination = denom;
                vaultLowerInputGrid.appendChild(spanLabel);
                
                const input = document.createElement('input');
                input.type = 'text';
                const loadedValue = appData.vaultLowerCounts[denom] || 0;
                input.value = loadedValue === 0 ? '' : loadedValue;
                input.dataset.denomination = denom;
                
                input.addEventListener('input', window.calculateVaultDenominationCounts);
                input.addEventListener('keydown', handleVaultEnterKey); 
                vaultInputs.push(input);
                vaultLowerInputGrid.appendChild(input);
            });


            // 2. Build Totals Table (Right)
            const vaultDisplayData = [...vaultDenoms, 'Coin=', 'Total=', 'Flexcube Amount=', 'Difference='];
            vaultDisplayData.forEach(item => {
                const tr = document.createElement('tr');
                
                if (item === 'Flexcube Amount=') { tr.classList.add('flexcube-row'); } 
                else if (item === 'Total=') { tr.classList.add('total-row-in-table'); } 
                else if (item === 'Difference=') { tr.classList.add('difference-row-in-table'); }
                
                const tdLabel = document.createElement('td');
                tdLabel.textContent = item === 'Coin=' ? 'Coin' : (item === 'Total=' ? 'TOTAL' : (item === 'Flexcube Amount=' ? 'Flexcube Amount' : (item === 'Difference=' ? 'Difference' : item)));
                tr.appendChild(tdLabel);
                
                const tdCount = document.createElement('td'); 
                tdCount.className = 'vault-count-value';
                tdCount.textContent = vaultDenoms.includes(item) ? '0' : '';
                tr.appendChild(tdCount);

                const tdValue = document.createElement('td');
                
                if (item === 'Coin=') {
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = 'vault-coin-amount-input';
                    input.value = (appData.coinValue || 0).toFixed(2); 
                    input.className = 'vault-coin-amount-input-style';
                    tdValue.appendChild(input);
                    input.addEventListener('input', window.calculateCoinValue);
                    vaultInputs.push(input); 
                } else if (item === 'Flexcube Amount=') {
                     const input = document.createElement('input');
                    input.type = 'text';
                    input.id = 'vault-flexcube-amount-input';
                    input.value = (appData.vaultFlexcube || 0).toFixed(2); 
                    input.className = 'vault-coin-amount-input-style';
                    tdValue.appendChild(input);
                    input.addEventListener('input', window.vault_calculateTotals);
                    vaultInputs.push(input); 
                } else if (item === 'Difference=') {
                    const span = document.createElement('span');
                    span.id = 'vault-difference-display';
                    span.textContent = '0.00';
                    tdValue.appendChild(span);
                } else {
                    tdValue.textContent = '0'; 
                }
                
                tr.appendChild(tdValue);
                vaultTotalsDisplay.appendChild(tr);
            });

            window.receive_calculateTotals(); // Ensure receive totals are calculated before first vault total
            window.calculateCoinValue(); // Recalculate based on loaded coin value
            window.calculateVaultDenominationCounts(); // Recalculate based on loaded lower counts

            vaultInitialized = true;
        }
        // --- End of VAULT PAGE LOGIC ---

        // --- CASH FLOW LEDGER LOGIC (Copied from New Text Document (7).html) ---

        /**
         * Utility to display Cash Flow specific messages/errors.
         */
        function cashFlowDisplayMessage(message, isError = false) {
            const errorBox = document.getElementById('error-message');
            errorBox.textContent = message;
            errorBox.classList.remove('hidden');
            // Reset classes
            errorBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700', 'bg-green-100', 'border-green-400', 'text-green-700');

            if (isError) {
                errorBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                console.error("Cash Flow Error:", message);
            } else {
                 // Use neutral for general status/success
                errorBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                console.log("Cash Flow Status:", message);
            }
            setTimeout(() => errorBox.classList.add('hidden'), 5000);
        }
        
        function cashFlowGetEntries() {
            try {
                const data = localStorage.getItem(CASH_FLOW_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                cashFlowDisplayMessage("Could not load Cash Flow data from local storage.", true);
                return [];
            }
        }

        function cashFlowSaveEntries(entries) {
            try {
                localStorage.setItem(CASH_FLOW_STORAGE_KEY, JSON.stringify(entries));
                try { updateCashCalculatorCurrentBalance(); } catch (e) { /* ignore if helper not present */ }
                try { updateDifferenceLabel(); } catch (e) { /* ignore */ }
            } catch (e) {
                cashFlowDisplayMessage("Could not save Cash Flow data to local storage.", true);
            }
        }

        function cashFlowInitializeData() {
            const entries = cashFlowGetEntries();
            entries.sort((a, b) => a.timestamp - b.timestamp);
            cashFlowRenderCashBook(entries);
            try { updateDifferenceLabel(); } catch (e) {}
            // Re-attach listener on every view change, if not already attached
            const form = document.getElementById('cash-flow-transaction-form');
            if (form && !form.hasListener) {
                form.addEventListener('submit', cashFlowHandleAddEntry);
                form.hasListener = true;
            }
        }

        async function cashFlowHandleClearAll() {
            const clearButton = document.getElementById('cf-clear-all-btn');
            const originalText = clearButton.textContent;
            clearButton.disabled = true;
            clearButton.textContent = 'Clearing...';

            try {
                const entries = cashFlowGetEntries();
                if (entries.length === 0) {
                    cashFlowDisplayMessage("No Cash Flow data found to clear."); 
                    return;
                }

                localStorage.removeItem(CASH_FLOW_STORAGE_KEY);
                cashFlowRenderCashBook([]);
                try { updateDifferenceLabel(0); } catch (e) {}
                
                cashFlowDisplayMessage(`Successfully cleared ${entries.length} Cash Flow transactions.`, false);

            } catch (e) {
                cashFlowDisplayMessage("Failed to clear Cash Flow data: " + e.message, true);
            } finally {
                clearButton.disabled = false;
                clearButton.textContent = originalText;
            }
        }

        async function cashFlowHandleAddEntry(event) {
            event.preventDefault();

            const form = event.target;
            const description = form.description.value.trim();
            const receipt = parseNumber(form.receipt.value);
            const payment = parseNumber(form.payment.value);

            if (!description) {
                cashFlowDisplayMessage("Please enter a name or description.", true);
                return;
            }
            if (receipt === 0 && payment === 0) {
                cashFlowDisplayMessage("Please enter an amount for either Paid or Received.", true);
                return;
            }
            if (receipt > 0 && payment > 0) {
                cashFlowDisplayMessage("An entry cannot be both a Receipt and a Payment.", true);
                return;
            }

            const newEntry = {
                id: Date.now().toString(36) + Math.random().toString(36).substring(2),
                description: description,
                amount: receipt > 0 ? receipt : payment,
                type: receipt > 0 ? 'receipt' : 'payment',
                timestamp: new Date().getTime()
            };

            try {
                const button = document.getElementById('cf-submit-btn');
                button.disabled = true;
                button.textContent = 'Saving...';

                const entries = cashFlowGetEntries();
                entries.push(newEntry);
                entries.sort((a, b) => a.timestamp - b.timestamp);
                
                cashFlowSaveEntries(entries);
                cashFlowRenderCashBook(entries);
                
                cashFlowDisplayMessage("Transaction added and ledger updated.", false);

                form.reset();
                document.getElementById('cf-receipt').value = '';
                document.getElementById('cf-payment').value = '';

            } catch (e) {
                cashFlowDisplayMessage("Error adding transaction: " + e.message, true);
            } finally {
                const button = document.getElementById('cf-submit-btn');
                button.disabled = false;
                button.textContent = 'Add Transaction';
            }
        }

        function cashFlowRenderNameBalances(balances) {
            const container = document.getElementById('cf-name-balance-breakdown');
            if (!container) return;
            container.innerHTML = ''; 

            const names = Object.keys(balances).sort();
            let hasNonZeroBalance = false; // Flag to check if any non-zero balance exists


            names.forEach(name => {
                const balance = balances[name];
                
                // Only render if the absolute value of the balance is greater than 0.001 (to handle floats)
                if (Math.abs(balance) > 0.001) { 
                    hasNonZeroBalance = true;
                    const balanceDisplay = balance.toFixed(2).toLocaleString();
                    const balanceClass = balance < 0 ? 'text-red-600' : 'text-green-600';

                    const html = `
                        <div class="flex justify-between py-2 border-b border-gray-200 last:border-b-0">
                            <span class="text-sm font-medium text-gray-700">${name}</span>
                            <span class="text-base font-semibold ${balanceClass}">
                                ${balanceDisplay}
                            </span>
                        </div>
                    `;
                    container.innerHTML += html;
                }
            });
            
            // Check the flag for displaying the "No transactions" message
            if (!hasNonZeroBalance) {
                 container.innerHTML = `<p class="text-gray-500 text-center py-4 text-sm">No named transactions to summarize or all balances are settled.</p>`;
            }
        }

        function cashFlowRenderCashBook(entries) {
            const tableBody = document.getElementById('cf-cash-book-body');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            let runningBalance = 0;
            let nameBalances = {}; 

            if (entries.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">No transactions recorded yet.</td></tr>`;
                const finalBalanceElement = document.getElementById('cf-final-balance');
                if (finalBalanceElement) {
                     finalBalanceElement.textContent = '0.00';
                     finalBalanceElement.className = 'text-3xl font-extrabold text-gray-700';
                }
                cashFlowRenderNameBalances({}); 
                return;
            }

            entries.forEach(entry => {
                const isReceipt = entry.type === 'receipt';
                const receiptAmount = isReceipt ? entry.amount : 0;
                const paymentAmount = isReceipt ? 0 : entry.amount;

                const displayDate = new Date(entry.timestamp); 
                const displayTime = displayDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: true });

                if (isReceipt) {
                    runningBalance += entry.amount;
                } else {
                    runningBalance -= entry.amount;
                }
                
                const name = entry.description;
                if (!nameBalances[name]) {
                    nameBalances[name] = 0;
                }
                nameBalances[name] += isReceipt ? entry.amount : -entry.amount;

                const balanceClass = runningBalance < 0 ? 'text-red-600 font-semibold' : 'text-green-600 font-semibold';

                const row = `
                    <tr class="hover:bg-gray-50 border-b border-gray-200">
                        <!-- Time Stamp -->
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-gray-900">${displayTime}</td>
                        <td class="px-6 py-3 text-sm text-gray-700">${entry.description}</td>
                        <!-- PAID (RED) - Position 3 -->
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-red-700 text-right">
                            ${paymentAmount.toFixed(2).toLocaleString()}
                        </td>
                        <!-- RECEIVED (GREEN) - Position 4 -->
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-green-700 text-right">
                            ${receiptAmount.toFixed(2).toLocaleString()}
                        </td>
                        <td class="px-6 py-3 whitespace-nowrap text-sm text-right ${balanceClass}">
                            ${runningBalance.toFixed(2).toLocaleString()}
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });

        const finalBalanceElement = document.getElementById('cf-final-balance');
        if (finalBalanceElement) {
         finalBalanceElement.textContent = formatNumber(runningBalance);
         finalBalanceElement.className = runningBalance < 0 
            ? 'text-3xl font-extrabold text-red-700' 
            : 'text-3xl font-extrabold text-green-700';
        }

            cashFlowRenderNameBalances(nameBalances);

            // Also update the cash calculator's displayed Current Cash Balance (if present)
            try { updateCashCalculatorCurrentBalance(runningBalance); } catch (e) { /* ignore if helper not yet defined */ }
            try { updateDifferenceLabel(runningBalance); } catch (e) { /* ignore */ }
        }

        // --- END CASH FLOW LEDGER LOGIC ---

        // Helper: compute current cash balance from stored entries
        function computeCurrentCashBalance() {
            try {
                const entries = cashFlowGetEntries();
                let bal = 0;
                entries.forEach(e => {
                    if (!e || typeof e.amount !== 'number') return;
                    bal += (e.type === 'receipt') ? e.amount : -e.amount;
                });
                return bal;
            } catch (err) {
                console.error('computeCurrentCashBalance error', err);
                return 0;
            }
        }

        // Helper: update the cash calculator UI element showing Current Cash Balance
        function updateCashCalculatorCurrentBalance(value) {
            const el = document.getElementById('cf-final-balance');
            if (!el) return;
            const num = typeof value === 'number' ? value : computeCurrentCashBalance();
            const text = num.toFixed(2).toLocaleString();
            el.textContent = text;
            // color mapping: positive -> green (To be Pay), negative -> red (To be Receive), zero -> neutral
            if (num > 0) {
                el.className = 'text-3xl font-extrabold text-green-700';
            } else if (num < 0) {
                el.className = 'text-3xl font-extrabold text-red-700';
            } else {
                el.className = 'text-3xl font-extrabold text-gray-700';
            }
        }

        // Helper: update the Difference label (To be Pay / To be Receive) using ledger
        function updateDifferenceLabel(ledgerValue) {
            try {
                const labelEl = document.getElementById('differenceLabel');
                if (!labelEl) return;
                const ledger = (typeof ledgerValue === 'number') ? ledgerValue : (typeof computeCurrentCashBalance === 'function' ? computeCurrentCashBalance() : 0);
                if (ledger > 0) {
                    labelEl.textContent = `To be Pay: ${formatNumber(ledger)}`;
                    labelEl.className = 'text-sm font-semibold text-green-700';
                } else if (ledger < 0) {
                    labelEl.textContent = `To be Receive: ${formatNumber(ledger)}`;
                    labelEl.className = 'text-sm font-semibold text-red-700';
                } else {
                    labelEl.textContent = 'Current';
                    labelEl.className = 'text-sm font-semibold text-gray-700';
                }
            } catch (err) {
                console.warn('updateDifferenceLabel error', err);
            }
        }

        // --- ELECTRICITY BILL FUNCTIONS ---

        // Constants and State for Electricity Bill
        let collectedBills = []; 
        const ITEMS_PER_COLUMN = 15;
        const ITEMS_PER_PAGE = ITEMS_PER_COLUMN * 2; // 30 items per page
        let isPreviewActive = false;

        // Helper Functions
        function getTodayDisplayDate() {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function loadMockData() {
            collectedBills = [
                { billNo: '100801-009-4429', amount: 507, vat: 24, rStamp: 10, paid: true },
                { billNo: '100801-730-3110', amount: 202, vat: 10, rStamp: 0, paid: true },
                { billNo: '100801-730-3115', amount: 2961, vat: 138, rStamp: 10, paid: true },
                { billNo: '100801-784-1485', amount: 469, vat: 22, rStamp: 0, paid: true },
                ...Array.from({ length: 8 }, (_, i) => {
                    const amount = Math.floor(Math.random() * 800) + 100;
                    const vat = Math.round((amount / 105) * 5);
                    const rStamp = amount > 499 ? 10 : 0;
                    return {
                        billNo: `100801-000-${1000 + i}`,
                        amount: amount,
                        vat: vat,
                        rStamp: rStamp,
                        paid: true
                    };
                })
            ];
            
            // Save mock data to local storage
            saveDataToLocal();
            
            renderReport();
        }

        function togglePrintPreview() {
            const body = document.body;
            const printButton = document.getElementById('printButton');
            const pagedReportView = document.getElementById('pagedReportView');
            const originalButtonText = 'Print';
            const exitButtonText = 'Exit Print Preview';

            isPreviewActive = !isPreviewActive;

            if (isPreviewActive) {
                body.classList.add('preview-active');
                printButton.textContent = exitButtonText;
                printButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                printButton.classList.add('bg-red-600', 'hover:bg-red-700');
                renderPagedReport();
                pagedReportView.classList.remove('hidden');
            } else {
                body.classList.remove('preview-active');
                printButton.textContent = originalButtonText;
                printButton.classList.remove('bg-red-600', 'hover:bg-red-700');
                printButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
                pagedReportView.classList.add('hidden');
            }
        }

        function updateCalculatedFields() {
            const amountInput = document.getElementById('amountInput');
            const vatInput = document.getElementById('vatInput');
            const rStampInput = document.getElementById('rStampInput');

            const amount = parseFloat(amountInput.value) || 0;
            const calculatedVat = Math.round((amount / 105) * 5);
            vatInput.value = calculatedVat;
            const calculatedRStamp = amount > 499 ? 10 : 0;
            rStampInput.value = calculatedRStamp;
        }

        function calculateTotals() {
            return collectedBills.reduce((acc, bill) => {
                acc.totalAmount += bill.amount;
                acc.totalVat += bill.vat;
                acc.totalRStamp += bill.rStamp;
                acc.voucherRevenue += (bill.amount - bill.vat); 
                return acc;
            }, { totalAmount: 0, totalVat: 0, totalRStamp: 0, voucherRevenue: 0 });
        }

        function updateBillData(input) {
            const index = parseInt(input.getAttribute('data-index'));
            const field = input.getAttribute('data-field');

            if (index >= collectedBills.length) {
                console.error("Attempted to update bill at invalid index.");
                return;
            }

            // Support both numeric fields (amount, vat, rStamp) and textual billNo
            if (field === 'billNo') {
                const newText = input.value != null ? input.value.toString().trim() : '';
                collectedBills[index][field] = newText;
            } else {
                const newValue = parseFloat(input.value) || 0;
                collectedBills[index][field] = Math.round(newValue);
            }

            if (field === 'amount') {
                const newAmount = collectedBills[index].amount;
                collectedBills[index].rStamp = newAmount > 499 ? 10 : 0;
            }
            
            renderReport(); 

            // Save to local storage after update
            saveDataToLocal();

            if (isPreviewActive) {
                renderPagedReport();
            }
        }

        function renderItemizedList(billsChunk, pageNumber, totalPages) {
            // Render a single stacked table for the given chunk of bills.
            // This prevents any side-by-side overflow during printing.
            const tableHeaders = `
                <thead>
                    <tr>
                        <th class="report-table-cell report-table-header w-[8%]">S/L</th>
                        <th class="report-table-cell report-table-header w-[50%]">Bill No</th>
                        <th class="report-table-cell report-table-header w-[12%]">Vat</th>
                        <th class="report-table-cell report-table-header w-[20%]">Amount</th>
                        <th class="report-table-cell report-table-header w-[10%]">R.Stamp</th>
                    </tr>
                </thead>
            `;

            const createRow = (bill, index) => {
                const sL = ((pageNumber - 1) * ITEMS_PER_PAGE) + index + 1;
                return `
                    <tr>
                            <td class="report-table-cell text-center">${sL}</td>
                            <td class="report-table-cell text-center font-mono">${bill.billNo}</td>
                            <td class="report-table-cell text-center">${bill.vat.toLocaleString()}</td>
                            <td class="report-table-cell text-center">${bill.amount.toLocaleString()}</td>
                            <td class="report-table-cell text-center">${bill.rStamp > 0 ? bill.rStamp.toLocaleString() : ''}</td>
                        </tr>
                `;
            };

            return `
                <div class="border border-black shadow-md">
                    <table class="w-full border-collapse">
                        <colgroup>
                            <col style="width:8%;" />
                            <col style="width:50%;" />
                            <col style="width:12%;" />
                            <col style="width:20%;" />
                            <col style="width:10%;" />
                        </colgroup>
                        ${tableHeaders}
                        <tbody>
                            ${billsChunk.map((bill, i) => createRow(bill, i)).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="page-footer">Page ${pageNumber} of ${totalPages}</div>
            `;
        }

        function renderPagedReport() {
            const pagedReportView = document.getElementById('pagedReportView');
            const controlsDiv = document.getElementById('previewControls').outerHTML;
            pagedReportView.innerHTML = controlsDiv; 
            
            const totals = calculateTotals();
            const displayDate = getTodayDisplayDate();
            const totalBills = collectedBills.length;
            const totalPages = Math.ceil(totalBills / ITEMS_PER_PAGE);

            const branchInfo = document.getElementById('branchInfo').textContent;
            const samityInfo = document.getElementById('samityInfo').textContent;

            const bankHeaderHtml = `
                <div class="page-header">
                    <div style="text-align:center;">
                        <div><h1 class="bank-title">United Commercial Bank PLC</h1></div>
                        <div class="bank-sub">${branchInfo}</div>
                        <div class="bank-sub">${samityInfo}</div>
                        <hr class="bank-divider" />
                        <div style="margin-top:10px; font-weight:700;">DATE: <span>${displayDate}</span></div>
                    </div>
                </div>
            `;
            
            for (let page = 1; page <= totalPages; page++) {
                const startIndex = (page - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const billsChunk = collectedBills.slice(startIndex, endIndex);

                let pageHtml = `<div class="print-page">`;
                pageHtml += bankHeaderHtml;

                if (page === 1) {
                    pageHtml += `
                        <div class="totals-grid mb-6">
                            <div class="border border-black shadow-md">
                                <table class="w-full border-collapse">
                                    <thead><tr><th colspan="2" class="report-table-cell report-table-header bg-gray-200">Grand Total</th></tr></thead>
                                    <tbody>
                                        <tr><td class="report-table-cell text-left font-semibold">Amount</td><td class="report-table-cell text-right">${totals.totalAmount.toLocaleString()}</td></tr>
                                        <tr><td class="report-table-cell text-left font-semibold">Vat</td><td class="report-table-cell text-right">${totals.totalVat.toLocaleString()}</td></tr>
                                        <tr><td class="report-table-cell text-left font-semibold">R.Stamp</td><td class="report-table-cell text-right">${totals.totalRStamp.toLocaleString()}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="border border-black shadow-md">
                                <table class="w-full border-collapse">
                                    <thead><tr><th colspan="2" class="report-table-cell report-table-header bg-gray-200">Voucher Taka</th></tr></thead>
                                    <tbody>
                                        <tr><td class="report-table-cell text-left font-semibold">Revenue</td><td class="report-table-cell text-right">${totals.voucherRevenue.toLocaleString()}</td></tr>
                                        <tr><td class="report-table-cell text-left font-semibold">Vat</td><td class="report-table-cell text-right">${totals.totalVat.toLocaleString()}</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                } else {
                    pageHtml += `<div class="print-spacer-45mm"></div>`; 
                }

                pageHtml += renderItemizedList(billsChunk, page, totalPages);
                pageHtml += `</div>`;
                pagedReportView.innerHTML += pageHtml;
            }
        }

        function renderReport() {
            const totals = calculateTotals();
            const displayDate = getTodayDisplayDate();

            document.getElementById('reportDate').innerHTML = `DATE: <span>${displayDate}</span>`;
            document.getElementById('totalAmount').textContent = totals.totalAmount.toLocaleString();
            document.getElementById('totalVat').textContent = totals.totalVat.toLocaleString();
            document.getElementById('totalRStamp').textContent = totals.totalRStamp.toLocaleString();
            document.getElementById('voucherRevenue').textContent = totals.voucherRevenue.toLocaleString();
            document.getElementById('voucherVat').textContent = totals.totalVat.toLocaleString();

            const billListRows = document.getElementById('billListRows');
            const billListRowsRight = document.getElementById('billListRowsRight');
            if (billListRows) billListRows.innerHTML = '';
            if (billListRowsRight) billListRowsRight.innerHTML = '';

            const createRow = (bill, index) => {
                const sL = index + 1;
                return `
                    <tr>
                        <td class="report-table-cell text-center">${sL}</td>
                        <td class="report-table-cell p-0">
                            <input type="text" value="${bill.billNo}"
                                data-index="${index}" data-field="billNo"
                                onchange="updateBillData(this)"
                                class="w-full h-full text-sm text-center p-1 border-none bg-transparent font-mono" />
                        </td>
                        <!-- Editable VAT Input -->
                        <td class="report-table-cell p-0">
                            <input type="number" value="${bill.vat}" 
                                data-index="${index}" data-field="vat"
                                onchange="updateBillData(this)"
                                class="w-full h-full text-sm text-center p-1 border-none bg-transparent"/>
                        </td>
                        <!-- Editable Amount Input -->
                        <td class="report-table-cell p-0">
                            <input type="number" value="${bill.amount}" 
                                data-index="${index}" data-field="amount"
                                onchange="updateBillData(this)"
                                class="w-full h-full text-sm text-center p-1 border-none bg-transparent font-semibold"/>
                        </td>
                        <!-- R.Stamp is still display-only as it's calculated -->
                        <td class="report-table-cell text-center">${bill.rStamp > 0 ? bill.rStamp.toLocaleString() : ''}</td>
                    </tr>
                `;
            };

            // Populate two-column layout on screen: split bills into left and right halves
            const half = Math.ceil(collectedBills.length / 2);
            for (let i = 0; i < collectedBills.length; i++) {
                if (i < half) {
                    // left column: indices 0..half-1
                    if (billListRows) billListRows.innerHTML += createRow(collectedBills[i], i);
                } else {
                    // right column: indices half..end -> numbering continues sequentially
                    if (billListRowsRight) billListRowsRight.innerHTML += createRow(collectedBills[i], i);
                }
            }

            // Note: print still uses the paged/single-table rendering (renderPagedReport)
        }

        // Replace form controls with plain text nodes for printing to avoid browser form-control outlines
        function sanitizePrintNodes(container) {
            if (!container || !container.querySelectorAll) return;
            // replace inputs
            const inputs = container.querySelectorAll('input');
            inputs.forEach(inp => {
                const val = inp.value != null ? inp.value : inp.textContent || '';
                const span = document.createElement('span');
                span.className = (inp.className || '') + ' printed-field';
                span.textContent = val;
                // Keep the cell styling by copying display/width if needed
                try { span.style.cssText = window.getComputedStyle(inp).cssText; } catch(e){}
                inp.parentNode.replaceChild(span, inp);
            });
            // replace textareas
            const areas = container.querySelectorAll('textarea');
            areas.forEach(a => {
                const span = document.createElement('span');
                span.className = (a.className || '') + ' printed-field';
                span.textContent = a.value || '';
                try { span.style.cssText = window.getComputedStyle(a).cssText; } catch(e){}
                a.parentNode.replaceChild(span, a);
            });
            // replace selects
            const selects = container.querySelectorAll('select');
            selects.forEach(s => {
                const selText = (s.selectedOptions && s.selectedOptions.length) ? Array.from(s.selectedOptions).map(o => o.textContent).join(', ') : s.value || '';
                const span = document.createElement('span');
                span.className = (s.className || '') + ' printed-field';
                span.textContent = selText;
                try { span.style.cssText = window.getComputedStyle(s).cssText; } catch(e){}
                s.parentNode.replaceChild(span, s);
            });
            // remove any focus/validation outline styles on containers
            const els = container.querySelectorAll('*');
            els.forEach(el => {
                el.style.outline = 'none';
                el.style.boxShadow = 'none';
                el.style.background = 'transparent';
            });
        }

        // Print HTML directly using a hidden iframe (no popup). Removes iframe after printing.
        function printHtmlDirect(html) {
            try {
                // Remove any existing direct print iframe
                const existing = document.getElementById('__direct_print_iframe');
                if (existing) { try { existing.parentNode.removeChild(existing); } catch(e){} }

                const iframe = document.createElement('iframe');
                iframe.id = '__direct_print_iframe';
                iframe.style.position = 'fixed';
                iframe.style.left = '0'; iframe.style.top = '0';
                iframe.style.width = '0'; iframe.style.height = '0';
                iframe.style.border = '0'; iframe.style.visibility = 'hidden';
                document.body.appendChild(iframe);

                const doc = iframe.contentDocument || iframe.contentWindow.document;
                doc.open(); doc.write(html); doc.close();

                // Give the iframe time to render, then call print on its window
                setTimeout(() => {
                    try {
                        iframe.contentWindow.focus();
                        iframe.contentWindow.print();
                    } catch (e) {
                        console.warn('Direct iframe print failed', e);
                    }
                    // Remove the iframe shortly after printing
                    setTimeout(() => { try { iframe.parentNode.removeChild(iframe); } catch (e) {} }, 600);
                }, 300);
            } catch (e) {
                console.warn('printHtmlDirect error', e);
                alert('Printing failed: ' + (e && e.message ? e.message : e));
            }
        }

        function initiateElectricityPrint() {
            // New print implementation: open a new window and print the paged report there.
            const pagedReportView = document.getElementById('pagedReportView');
            if (!pagedReportView) {
                console.warn('Paged report view not found');
                return;
            }
            // Ensure paged report is rendered
            if (!pagedReportView.innerHTML || pagedReportView.innerHTML.trim() === '') {
                try { renderPagedReport(); } catch (e) { console.warn('renderPagedReport failed', e); }
            }

            const reportHtml = pagedReportView.innerHTML;
            // Sanitize cloned HTML to replace form controls with plain text so no form-control boxes appear in print
            const _tmp = document.createElement('div');
            _tmp.innerHTML = reportHtml;
            try { sanitizePrintNodes(_tmp); } catch(e) { console.warn('sanitizePrintNodes failed', e); }
            const safeReportHtml = _tmp.innerHTML;

            const css = `
                body{ font-family: 'Times New Roman', Times, serif; margin:12mm; color:#111; }
                .bank-title{ font-size:32pt; font-weight:800; text-align:center; margin:0; }
                .bank-sub{ font-size:12pt; text-align:center; margin-top:4px; font-weight:600; }
                .bank-divider{ height:2px; background:#c0392b; border:none; margin:10px 0 12px 0; }
                /* Use single stacked sections for print to avoid horizontal overflow */
                .report-grid{ display:block; gap:16px; margin-bottom:12px; }
                /* Keep totals side-by-side (Grand Total & Voucher Taka) */
                /* Ensure totals appear side-by-side in the print popup */
                .totals-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; align-items: start; }
                .totals-grid > div { width: auto !important; box-sizing: border-box !important; }
                .totals-grid .border { margin: 0 !important; }
                .report-table-cell, .report-table-header{ padding:6px; border:1px solid #000; text-align:center; }
                .report-table-header{ background:#e9e9e9; font-weight:700; text-align:center; }
                table{ border-collapse:collapse; width:100%; font-size:11pt; }
                /* Printed table column widths: reduce Amount column and allow Bill No more space */
                table col:nth-child(1){ width:8%; }
                table col:nth-child(2){ width:46%; }
                table col:nth-child(3){ width:12%; }
                table col:nth-child(4){ width:18%; }
                table col:nth-child(5){ width:16%; }
                /* Make Amount column slightly smaller font so numbers fit without wrapping */
                td:nth-child(4), th:nth-child(4) { font-size:8.5pt; }
                .print-page{ page-break-after:always; padding:12mm; }
            `;

            // Build the full HTML and print via hidden iframe (direct print, no popup)
            const fullHtml = '<!doctype html><html><head><meta charset="utf-8"><title>Electricity Bill</title>' +
                '<style>' + css + '</style></head><body>' + safeReportHtml + '</body></html>';
            printHtmlDirect(fullHtml);
        }

        // Print the visible report container and bank header exactly as shown on screen.
        function printReportSection() {
            const header = document.querySelector('#electricity-bill-page header');
            const report = document.getElementById('reportContainer');
            if (!report) { alert('Report container not found'); return; }

            // Clone report DOM and ensure the totals container uses the ` + "'totals-grid'" + ` class
            const clone = report.cloneNode(true);
            const mainTotals = clone.querySelector('#mainTotalsGrid');
            if (mainTotals) {
                mainTotals.className = 'totals-grid mb-6';
            }
            // Replace form controls inside the cloned report so printed output contains plain text only
            try { sanitizePrintNodes(clone); } catch (e) { console.warn('sanitizePrintNodes failed for clone', e); }
            const reportHtmlFixed = clone.outerHTML;

            const html = `
                <!doctype html>
                <html>
                <head>
                <meta charset="utf-8">
                <title>Electricity Bill</title>
                <style>
                    body{ font-family: 'Times New Roman', Times, serif; margin:8mm; color:#111; box-sizing: border-box; }
                    header { text-align:center; margin-bottom:8px; }
                    header h1 { font-size:28pt; font-weight:800; margin:0; }
                    header p { font-size:11pt; margin:3px 0; font-weight:600; }
                    .bank-divider{ height:2px; background:#c0392b; border:none; margin:6px 0 8px 0; }
                    .report-wrap { background:#fff; border-radius:6px; padding:6px; }
                    /* Stack report sections for print to ensure no horizontal overflow */
                    .report-grid{ display:block; gap:10px; margin-bottom:8px; }
                    /* Keep totals side-by-side (Grand Total & Voucher Taka) */
                    /* Ensure totals appear side-by-side in inline print HTML */
                    .totals-grid{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:8px; align-items: start; }
                    .totals-grid > div { width: auto !important; box-sizing: border-box !important; }
                    .totals-grid .border { margin: 0 !important; }
                    table{ width:100%; border-collapse:collapse; font-size:9pt; table-layout:fixed; }
                    /* Column widths to prevent overflow - reduce Amount column for print */
                    table col:nth-child(1){ width:8%; }
                    table col:nth-child(2){ width:46%; }
                    table col:nth-child(3){ width:12%; }
                    table col:nth-child(4){ width:18%; }
                    table col:nth-child(5){ width:16%; }
                    /* Smaller font for Amount column so it occupies less horizontal space */
                    td:nth-child(4), th:nth-child(4) { font-size:8.5pt; }
                    th, td{ border:1px solid #000; padding:5px; word-break:break-word; overflow-wrap:break-word; text-align:center; }
                    th { background:#e6e6e6; font-weight:700; text-align:center; }
                </style>
                </head>
                <body>
                ${ header ? header.outerHTML : '' }
                <div class="report-wrap">
                    ${ reportHtmlFixed }
                </div>
                </body></html>
            `;

            // Direct print via hidden iframe (no popup)
            printHtmlDirect(html);
        }

        function addBill() {
            const billNoInput = document.getElementById('billNoInput');
            const amountInput = document.getElementById('amountInput');
            const vatInput = document.getElementById('vatInput');
            const rStampInput = document.getElementById('rStampInput');
            const messageBox = document.getElementById('messageBox');
            
            const billNo = billNoInput.value.trim();
            const amount = Math.round(parseFloat(amountInput.value) || 0); 
            // VAT is now read directly from input, allowing user override
            const vat = Math.round(parseFloat(vatInput.value) || 0);
            const rStamp = Math.round(parseFloat(rStampInput.value) || 0);

            messageBox.textContent = '';
            messageBox.classList.remove('text-green-600', 'text-red-600');

            if (!billNo) {
                messageBox.textContent = 'Error: Please enter the Bill No.';
                messageBox.classList.add('text-red-600');
                return;
            }
            if (amount <= 0 || isNaN(amount)) {
                messageBox.textContent = 'Error: Please enter a valid positive Amount.';
                messageBox.classList.add('text-red-600');
                return;
            }

            const alreadyCollected = collectedBills.some(bill => bill.billNo === billNo);
            if (alreadyCollected) {
                messageBox.textContent = `Error: Bill No ${billNo} is already in the report.`;
                messageBox.classList.add('text-red-600');
                return;
            }

            const newBill = {
                billNo: billNo,
                amount: amount,
                vat: vat,
                rStamp: rStamp,
                paid: true
            };

            collectedBills.push(newBill);
            
            billNoInput.value = '';
            amountInput.value = '';
            vatInput.value = '0';
            rStampInput.value = '0';
            updateCalculatedFields(); 

            // Save to local storage
            saveDataToLocal();

            messageBox.textContent = `Success: Bill No ${billNo} (Amount: ${newBill.amount.toLocaleString()}) added.`;
            messageBox.classList.add('text-green-600');
            
            renderReport();
            if (isPreviewActive) {
                renderPagedReport();
            }
        }

        function clearReport() {
            collectedBills = [];
            
            document.getElementById('billNoInput').value = '';
            document.getElementById('amountInput').value = '';
            document.getElementById('vatInput').value = '0';
            document.getElementById('rStampInput').value = '0';
            
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = 'Report cleared successfully.';
            messageBox.classList.remove('text-red-600');
            messageBox.classList.add('text-green-600');
            
            // Clear from app data and save
            appData.electricityBills = [];
            saveDataToLocal();
            
            renderReport();
            if (isPreviewActive) {
                const controlsDiv = document.getElementById('previewControls').outerHTML;
                document.getElementById('pagedReportView').innerHTML = controlsDiv;
            }
        }

        // --- END ELECTRICITY BILL FUNCTIONS ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // 1. LOAD DATA FROM LOCAL STORAGE AND APPLY TO UI
            loadDataFromLocal();
            applyLoadedDataToUI();
            
            const sidebarToggleBtn = document.getElementById('sidebarToggle');
            const menuIcon = document.getElementById('menuIcon');

            // Attach toggle listener and apply responsive logic
            if (sidebarToggleBtn) {
                sidebarToggleBtn.addEventListener('click', toggleSidebar);
            }

            // Paged report export button (Electricity Bill)
            const exportPagedBtn = document.getElementById('exportPagedReportPdfBtn');
            if (exportPagedBtn) {
                exportPagedBtn.addEventListener('click', async () => {
                    try {
                        exportPagedBtn.disabled = true;
                        exportPagedBtn.textContent = 'Generating PDF...';
                        const pagedReportView = document.getElementById('pagedReportView');
                        if (!pagedReportView) {
                            alert('Paged report content not found. Open Print Preview first.');
                            return;
                        }

                        // Clone the paged report content and strip controls (no-print / preview controls)
                        const clone = document.createElement('div');
                        clone.innerHTML = pagedReportView.innerHTML;
                        // Remove preview controls and any elements marked .no-print inside the clone
                        const toRemove = clone.querySelectorAll('#previewControls, .no-print');
                        toRemove.forEach(n => n.remove());

                        // Ensure there is visible content
                        if (!clone.innerHTML.trim()) {
                            alert('No report content found to export.');
                            return;
                        }

                        await generatePdfFromElement(clone, 'electricity-report.pdf', { fitToOnePage: true });
                    } catch (err) {
                        console.error('Export PDF failed (electricity):', err);
                        alert('Export PDF failed. Check console for details.');
                    } finally {
                        exportPagedBtn.disabled = false;
                        exportPagedBtn.textContent = 'Export PDF';
                    }
                });
            }

            // ATM output Export PDF (attach when ATM output exists)
            const atmOutputObserver = new MutationObserver((mutations) => {
                const atmOutputPage = document.getElementById('atm-output-page');
                if (!atmOutputPage) return;
                const existing = atmOutputPage.querySelector('#exportAtmPdfBtn');
                if (!existing) {
                    const controls = atmOutputPage.querySelector('.no-print');
                    if (controls) {
                        const btn = document.createElement('button');
                        btn.id = 'exportAtmPdfBtn';
                        btn.className = 'bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 ml-2';
                        btn.textContent = 'Export PDF';
                        controls.appendChild(btn);
                        btn.addEventListener('click', async () => {
                            btn.disabled = true;
                            const printEl = document.getElementById('atm-output-page');
                            if (!printEl) {
                                alert('ATM output not found for export.');
                                btn.disabled = false;
                                return;
                            }
                            // Clone and remove any UI controls or print-only helper elements before export
                            const clone = document.createElement('div');
                            clone.innerHTML = printEl.innerHTML;
                            const toRemove = clone.querySelectorAll('.no-print, .print-only, #previewControls');
                            toRemove.forEach(n => n.remove());
                            // If clone is empty after stripping, warn and abort
                            if (!clone.innerHTML.trim()) {
                                alert('No printable content found to export.');
                                btn.disabled = false;
                                return;
                            }
                            await generatePdfFromElement(clone, 'atm-replenishment.pdf', { fitToOnePage: true });
                            btn.disabled = false;
                        });
                    }
                }
            });
            atmOutputObserver.observe(document.body, { childList: true, subtree: true });
            
            // On load, apply the 'hidden' class to sidebar on mobile screens if the initial state isn't explicitly set
            if (window.innerWidth < 768) {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) sidebar.classList.add('hidden');
            }

            // Add auto-save for editable branch info
            const branchInfo = document.getElementById('branchInfo');
            const samityInfo = document.getElementById('samityInfo');
            
            if (branchInfo) {
                branchInfo.addEventListener('blur', saveDataToLocal);
                branchInfo.addEventListener('input', function() {
                    // Debounce the save to avoid too many saves
                    clearTimeout(this.saveTimeout);
                    this.saveTimeout = setTimeout(saveDataToLocal, 1000);
                });
            }
            
            if (samityInfo) {
                samityInfo.addEventListener('blur', saveDataToLocal);
                samityInfo.addEventListener('input', function() {
                    clearTimeout(this.saveTimeout);
                    this.saveTimeout = setTimeout(saveDataToLocal, 1000);
                });
            }

            const cashCalculatorBtn = document.getElementById('cashCalculatorBtn');
            const cashFlowBtn = document.getElementById('cashFlowBtn'); // New button reference
            const atmBtn = document.getElementById('atmBtn');
            const cashReceiveBtn = document.getElementById('cashReceiveBtn');
            const vaultBtn = document.getElementById('vaultBtn');
            const electricityBtn = document.getElementById('electricityBtn');
            
            // --- Page Switching Logic ---
            if (cashCalculatorBtn) {
                cashCalculatorBtn.addEventListener('click', () => {
                    showPage('cash-calculator-page');
                });
            }
            // Add Cash Flow button listener
            if (cashFlowBtn) {
                cashFlowBtn.addEventListener('click', () => {
                    showPage('cash-flow-page');
                });
            }

            if (cashReceiveBtn) {
                cashReceiveBtn.addEventListener('click', () => {
                    showPage('cash-receive-page');
                    if (window.receive_initPage) window.receive_initPage(); 
                });
            }
            if (vaultBtn) { 
                vaultBtn.addEventListener('click', () => {
                    showPage('vault-page');
                    if (window.vault_initPage) window.vault_initPage(); 
                });
            }
            if (atmBtn) {
                atmBtn.addEventListener('click', () => {
                    showPage('atm-replenishment-page');
                    if (window.atm_calculateAllInputTotals) window.atm_calculateAllInputTotals();
                });
            }
            if (electricityBtn) {
                 electricityBtn.addEventListener('click', () => {
                    showPage('electricity-bill-page'); 
                });
            }

            // --- Load correct page on startup ---
            if (appData.currentPage) {
                 // Initialize necessary components before showing the page
                if (appData.currentPage === 'cash-receive-page' && window.receive_initPage) {
                    window.receive_initPage();
                } else if (appData.currentPage === 'vault-page' && window.vault_initPage) {
                    window.vault_initPage();
                } else if (appData.currentPage === 'cash-flow-page') {
                    cashFlowInitializeData();
                }
                showPage(appData.currentPage);
            } else {
                 showPage('cash-calculator-page');
            }

            // --- Cash Calculator Page Functionality ---

            const targetAmountInput = document.getElementById('targetAmountInput'); 
            const addReceivedBtn = document.getElementById('addReceivedBtn');
            const addPaymentBtn = document.getElementById('addPaymentBtn');
            const inHandResetBtn = document.getElementById('inHandResetBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');
            const cashPrintBtn = document.getElementById('cashPrintBtn'); // New button reference

            // Re-query for inputs inside DOMContentLoaded to ensure DOM is ready
            const calcInputs = document.querySelectorAll('.calc-input');
            const paymentInputs = document.querySelectorAll('.payment-input');
            const inHandInputs = document.querySelectorAll('.in-hand-input');
            
            // Auto-calculate difference on input change
            if (targetAmountInput) targetAmountInput.addEventListener('input', calculateDifference);

            
            if (addReceivedBtn) {
                addReceivedBtn.addEventListener('click', () => {
                    addCountsToSection(inHandInputs, calcInputs, 'calcInputs');
                });
            }

            if (addPaymentBtn) {
                addPaymentBtn.addEventListener('click', () => {
                    addCountsToSection(inHandInputs, paymentInputs, 'paymentInputs');
                });
            }
            
            if (resetAllBtn) {
                resetAllBtn.addEventListener('click', () => {
                    // Confirm before doing a destructive Reset All
                    const confirmed = confirm('Reset All will clear calculator inputs, receive data, and the Cash Flow ledger. Continue?');
                    if (!confirmed) return; 
                    // pulse the button for visual feedback
                    resetAllBtn.classList.remove('btn-pulse');
                    void resetAllBtn.offsetWidth;
                    resetAllBtn.classList.add('btn-pulse');

                    // Reset Cash Calculator related data
                    calcInputs.forEach(input => input.value = '0');
                    paymentInputs.forEach(input => input.value = '0');
                    inHandInputs.forEach(input => input.value = ''); // Reset to blank
                    if (targetAmountInput) targetAmountInput.value = '0';
                    // Reset transaction history
                    appData.transactionHistory = []; 
                    updateAndSaveCalculatorState();
                    
                    // Reset Cash Receive related data
                    const receiveInputs = document.querySelectorAll('#cash-receive-page .cash-receive-input');
                    receiveInputs.forEach(input => input.value = '');
                    receive_clearAllData(); // This handles targets/results/vault as well.
                    // ALSO clear Cash Flow ledger (clear localStorage entry and UI)
                    try {
                        // Prefer using the cashFlowSaveEntries helper to ensure any dependent updates run
                        if (typeof cashFlowSaveEntries === 'function') {
                            try { cashFlowSaveEntries([]); } catch (e) { console.warn('cashFlowSaveEntries failed during Reset All', e); }
                        } else {
                            localStorage.removeItem(CASH_FLOW_STORAGE_KEY);
                        }
                        if (typeof cashFlowRenderCashBook === 'function') cashFlowRenderCashBook([]);
                        try { if (typeof updateDifferenceLabel === 'function') updateDifferenceLabel(0); } catch(e) {}
                        try { if (typeof updateCashCalculatorCurrentBalance === 'function') updateCashCalculatorCurrentBalance(0); } catch(e) {}
                    } catch (e) {
                        console.error('Failed to clear Cash Flow during Reset All:', e);
                    }
                });
            }

            // Small click animation for primary buttons
            const addClickPressAnimation = (el) => {
                if (!el) return;
                el.addEventListener('mousedown', () => el.classList.add('btn-pressed'));
                el.addEventListener('mouseup', () => setTimeout(() => el.classList.remove('btn-pressed'), 80));
                el.addEventListener('mouseleave', () => el.classList.remove('btn-pressed'));
                // For touch devices
                el.addEventListener('touchstart', () => el.classList.add('btn-pressed'));
                el.addEventListener('touchend', () => setTimeout(() => el.classList.remove('btn-pressed'), 120));
            };

            addClickPressAnimation(addReceivedBtn);
            addClickPressAnimation(addPaymentBtn);
            addClickPressAnimation(inHandResetBtn);
            addClickPressAnimation(resetAllBtn);
            addClickPressAnimation(cashPrintBtn);

            if (inHandResetBtn) inHandResetBtn.addEventListener('click', resetInHand);
            
            if (cashPrintBtn) cashPrintBtn.addEventListener('click', () => {
                cashPrintBtn.classList.remove('btn-pulse');
                void cashPrintBtn.offsetWidth;
                cashPrintBtn.classList.add('btn-pulse');
                // small delay to show pulse before generating the print output
                setTimeout(() => window.cashCalculatorPrintReport(false, true), 160);
            });
            
            // Listener for all calculator inputs to trigger recalculation/save
            // Also guard against parent click handlers stealing focus when
            // the native number-spinner arrows are clicked by stopping
            // propagation on pointer/mouse/click events on the input itself.
            [...inHandInputs].forEach((input, index, arr) => {
                // Ensure inputs behave predictably: non-negative integers, step 1
                try { input.setAttribute('min', '0'); } catch(e){}
                try { input.setAttribute('step', '1'); } catch(e){}

                // Prevent clicks on the input (including the native spinner) from
                // bubbling to container-level handlers which might move focus.
                input.addEventListener('pointerdown', (ev) => {
                    ev.stopPropagation();
                    // record recent pointer so we can detect spinner clicks that
                    // unexpectedly move focus (some parent capture handlers may still run)
                    try { window.__lastInHandPointer = { input, y: ev.clientY, t: Date.now() }; } catch(e) {}
                });
                input.addEventListener('mousedown', (ev) => { ev.stopPropagation(); });
                // stop click bubbling but allow default action so native spinner works
                input.addEventListener('click', (ev) => { ev.stopPropagation(); });

                // When spinner is released the value may have changed; ensure we recalc/save
                input.addEventListener('pointerup', (ev) => { ev.stopPropagation(); setTimeout(updateAndSaveCalculatorState, 0); });
                input.addEventListener('mouseup', (ev) => { ev.stopPropagation(); setTimeout(updateAndSaveCalculatorState, 0); });
                // Standard input/change events
                input.addEventListener('input', updateAndSaveCalculatorState);
                input.addEventListener('change', updateAndSaveCalculatorState);

                // Keyboard handling: Enter to move next; ArrowUp/ArrowDown to step values
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextInput = arr[index + 1];
                        if (nextInput) {
                            nextInput.focus();
                        }
                        return;
                    }
                    if (e.key === 'ArrowUp' || e.key === 'Up') {
                        e.preventDefault();
                        try {
                            if (typeof input.stepUp === 'function') input.stepUp();
                            else input.value = String((parseInt(input.value) || 0) + 1);
                        } catch (err) {
                            input.value = String((parseInt(input.value) || 0) + 1);
                        }
                        updateAndSaveCalculatorState();
                    }
                    if (e.key === 'ArrowDown' || e.key === 'Down') {
                        e.preventDefault();
                        try {
                            if (typeof input.stepDown === 'function') input.stepDown();
                            else input.value = String(Math.max(0, (parseInt(input.value) || 0) - 1));
                        } catch (err) {
                            input.value = String(Math.max(0, (parseInt(input.value) || 0) - 1));
                        }
                        updateAndSaveCalculatorState();
                    }
                });

                // Mouse wheel support when focused (increment/decrement)
                input.addEventListener('wheel', (ev) => {
                    // only act when this input has focus to avoid page scroll surprises
                    if (document.activeElement !== input) return;
                    ev.preventDefault();
                    const delta = ev.deltaY < 0 ? 1 : -1;
                    const curr = parseInt(input.value) || 0;
                    const next = Math.max(0, curr + delta);
                    input.value = String(next);
                    updateAndSaveCalculatorState();
                }, { passive: false });
            });

            // Focus guard: if a pointerdown occurred on an in-hand input very recently
            // but focus moved to a different in-hand input (due to a parent capture
            // handler), assume the user clicked the native spinner and restore
            // focus to the original input while applying the appropriate step.
            document.addEventListener('focusin', (ev) => {
                try {
                    const last = window.__lastInHandPointer;
                    if (!last) return;
                    const now = Date.now();
                    if (!last.t || (now - last.t) > 400) return; // stale
                    const target = ev.target;
                    if (!target || !target.classList) return;
                    if (!target.classList.contains('in-hand-input')) return;
                    // If focus moved to a different input than the one that received the pointer
                    if (target === last.input) return;

                    const rect = last.input.getBoundingClientRect();
                    const clickedAboveCenter = last.y < (rect.top + rect.height/2);
                    // Apply step on the original input
                    if (clickedAboveCenter) {
                        try { if (typeof last.input.stepUp === 'function') last.input.stepUp(); else last.input.value = String((parseInt(last.input.value)||0)+1); } catch(e) { last.input.value = String((parseInt(last.input.value)||0)+1); }
                    } else {
                        try { if (typeof last.input.stepDown === 'function') last.input.stepDown(); else last.input.value = String(Math.max(0,(parseInt(last.input.value)||0)-1)); } catch(e) { last.input.value = String(Math.max(0,(parseInt(last.input.value)||0)-1)); }
                    }
                    updateAndSaveCalculatorState();
                    // Return focus to the original input (tiny delay to avoid focus thrash)
                    setTimeout(() => { try { last.input.focus(); } catch(e){} }, 0);
                    // clear last pointer so we don't re-run
                    window.__lastInHandPointer = null;
                } catch (e) {
                    // swallow errors
                }
            });

            // --- Open-in-Window Calculator support ---
            (function initCalcWindow() {
                const openBtn = document.getElementById('openCalcWindowBtn');
                let calcWindow = null;

                function buildPopupHTML() {
                    // Popup HTML with denomination inputs. It will send messages to opener (main window)
                    const denoms = [1000,500,200,100,50,20,10,5,2,1];
                    const rows = denoms.map(d => `
                        <div class="denom-row">
                            <div class="denom-label">${d} x</div>
                            <input data-denomination="${d}" class="denom-input" type="number" min="0" value="" />
                            <div class="denom-sub"></div>
                        </div>
                    `).join('');

                    return `<!doctype html>
                    <html>
                    <head>
                        <meta charset="utf-8">
                        <title>Calculator</title>
                        <meta name="viewport" content="width=device-width,initial-scale=1" />
                        <style>
                            :root { --bg: #f3f4f6; --card:#ffffff; --muted:#6b7280; --accent:#2563EB; }
                            html,body { height:100%; margin:0; font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: var(--card); overflow: hidden; }
                            /* remove outer gaps: full-bleed card, make non-scrollable */
                            .wrap { display:block; height:100vh; padding:0; box-sizing:border-box; overflow: hidden; }
                            /* Backdrop and card entrance */
                            html,body { height:100%; margin:0; }
                            .backdrop { position:fixed; inset:0; background: rgba(11,14,20,0.12); display:flex; align-items:flex-start; justify-content:center; padding-top:28px; }
                            /* Slim card layout for popup windows */
                            .card { width:100%; max-width:380px; height:100vh; max-height:640px; background:var(--card); border-radius:12px; box-shadow: 0 18px 50px rgba(2,6,23,0.35); overflow: hidden; transform: translateY(18px) scale(0.995); opacity:0; animation: cardIn 420ms cubic-bezier(.2,.9,.2,1) forwards; }
                            .card-header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; background:linear-gradient(90deg,#eef2ff, #ffffff); }
                            .card-title { font-weight:700; color:#0b2545; }
                            .card-body { padding:10px; height: auto; box-sizing: border-box; overflow: visible; }
                            .total { font-size:20px; font-weight:800; color:var(--accent); margin-bottom:10px; transition: transform 280ms ease; display:inline-block; }
                            .total.total-pulse { animation: totalPulse 0.42s cubic-bezier(.2,.9,.2,1); }
                            .total .count { display:inline-block; min-width:72px; text-align:right; }
                            .denom-list { max-height: none; overflow: visible; margin-bottom:12px; padding-right:6px; }
                            /* Per-row entrance (staggered) */
                            .denom-row { display:flex; align-items:center; gap:10px; margin-bottom:8px; transition: background 320ms ease, transform 360ms cubic-bezier(.2,.9,.2,1), opacity 320ms ease; transform: translateY(8px); opacity:0; }
                            .denom-row.row-visible { transform: translateY(0); opacity:1; }
                            .denom-row.row-flash { animation: rowFlash 0.44s cubic-bezier(.2,.9,.2,1); background: linear-gradient(90deg, rgba(99,102,241,0.10), rgba(99,102,241,0.02)); }
                            .denom-row.row-flash { animation: rowFlash 0.44s cubic-bezier(.2,.9,.2,1); background: linear-gradient(90deg, rgba(99,102,241,0.10), rgba(99,102,241,0.02)); }
                            @keyframes totalPulse { 0% { transform: scale(1); } 40% { transform: scale(1.12); } 100% { transform: scale(1); } }
                            @keyframes rowFlash { 0% { background: rgba(99,102,241,0.22); } 60% { background: rgba(99,102,241,0.10); } 100% { background: transparent; } }
                            @keyframes cardIn { from { transform: translateY(18px) scale(0.995); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
                            /* Backdrop fade for first paint */
                            @keyframes backdropFade { from { background: rgba(11,14,20,0); } to { background: rgba(11,14,20,0.12); } }
                            @keyframes totalPulse { 0% { transform: scale(1); } 40% { transform: scale(1.09); } 100% { transform: scale(1); } }
                            @keyframes rowFlash { 0% { background: rgba(99,102,241,0.18); } 60% { background: rgba(99,102,241,0.08); } 100% { background: transparent; } }

                            @keyframes cardIn { from { transform: translateY(8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                            @keyframes pulseFlash { 0% { transform: scale(1); } 50% { transform: scale(1.06); } 100% { transform: scale(1); } }
                            .denom-label { width:70px; text-align:right; font-weight:700; color:var(--muted); }
                            .denom-input { width:84px; padding:8px 10px; border-radius:10px; border:1px solid #e6e9ef; text-align:right; font-weight:600; background:#fafafa; }
                            .denom-input:focus { box-shadow: 0 6px 20px rgba(37,99,235,0.12); transform: translateY(-2px); }
                            /* Popup button animation utilities */
                            .btn { position: relative; overflow: hidden; will-change: transform; transition: transform 180ms cubic-bezier(.2,.9,.2,1), box-shadow 180ms ease; }
                            .btn:hover { transform: translateY(-3px) scale(1.02); }
                            .btn:active { transform: translateY(0) scale(0.98); }
                            .btn .ripple { position: absolute; border-radius: 50%; pointer-events: none; transform: scale(0); background: rgba(255,255,255,0.6); opacity: 0.95; }
                            @keyframes rippleAnim { 0% { transform: scale(0); opacity: 0.9; } 60% { transform: scale(1.8); opacity: 0.6; } 100% { transform: scale(2.6); opacity: 0; } }
                            .btn-ripple-play { animation: rippleAnim 560ms cubic-bezier(.2,.9,.2,1) forwards; }
                            .btn-pulse { animation: pulseFlash 520ms cubic-bezier(.2,.9,.2,1) forwards; }
                            .denom-sub { width:90px; text-align:right; font-weight:700; color:#111827; }
                            .card-footer { display:flex; gap:10px; padding:8px 10px; background:transparent; justify-content:flex-end; position: static; margin-top:8px; }
                            .btn { padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:700; }
                            .btn-recv { background: linear-gradient(180deg,#10B981,#059669); color:#fff; box-shadow: 0 8px 24px rgba(16,185,129,0.12); }
                            .btn-pay { background: linear-gradient(180deg,#ef4444,#dc2626); color:#fff; box-shadow: 0 8px 24px rgba(239,68,68,0.12); }
                            .close-btn { background:transparent; border:none; font-size:16px; cursor:pointer; color:var(--muted); }
                            @media (max-width:420px){ .card{ width:100%; max-width:360px; border-radius:8px; } .denom-label{width:60px;} }
                            /* Respect reduced motion */
                            @media (prefers-reduced-motion: reduce) {
                                .denom-row, .card { transition: none !important; animation: none !important; }
                            }
                        </style>
                    </head>
                        <body>
                        <div class="backdrop" role="presentation">
                          <div class="card" role="dialog" aria-modal="true">
                                                        <div class="card-body">
                                <div class="total">Total: <span id="popupTotal"></span></div>
                                <div class="denom-list">
                                    ${rows}
                                </div>
                                <div class="card-footer">
                                    <button id="popupReceived" class="btn btn-recv">Received</button>
                                    <button id="popupPayment" class="btn btn-pay">Payment</button>
                                </div>
                            </div>
                          </div>
                        </div>
                        <script>
                            // small numeric count-up helper (animates text content from a -> b)
                            function countUp(el, start, end, duration = 420) {
                                if (!el) return;
                                start = Number(start) || 0; end = Number(end) || 0;
                                if (start === end) { el.textContent = end ? Number(end).toLocaleString() : ''; return; }
                                const startTs = performance.now();
                                const step = (now) => {
                                    const t = Math.min(1, (now - startTs) / duration);
                                    const eased = (1 - Math.cos(t * Math.PI)) / 2; // easeInOut
                                    const val = Math.round(start + (end - start) * eased);
                                    el.textContent = val ? Number(val).toLocaleString() : '';
                                    if (t < 1) requestAnimationFrame(step);
                                };
                                requestAnimationFrame(step);
                            }

                            // when popup loads, stagger-in the rows for nicer entrance
                            function revealRowsStagger() {
                                const rows = Array.from(document.querySelectorAll('.denom-row'));
                                rows.forEach((r, i) => {
                                    setTimeout(() => r.classList.add('row-visible'), 50 + i * 36);
                                });
                            }

                            // Attach ripple and pulse effects to popup buttons
                            function attachButtonEffects() {
                                const buttons = Array.from(document.querySelectorAll('.btn'));
                                buttons.forEach(btn => {
                                    btn.addEventListener('click', (ev) => {
                                        const rect = btn.getBoundingClientRect();
                                        const size = Math.max(rect.width, rect.height) * 1.2;
                                        const ripple = document.createElement('span');
                                        ripple.className = 'ripple';
                                        ripple.style.width = ripple.style.height = size + 'px';
                                        ripple.style.left = (ev.clientX - rect.left - size/2) + 'px';
                                        ripple.style.top = (ev.clientY - rect.top - size/2) + 'px';
                                        btn.appendChild(ripple);
                                        // force reflow then play
                                        void ripple.offsetWidth;
                                        ripple.classList.add('btn-ripple-play');
                                        // small pulse for the button
                                        btn.classList.remove('btn-pulse');
                                        void btn.offsetWidth;
                                        btn.classList.add('btn-pulse');
                                        // cleanup ripple after animation
                                        setTimeout(() => { try { btn.removeChild(ripple); } catch(e) {} }, 700);
                                    });
                                });
                            }
                            function sendToOpener(type, payload) {
                                if (window.opener && !window.opener.closed) {
                                    window.opener.postMessage({ from: 'calcPopup', type: type, payload: payload }, '*');
                                }
                            }

                            function gatherDenominations() {
                                const inputs = Array.from(document.querySelectorAll('.denom-input'));
                                const denoms = {};
                                inputs.forEach(i => {
                                    const d = i.dataset.denomination;
                                    const v = parseInt(i.value) || 0;
                                    denoms[d] = v;
                                });
                                return denoms;
                            }

                            function formatNumber(n) { try { return Number(n).toLocaleString(); } catch (e) { return String(n); } }

                            function recomputeAll() {
                                const inputs = Array.from(document.querySelectorAll('.denom-input'));
                                let total = 0;
                                const out = document.getElementById('popupTotal');
                                let prevTotal = out && out.textContent ? out.textContent.replace(/[,\s]/g,'') : '';
                                inputs.forEach(i => {
                                    const d = parseInt(i.dataset.denomination, 10) || 0;
                                    // treat blank as zero
                                    const v = (i.value === '' ? 0 : (parseInt(i.value, 10) || 0));
                                    const sub = d * v;
                                    const subEl = i.parentNode.querySelector('.denom-sub');
                                    const prev = subEl && subEl.textContent ? subEl.textContent.replace(/[,\s]/g,'') : '';
                                    if (subEl) {
                                        if ((sub > 0 ? String(sub) : '') !== prev) {
                                            subEl.textContent = sub > 0 ? formatNumber(sub) : '';
                                            // subtle flash for the row when subtotal changes
                                            i.parentNode.classList.remove('row-flash');
                                            void i.parentNode.offsetWidth;
                                            i.parentNode.classList.add('row-flash');
                                            setTimeout(() => i.parentNode.classList.remove('row-flash'), 540);
                                        }
                                    }
                                    total += sub;
                                });
                                if (out) {
                                    const formatted = total > 0 ? formatNumber(total) : '';
                                    const numericPrev = parseInt(prevTotal||0,10) || 0;
                                    if (String(formatted) !== (out.textContent||'')) {
                                        // animate numeric count-up
                                        countUp(out, numericPrev, total, 480);
                                        // pulse the total for emphasis
                                        out.classList.remove('total-pulse');
                                        void out.offsetWidth;
                                        out.classList.add('total-pulse');
                                        setTimeout(() => out.classList.remove('total-pulse'), 520);
                                    }
                                }
                                return total;
                            }

                            // wire inputs
                            document.addEventListener('input', (ev) => {
                                if (ev.target && ev.target.classList && ev.target.classList.contains('denom-input')) {
                                    recomputeAll();
                                }
                            });

                            // Enter key: move to next denom input and select value
                            document.addEventListener('keydown', (ev) => {
                                const target = ev.target;
                                if (!target || !target.classList) return;
                                if (!target.classList.contains('denom-input')) return;
                                if (ev.key === 'Enter') {
                                    ev.preventDefault();
                                    const inputs = Array.from(document.querySelectorAll('.denom-input'));
                                    const idx = inputs.indexOf(target);
                                    const next = inputs[idx + 1];
                                    if (next) {
                                        next.focus();
                                        // select current value to allow replacing quickly
                                        try { next.select(); } catch (e) {}
                                    }
                                }
                            });

                            // Update displayed total when main sends it (optional fallback)
                            window.addEventListener('message', (ev) => {
                                try {
                                    const msg = ev.data || {};
                                    if (msg && msg.from === 'main' && msg.type === 'updateTotal') {
                                        // don't override local computed total — only use if local total is zero
                                        const localTotal = parseInt((document.getElementById('popupTotal')||{}).textContent.replace(/[,\s]/g,'')) || 0;
                                        if (!localTotal) {
                                            const el = document.getElementById('popupTotal');
                                            if (el) el.textContent = msg.payload || '0';
                                        }
                                    }
                                } catch (e) { /* ignore */ }
                            });

                            // attach click handlers that submit denominations
                            const totalEl = () => document.getElementById('popupTotal');
                            let lastTotal = 0;

                            function animateRow(row) {
                                if (!row) return;
                                row.classList.remove('row-flash');
                                void row.offsetWidth;
                                row.classList.add('row-flash');
                                setTimeout(() => row.classList.remove('row-flash'), 420);
                            }

                            function animateTotalPulse() {
                                const el = totalEl();
                                if (!el) return;
                                el.classList.remove('total-pulse');
                                void el.offsetWidth;
                                el.classList.add('total-pulse');
                                setTimeout(() => el.classList.remove('total-pulse'), 420);
                            }

                            document.getElementById('popupReceived').addEventListener('click', async () => {
                                const denoms = gatherDenominations();
                                const total = recomputeAll();
                                // attempt to copy popup total locally for immediate feedback
                                try {
                                    if (navigator.clipboard && navigator.clipboard.writeText) {
                                        await navigator.clipboard.writeText(String(total));
                                    } else {
                                        const ta = document.createElement('textarea');
                                        ta.value = String(total);
                                        ta.style.position = 'fixed'; ta.style.opacity = '0';
                                        document.body.appendChild(ta); ta.select();
                                        document.execCommand('copy');
                                        document.body.removeChild(ta);
                                    }
                                } catch (e) {
                                    // ignore
                                }
                                sendToOpener('submitDenoms', { action: 'received', denominations: denoms, total: total });
                                // clear popup inputs and subtotals
                                Array.from(document.querySelectorAll('.denom-input')).forEach(i => i.value = '');
                                Array.from(document.querySelectorAll('.denom-sub')).forEach(s => s.textContent = '');
                                const out = document.getElementById('popupTotal'); if (out) out.textContent = '';
                            });
                            document.getElementById('popupPayment').addEventListener('click', async () => {
                                const denoms = gatherDenominations();
                                const total = recomputeAll();
                                try {
                                    if (navigator.clipboard && navigator.clipboard.writeText) {
                                        await navigator.clipboard.writeText(String(total));
                                    } else {
                                        const ta = document.createElement('textarea');
                                        ta.value = String(total);
                                        ta.style.position = 'fixed'; ta.style.opacity = '0';
                                        document.body.appendChild(ta); ta.select();
                                        document.execCommand('copy');
                                        document.body.removeChild(ta);
                                    }
                                } catch (e) {
                                    // ignore
                                }
                                sendToOpener('submitDenoms', { action: 'payment', denominations: denoms, total: total });
                                // clear popup inputs and subtotals
                                Array.from(document.querySelectorAll('.denom-input')).forEach(i => i.value = '');
                                Array.from(document.querySelectorAll('.denom-sub')).forEach(s => s.textContent = '');
                                const out = document.getElementById('popupTotal'); if (out) out.textContent = '';
                            });

                            // initialize subtotals and total, then reveal rows with stagger
                            window.addEventListener('DOMContentLoaded', () => { recomputeAll(); revealRowsStagger(); attachButtonEffects(); });
                            // also run once now since DOM is written
                            setTimeout(() => { recomputeAll(); revealRowsStagger(); }, 90);

                            // Request initial total from opener (optional)
                            sendToOpener('requestTotal', {});
                        <\/script>
                    </body>
                    </html>`;
                }

                // Listen for messages from popup
                window.addEventListener('message', (ev) => {
                    const msg = ev.data || {};
                    if (msg && msg.from === 'calcPopup') {
                        if (msg.type === 'submitDenoms' && msg.payload) {
                            try {
                                const action = msg.payload.action; // 'received' or 'payment'
                                const denoms = msg.payload.denominations || {};
                                // Apply denominations to in-hand inputs
                                inHandInputs.forEach(input => {
                                    const d = input.dataset.denomination;
                                    if (denoms.hasOwnProperty(d)) {
                                        input.value = parseInt(denoms[d]) || 0;
                                    }
                                });

                                // Trigger the appropriate addCountsToSection
                                if (action === 'received') {
                                    addCountsToSection(inHandInputs, calcInputs, 'calcInputs');
                                } else if (action === 'payment') {
                                    addCountsToSection(inHandInputs, paymentInputs, 'paymentInputs');
                                }

                                // Copy the popup's computed total if provided; otherwise main routine already copies its own total
                                const popupTotal = (msg.payload && (msg.payload.total || msg.payload.total === 0)) ? String(msg.payload.total) : null;
                                if (popupTotal !== null) {
                                    // copy the exact popup total to clipboard
                                    copyTextToClipboard(popupTotal);
                                }
                            } catch (e) {
                                console.warn('Failed to process submitDenoms', e);
                            }
                        } else if (msg.type === 'received') {
                            // trigger same action as addReceivedBtn
                            if (addReceivedBtn) addReceivedBtn.click();
                        } else if (msg.type === 'payment') {
                            if (addPaymentBtn) addPaymentBtn.click();
                        } else if (msg.type === 'copy') {
                            // copy current total to clipboard; allow popup to supply a computed total via payload
                            const totalFromPopup = msg.payload && (msg.payload.total || msg.payload.total === 0) ? String(msg.payload.total) : null;
                            const total = totalFromPopup !== null ? totalFromPopup : (document.getElementById('inHandCalcTotal')?.textContent || '');
                            copyTextToClipboard(total);
                        } else if (msg.type === 'requestTotal') {
                            // send current total to popup
                            const total = document.getElementById('inHandCalcTotal')?.textContent || '0';
                            if (calcWindow && !calcWindow.closed) {
                                calcWindow.postMessage({ from: 'main', type: 'updateTotal', payload: total }, '*');
                            }
                        }
                    }
                });

                if (!openBtn) return;

                openBtn.addEventListener('click', () => {
                    // If already open, focus and update total
                    if (calcWindow && !calcWindow.closed) {
                        calcWindow.focus();
                        const total = document.getElementById('inHandCalcTotal')?.textContent || '0';
                        calcWindow.postMessage({ from: 'main', type: 'updateTotal', payload: total }, '*');
                        return;
                    }

                    // Open window with about:blank then write content (works better for local files)
                    // Open a slimmer popup window by default
                    calcWindow = window.open('', '_blank', 'width=320,height=640,resizable=yes');
                    if (!calcWindow) {
                        alert('Popup blocked: allow popups for this site to use Open in Window');
                        return;
                    }

                    // Write popup HTML
                    calcWindow.document.open();
                    calcWindow.document.write(buildPopupHTML());
                    calcWindow.document.close();

                    // After a short delay, send current total
                    setTimeout(() => {
                        const total = document.getElementById('inHandCalcTotal')?.textContent || '0';
                        try { calcWindow.postMessage({ from: 'main', type: 'updateTotal', payload: total }, '*'); } catch (e) {}
                    }, 150);

                    // Clean up reference when closed
                    const interval = setInterval(() => {
                        if (!calcWindow || calcWindow.closed) {
                            clearInterval(interval);
                            calcWindow = null;
                        }
                    }, 500);
                });
            })();
            
            // --- ATM Event Listeners ---
            const atmInputPage = document.getElementById('atm-input-page');
            
            if (atmInputPage) {
                atmInputPage.addEventListener('focusin', (event) => {
                    if (event.target.tagName === 'INPUT') {
                        event.target.select();
                    }
                });
                
                atmInputPage.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' && event.target.tagName === 'INPUT') {
                        event.preventDefault(); 

                        const inputs = Array.from(
                            atmInputPage.querySelectorAll('input[type="text"], input[type="number"], input[type="date"], input[type="time"]')
                        ).filter(input => !input.disabled);
                        
                        const currentIndex = inputs.indexOf(event.target);
                        const nextIndex = currentIndex + 1;

                        if (nextIndex < inputs.length) {
                            inputs[nextIndex].focus();
                        }
                    }
                });

                atmInputPage.addEventListener('input', window.atm_calculateAllInputTotals);
                
                const generateReportBtn = document.getElementById('generate-report-btn');
                if (generateReportBtn) {
                    generateReportBtn.addEventListener('click', () => {
                        // Populate ATM output and print immediately (no preview)
                        // atm_populateOutputPage will prepare the output and trigger printing directly.
                        window.atm_populateOutputPage();
                    });
                }
            }
            
        });
    </script>
</body>

<!-- Calculation popup removed -->
</html>    </script>
</body>

<!-- Calculation popup removed -->
</html></html>